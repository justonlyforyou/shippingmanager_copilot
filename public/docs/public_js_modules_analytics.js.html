<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/analytics.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Ultra-thin scrollbar with gradient - all webkit browsers */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #60a5fa 0%, #a78bfa 100%);
            border-radius: 2px;
            border: 1px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #93c5fd 0%, #c4b5fd 100%);
        }

        ::-webkit-scrollbar-corner {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-button {
            display: none;
            width: 0;
            height: 0;
        }

        /* Specific elements scrollbars */
        body::-webkit-scrollbar,
        nav::-webkit-scrollbar,
        #main::-webkit-scrollbar,
        .container-overview::-webkit-scrollbar,
        pre::-webkit-scrollbar {
            width: 5px;
            height: 5px;
            background: #1a1a1a;
        }

        body::-webkit-scrollbar-thumb,
        nav::-webkit-scrollbar-thumb,
        #main::-webkit-scrollbar-thumb,
        .container-overview::-webkit-scrollbar-thumb,
        pre::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #60a5fa 0%, #a78bfa 100%);
            border-radius: 2px;
            border: 1px solid #1a1a1a;
        }

        body::-webkit-scrollbar-thumb:hover,
        nav::-webkit-scrollbar-thumb:hover,
        #main::-webkit-scrollbar-thumb:hover,
        .container-overview::-webkit-scrollbar-thumb:hover,
        pre::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #93c5fd 0%, #c4b5fd 100%);
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }

        /* Nav scrollbar - explicit override */
        nav::-webkit-scrollbar {
            width: 5px !important;
            height: 5px !important;
            background: #242424 !important;
        }

        nav::-webkit-scrollbar-track {
            background: #242424 !important;
        }

        nav::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #60a5fa 0%, #a78bfa 100%) !important;
            border-radius: 2px !important;
        }

        nav::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #93c5fd 0%, #c4b5fd 100%) !important;
        }

        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }

        nav h3 {
            font-size: 13px !important;
        }

        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }

        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }

        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }

        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }

        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }

        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }

        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }

        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }

        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }

        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }

        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }

        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }

        pre code {
            background-color: transparent !important;
        }

        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }

        table thead tr {
            background-color: #242424 !important;
        }

        table tbody tr {
            background-color: #1a1a1a !important;
        }

        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }

        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h3>Home</h3><ul><li><a href="index.html">README</a></li></ul><h3>ShippingManager</h3><ul><li><a href="tutorial-03-discovered-formulars.html">Discovered Formulas</a></li><li><a href="https://shippingmanager-api-reference.pages.dev/" target="_blank" rel="noopener noreferrer">API Reference &#8599;</a></li></ul><h3>COPILOT Tutorials</h3><ul><li><a href="tutorial-01-installation-guide.html">Installation</a></li><li><a href="tutorial-02-build-guide.html">Build Guide</a></li><li><a href="tutorial-04-cheatsheet.html">Cheat-Sheet</a></li><li><a href="tutorial-05-beginners-guide.html">Beginners Guide</a></li></ul><h3>COPILOT DOCUMENTATION</h3><ul><li class="nav-list-toggle"><a>Classes</a><ul style="display: none;"><li><a href="module-core_debounced-api.DebouncedAPIManager.html">DebouncedAPIManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_debounced-api.DebouncedAPIManager.html#call">call</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.DebouncedAPIManager.html#cancelAll">cancelAll</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.DebouncedAPIManager.html#get">get</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.DebouncedAPIManager.html#register">register</a></li></ul></li><li><a href="module-server_chatbot-ChatBot.html">ChatBot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot-ChatBot.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot-ChatBot.html#processAllianceMessage">processAllianceMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot-ChatBot.html#processPrivateMessage">processPrivateMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot-ChatBot.html#setupScheduledTasks">setupScheduledTasks</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot-ChatBot.html#updateSettings">updateSettings</a></li></ul></li></ul></li><li class="nav-list-toggle"><a>Modules</a><ul style="display: none;"><li><a href="module-alliance-tabs.html">alliance-tabs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.clearAllianceTabCache">clearAllianceTabCache</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.closeAllianceCoopOverlay">closeAllianceCoopOverlay</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.getCurrentTab">getCurrentTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.hideAllAllianceUI">hideAllAllianceUI</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.initAllianceTabs">initAllianceTabs</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.refreshCurrentTab">refreshCurrentTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.showAllAllianceUI">showAllAllianceUI</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.showAllianceCoopOverlay">showAllianceCoopOverlay</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.showAllianceDetailsModal">showAllianceDetailsModal</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.switchTab">switchTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#.updateCoopTabBadge">updateCoopTabBadge</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~acceptUserToAlliance">acceptUserToAlliance</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~appendSearchResults">appendSearchResults</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~attachAllianceClickHandlers">attachAllianceClickHandlers</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~attachApplicationButtonListeners">attachApplicationButtonListeners</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~attachSearchEventListeners">attachSearchEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~createAllianceRow">createAllianceRow</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~declineUserFromAlliance">declineUserFromAlliance</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchAllianceInfo">fetchAllianceInfo</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchAllianceInfoById">fetchAllianceInfoById</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchAllianceMembersById">fetchAllianceMembersById</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchAllianceSettings">fetchAllianceSettings</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchHighScores">fetchHighScores</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchLeagueInfo">fetchLeagueInfo</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~fetchQueuePool">fetchQueuePool</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~generateAllianceInfoHTML">generateAllianceInfoHTML</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~handleJoinAllianceClick">handleJoinAllianceClick</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~leaveAlliance">leaveAlliance</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~loadTabContent">loadTabContent</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~loadWelcomeMessage">loadWelcomeMessage</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~normalizeColor">normalizeColor</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~performSearch">performSearch</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~refreshApplicationsQueue">refreshApplicationsQueue</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderAllianzTab">renderAllianzTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderCoopTab">renderCoopTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderHighScoreTab">renderHighScoreTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderLigaTab">renderLigaTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderManagementTab">renderManagementTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderMemberCard">renderMemberCard</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderSearchTab">renderSearchTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~renderSettingsTab">renderSettingsTab</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~saveWelcomeMessage">saveWelcomeMessage</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~sendWelcomeMessageToUser">sendWelcomeMessageToUser</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~showDonateDialog">showDonateDialog</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~showTextInputDialog">showTextInputDialog</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateAllianceSettings">updateAllianceSettings</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateManagementTabVisibility">updateManagementTabVisibility</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateTabVisibilityForAllianceMembers">updateTabVisibilityForAllianceMembers</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateTabVisibilityForNonMembers">updateTabVisibilityForNonMembers</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateUserRole">updateUserRole</a></li><li data-type='method' style='display: none;'><a href="module-alliance-tabs.html#~updateWelcomeMessageCharCount">updateWelcomeMessageCharCount</a></li></ul></li><li><a href="module-analytics.html">analytics</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-analytics.html#.initAnalytics">initAnalytics</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~addApiStatsTab">addApiStatsTab</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~buildPod2Html">buildPod2Html</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~checkAndBuildIndex">checkAndBuildIndex</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~clearPortDemandChart">clearPortDemandChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~closeSoldVesselPanel">closeSoldVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~destroyChart">destroyChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~exportAnalyticsData">exportAnalyticsData</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~formatChartPrice">formatChartPrice</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~formatCurrency">formatCurrency</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~formatPercent">formatPercent</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~getPortDemandChartOptions">getPortDemandChartOptions</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~handleRawTransactionSort">handleRawTransactionSort</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~handleRouteClick">handleRouteClick</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~handleSort">handleSort</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~handleVesselClick">handleVesselClick</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~initSortableHeaders">initSortableHeaders</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~isCacheValid">isCacheValid</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~lazyLoadPorts">lazyLoadPorts</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~lazyLoadRoutes">lazyLoadRoutes</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~lazyLoadVessels">lazyLoadVessels</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadAnalyticsData">loadAnalyticsData</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadApiStats">loadApiStats</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadGameLogData">loadGameLogData</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadMoreRawTransactions">loadMoreRawTransactions</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadPortDemandChart">loadPortDemandChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~loadRawTransactions">loadRawTransactions</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~populatePortDropdown">populatePortDropdown</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~populateTypeFilter">populateTypeFilter</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~preloadAllTabs">preloadAllTabs</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderApiStatsChart">renderApiStatsChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderApiStatsSummary">renderApiStatsSummary</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderApiStatsTable">renderApiStatsTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderBBLChart">renderBBLChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderBottomVesselsRevenueChart">renderBottomVesselsRevenueChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderExpenseTable">renderExpenseTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderGameLogChart">renderGameLogChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderGameLogDailyTable">renderGameLogDailyTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderGameLogInfo">renderGameLogInfo</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderGameLogTable">renderGameLogTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderPortDemandCharts">renderPortDemandCharts</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderQuickSummary">renderQuickSummary</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderRawTransactionsTable">renderRawTransactionsTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderRouteTable">renderRouteTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderSoldVesselHistory">renderSoldVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderSummary">renderSummary</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderTEUChart">renderTEUChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderTop10Routes">renderTop10Routes</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderTrendChart">renderTrendChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderVesselCharts">renderVesselCharts</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderVesselTable">renderVesselTable</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderVesselsCompositionChart">renderVesselsCompositionChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderVesselsRevenueChart">renderVesselsRevenueChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~renderVesselsUtilizationChart">renderVesselsUtilizationChart</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~setupApiStatsControls">setupApiStatsControls</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~setupRawTransactionsLazyLoading">setupRawTransactionsLazyLoading</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~showLookupEntryDetails">showLookupEntryDetails</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~showRouteVesselsInfoTooltip">showRouteVesselsInfoTooltip</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~showSoldVesselPanel">showSoldVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~sortData">sortData</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~switchTab">switchTab</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateFilterName">updateFilterName</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateLoadMoreButton">updateLoadMoreButton</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updatePortDemandStatus">updatePortDemandStatus</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updatePortVesselMetrics">updatePortVesselMetrics</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateRawSortIndicators">updateRawSortIndicators</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateRawTransactionCounts">updateRawTransactionCounts</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateRouteFilterIcons">updateRouteFilterIcons</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateSortIndicators">updateSortIndicators</a></li><li data-type='method' style='display: none;'><a href="module-analytics.html#~updateVesselFilterIcons">updateVesselFilterIcons</a></li></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.buildLookup">buildLookup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.checkCompanyAge">checkCompanyAge</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.checkDevelMode">checkDevelMode</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.clearLookup">clearLookup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.deleteAllLogs">deleteAllLogs</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.departVessels">departVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.downloadLogbookExport">downloadLogbookExport</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchLogbookEntries">fetchLogbookEntries</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchLogbookFileSize">fetchLogbookFileSize</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchUserCompany">fetchUserCompany</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsAll">getAnalyticsAll</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsOverview">getAnalyticsOverview</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsRoutes">getAnalyticsRoutes</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsSummary">getAnalyticsSummary</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsTrend">getAnalyticsTrend</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getAnalyticsVessels">getAnalyticsVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getApiStats">getApiStats</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getApiStatsDates">getApiStatsDates</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getApiStatsHourly">getApiStatsHourly</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupAll">getLookupAll</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupBreakdown">getLookupBreakdown</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupBuildStatus">getLookupBuildStatus</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupDaily">getLookupDaily</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupDetails">getLookupDetails</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupEntries">getLookupEntries</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupInfo">getLookupInfo</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getLookupTotals">getLookupTotals</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getPortDemandHistory">getPortDemandHistory</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getPortDemandLatest">getPortDemandLatest</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getPortDemandStatus">getPortDemandStatus</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getPortDemandTrends">getPortDemandTrends</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getRecentIpos">getRecentIpos</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getRouteVessels">getRouteVessels</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getStockFinanceOverview">getStockFinanceOverview</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getStockMarket">getStockMarket</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getStockPurchaseTimes">getStockPurchaseTimes</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionDaily">getTransactionDaily</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionData">getTransactionData</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionInfo">getTransactionInfo</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionList">getTransactionList</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionSummary">getTransactionSummary</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTransactionTypes">getTransactionTypes</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.increaseStockForSale">increaseStockForSale</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.markChatAsRead">markChatAsRead</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.purchaseStock">purchaseStock</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.rebuildLookup">rebuildLookup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.searchUsers">searchUsers</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sellStock">sellStock</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.syncTransactions">syncTransactions</a></li><li data-type='method' style='display: none;'><a href="module-api.html#~verifyVesselPurchased">verifyVesselPurchased</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method' style='display: none;'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-badge-manager.html">badge-manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.getBadgeCount">getBadgeCount</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.hideBadge">hideBadge</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.showBadge">showBadge</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.updateBadge">updateBadge</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.updateButtonState">updateButtonState</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.updateButtonTooltip">updateButtonTooltip</a></li><li data-type='method' style='display: none;'><a href="module-badge-manager.html#.updateButtonVisibility">updateButtonVisibility</a></li></ul></li><li><a href="module-broadcast.html">broadcast</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-broadcast.html#.initBroadcast">initBroadcast</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#.initBroadcastForManagement">initBroadcastForManagement</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~deleteTemplate">deleteTemplate</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~editTemplate">editTemplate</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~loadTemplates">loadTemplates</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~renderTemplateList">renderTemplateList</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~saveTemplate">saveTemplate</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~toggleTemplate">toggleTemplate</a></li><li data-type='method' style='display: none;'><a href="module-broadcast.html#~updateMessageCounter">updateMessageCounter</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.setCapacityFromBunkerUpdate">setCapacityFromBunkerUpdate</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method' style='display: none;'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-changelog-popup.html">changelog-popup</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-changelog-popup.html#.checkAndShowChangelog">checkAndShowChangelog</a></li><li data-type='method' style='display: none;'><a href="module-changelog-popup.html#.handleChangelogAcknowledged">handleChangelogAcknowledged</a></li><li data-type='method' style='display: none;'><a href="module-changelog-popup.html#.initChangelogPopup">initChangelogPopup</a></li><li data-type='method' style='display: none;'><a href="module-changelog-popup.html#~closeChangelogPopup">closeChangelogPopup</a></li><li data-type='method' style='display: none;'><a href="module-changelog-popup.html#~showChangelogPopup">showChangelogPopup</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.markAllianceChatAsRead">markAllianceChatAsRead</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~attemptReconnect">attemptReconnect</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~displaySuggestions">displaySuggestions</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~formatLocalTime">formatLocalTime</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleAllianceChanged">handleAllianceChanged</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleAllianceIndexReady">handleAllianceIndexReady</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleAutoCoopComplete">handleAutoCoopComplete</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleAutoCoopNoTargets">handleAutoCoopNoTargets</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleAutopilotDepartStart">handleAutopilotDepartStart</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleBunkerUpdate">handleBunkerUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleCO2Purchased">handleCO2Purchased</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleCampaignsRenewed">handleCampaignsRenewed</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleCompanyTypeUpdate">handleCompanyTypeUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleCoopUpdate">handleCoopUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleDesktopNotification">handleDesktopNotification</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleDrydockCountUpdate">handleDrydockCountUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleFuelPurchased">handleFuelPurchased</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleGenericNotification">handleGenericNotification</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleHarborMapRefreshRequired">handleHarborMapRefreshRequired</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleHeaderDataUpdate">handleHeaderDataUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleHijackingUpdate">handleHijackingUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleIpoAlertUpdate">handleIpoAlertUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleMentionAutocomplete">handleMentionAutocomplete</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleMessengerUpdate">handleMessengerUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handlePriceAlert">handlePriceAlert</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handlePriceUpdate">handlePriceUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handlePurserPurchase">handlePurserPurchase</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handlePurserSell">handlePurserSell</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleRepairCountUpdate">handleRepairCountUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleStaffTrainingPointsUpdate">handleStaffTrainingPointsUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleStaffUpdate">handleStaffUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleUnreadMessagesUpdate">handleUnreadMessagesUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleUserActionNotification">handleUserActionNotification</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselCountUpdate">handleVesselCountUpdate</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsDepartBatch">handleVesselsDepartBatch</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsDepartComplete">handleVesselsDepartComplete</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsDeparted">handleVesselsDeparted</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsDrydocked">handleVesselsDrydocked</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsFailed">handleVesselsFailed</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~handleVesselsRepaired">handleVesselsRepaired</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~hideMemberSuggestions">hideMemberSuggestions</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~insertMention">insertMention</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~registerUsernameClickEvents">registerUsernameClickEvents</a></li><li data-type='method' style='display: none;'><a href="module-chat.html#~updateAllianceChatBadge">updateAllianceChatBadge</a></li></ul></li><li><a href="module-company-profile.html">company-profile</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-company-profile.html#.closeCompanyProfile">closeCompanyProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#.initCompanyProfile">initCompanyProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#.openCompanyProfile">openCompanyProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#.openPlayerProfile">openPlayerProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~addToContacts">addToContacts</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~adjustSalary">adjustSalary</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~attachAllianceClickListener">attachAllianceClickListener</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~attachSalaryButtonListeners">attachSalaryButtonListeners</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~attachStockActionListeners">attachStockActionListeners</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~buildAchievementsSection">buildAchievementsSection</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~buildSection">buildSection</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~buildStaffSection">buildStaffSection</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~dismissStaffPointsBanner">dismissStaffPointsBanner</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~formatLabel">formatLabel</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~formatMoraleLabel">formatMoraleLabel</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~formatPerkName">formatPerkName</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~formatValue">formatValue</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~generateMoraleSmiley">generateMoraleSmiley</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~loadAllianceDetails">loadAllianceDetails</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~loadCompanyProfile">loadCompanyProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~loadStaffData">loadStaffData</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~loadStockSection">loadStockSection</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~normalizeColor">normalizeColor</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~removeFromContacts">removeFromContacts</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~renderCompanyProfile">renderCompanyProfile</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~renderSearchResults">renderSearchResults</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~searchPlayers">searchPlayers</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~startStockSellTimer">startStockSellTimer</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~toggleAchievementsList">toggleAchievementsList</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~toggleStaffDetails">toggleStaffDetails</a></li><li data-type='method' style='display: none;'><a href="module-company-profile.html#~trainPerk">trainPerk</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method' style='display: none;'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method' style='display: none;'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method' style='display: none;'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method' style='display: none;'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li><li data-type='method' style='display: none;'><a href="module-coop.html#~renderMemberCard">renderMemberCard</a></li></ul></li><li><a href="module-core_app-initializer.html">core/app-initializer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#.initializeApp">initializeApp</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~createAllianceChatHandler">createAllianceChatHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~createBuyVesselsHandler">createBuyVesselsHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~createDebouncedFunctions">createDebouncedFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~createForecastHandler">createForecastHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~createTestBrowserNotification">createTestBrowserNotification</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~exposeGlobalFunctions">exposeGlobalFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~initializeSettingsUI">initializeSettingsUI</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~loadInitialData">loadInitialData</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~loadPortsDataGlobal">loadPortsDataGlobal</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~loadUserSettings">loadUserSettings</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~registerAllEventListeners">registerAllEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~setCheckboxState">setCheckboxState</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~setCheckboxValue">setCheckboxValue</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~setFormattedInputValue">setFormattedInputValue</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~setInputValue">setInputValue</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~setSelectValue">setSelectValue</a></li><li data-type='method' style='display: none;'><a href="module-core_app-initializer.html#~toggleElementVisibility">toggleElementVisibility</a></li></ul></li><li><a href="module-core_auto-refresh.html">core/auto-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.getActiveIntervals">getActiveIntervals</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.initNotificationButtonUpdater">initNotificationButtonUpdater</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.initVersionChecker">initVersionChecker</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.initVisibilityHandler">initVisibilityHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.preloadAllImages">preloadAllImages</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.stopAllIntervals">stopAllIntervals</a></li><li data-type='method' style='display: none;'><a href="module-core_auto-refresh.html#.stopInterval">stopInterval</a></li></ul></li><li><a href="module-core_badge-cache.html">core/badge-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#.loadCache">loadCache</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#.saveBadgeCache">saveBadgeCache</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#.updateCoopDisplay">updateCoopDisplay</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadBunkerStatus">loadBunkerStatus</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadCampaignsBadge">loadCampaignsBadge</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadCoopData">loadCoopData</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadHijackingBadge">loadHijackingBadge</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadPrices">loadPrices</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadRepairBadges">loadRepairBadges</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadStockAndAnchor">loadStockAndAnchor</a></li><li data-type='method' style='display: none;'><a href="module-core_badge-cache.html#~loadVesselBadges">loadVesselBadges</a></li></ul></li><li><a href="module-core_debounced-api.html">core/debounced-api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_debounced-api.html#.cancelAllDebouncedFunctions">cancelAllDebouncedFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.html#.cancelDebouncedFunction">cancelDebouncedFunction</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.html#.createDebouncedFunction">createDebouncedFunction</a></li><li data-type='method' style='display: none;'><a href="module-core_debounced-api.html#.isDebouncePending">isDebouncePending</a></li></ul></li><li><a href="module-core_event-registry.html">core/event-registry</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerAutoDepartSettingsListeners">registerAutoDepartSettingsListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerAutoPilotFeatureListeners">registerAutoPilotFeatureListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerAutoPilotListeners">registerAutoPilotListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerAutoRebuyCO2Listeners">registerAutoRebuyCO2Listeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerAutoRebuyFuelListeners">registerAutoRebuyFuelListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerBunkerListeners">registerBunkerListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerChatBotSettingsListeners">registerChatBotSettingsListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerChatEventListeners">registerChatEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerCustomCommandsListeners">registerCustomCommandsListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerDialogEventListeners">registerDialogEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerIntelligentRebuyListeners">registerIntelligentRebuyListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerMessengerEventListeners">registerMessengerEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerNotificationPermissionListener">registerNotificationPermissionListener</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerNumberFormatting">registerNumberFormatting</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerSectionToggle">registerSectionToggle</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerSettingsThresholdListeners">registerSettingsThresholdListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#.registerVesselCatalogEventListeners">registerVesselCatalogEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#~createCustomCommandElement">createCustomCommandElement</a></li><li data-type='method' style='display: none;'><a href="module-core_event-registry.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li></ul></li><li><a href="module-core_global-exports.html">core/global-exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportApiUrl">exportApiUrl</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportAutopilotFunctions">exportAutopilotFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportCacheKeys">exportCacheKeys</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportDebouncedFunctions">exportDebouncedFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportDebugMode">exportDebugMode</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportGlobals">exportGlobals</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportLogbookHandler">exportLogbookHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportOverlayFunctions">exportOverlayFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportSettingsHandler">exportSettingsHandler</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportStorageFunctions">exportStorageFunctions</a></li><li data-type='method' style='display: none;'><a href="module-core_global-exports.html#.exportVersionFunctions">exportVersionFunctions</a></li></ul></li><li><a href="module-core_logger.html">core/logger</a></li><li><a href="module-core_settings-sync.html">core/settings-sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#.handleSettingsUpdate">handleSettingsUpdate</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#.toggleAutoPilotAgentCheckboxes">toggleAutoPilotAgentCheckboxes</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~formatNumberWithSeparator">formatNumberWithSeparator</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateAutoPilotToggles">updateAutoPilotToggles</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateAutoRebuyCO2UI">updateAutoRebuyCO2UI</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateAutoRebuyFuelUI">updateAutoRebuyFuelUI</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateChatBotSettings">updateChatBotSettings</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateNotificationSettings">updateNotificationSettings</a></li><li data-type='method' style='display: none;'><a href="module-core_settings-sync.html#~updateThresholdInputs">updateThresholdInputs</a></li></ul></li><li><a href="module-core_storage-manager.html">core/storage-manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.clearUserStorage">clearUserStorage</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.getStorage">getStorage</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.getUserStorageKey">getUserStorageKey</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.getUserStoragePrefix">getUserStoragePrefix</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.removeStorage">removeStorage</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.setStorage">setStorage</a></li><li data-type='method' style='display: none;'><a href="module-core_storage-manager.html#.setUserStoragePrefix">setUserStoragePrefix</a></li></ul></li><li><a href="module-core_websocket-client.html">core/websocket-client</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.getWebSocketState">getWebSocketState</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.incrementReconnectCounter">incrementReconnectCounter</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.initAutopilotControls">initAutopilotControls</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.loadAutopilotState">loadAutopilotState</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.resetReconnectCounter">resetReconnectCounter</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.triggerPriceAlertCheck">triggerPriceAlertCheck</a></li><li data-type='method' style='display: none;'><a href="module-core_websocket-client.html#.updateWebSocketState">updateWebSocketState</a></li></ul></li><li><a href="module-depart-manager.html">depart-manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.closeDepartManager">closeDepartManager</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.initializeDepartManager">initializeDepartManager</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.openDepartManager">openDepartManager</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.refreshDepartManagerIfOpen">refreshDepartManagerIfOpen</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.toggleDepartManager">toggleDepartManager</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#.updateDepartManagerLockState">updateDepartManagerLockState</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~addMassMoorEventHandlers">addMassMoorEventHandlers</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~addVesselItemEventHandlers">addVesselItemEventHandlers</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~clearSearch">clearSearch</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~departSelectedVessels">departSelectedVessels</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~drag">drag</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~formatDuration">formatDuration</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~formatETA">formatETA</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~formatLoadingStatus">formatLoadingStatus</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~getLoadingStatus">getLoadingStatus</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~getPortDrydock">getPortDrydock</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~getStatusInfo">getStatusInfo</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~getVesselStatusText">getVesselStatusText</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~loadPortsData">loadPortsData</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~loadVesselsByStatus">loadVesselsByStatus</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~locateVesselOnMap">locateVesselOnMap</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~moorSelectedVessels">moorSelectedVessels</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~renderDrydockEnrouteItem">renderDrydockEnrouteItem</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~renderMassMoorTab">renderMassMoorTab</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~renderMassMoorVesselItem">renderMassMoorVesselItem</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~renderVesselItem">renderVesselItem</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~resumeSelectedVessels">resumeSelectedVessels</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~searchVesselsAcrossTabs">searchVesselsAcrossTabs</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~selectAllVessels">selectAllVessels</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~selectVesselRouteOnMap">selectVesselRouteOnMap</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~startDrag">startDrag</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~stopDrag">stopDrag</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~unselectAllVessels">unselectAllVessels</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateAnchorTabCount">updateAnchorTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateAtPortTabCount">updateAtPortTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateAtSeaTabCount">updateAtSeaTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateDepartButtonCount">updateDepartButtonCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateDryDockTabCount">updateDryDockTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateMassMoorButtonCounts">updateMassMoorButtonCounts</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateMoorResumeButtonCounts">updateMoorResumeButtonCounts</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateMoorTabCount">updateMoorTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updatePendingTabCount">updatePendingTabCount</a></li><li data-type='method' style='display: none;'><a href="module-depart-manager.html#~updateVesselMoorState">updateVesselMoorState</a></li></ul></li><li><a href="module-desktop-notification-templates.html">desktop-notification-templates</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.createDesktopNotification">createDesktopNotification</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.getDefaultEmoji">getDefaultEmoji</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.getNotificationTypes">getNotificationTypes</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.isValidNotificationType">isValidNotificationType</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.notifyAlert">notifyAlert</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.notifyError">notifyError</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.notifySuccess">notifySuccess</a></li><li data-type='method' style='display: none;'><a href="module-desktop-notification-templates.html#.notifyWarning">notifyWarning</a></li></ul></li><li><a href="module-event-info.html">event-info</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-event-info.html#.initEventInfo">initEventInfo</a></li><li data-type='method' style='display: none;'><a href="module-event-info.html#.openEventModal">openEventModal</a></li><li data-type='method' style='display: none;'><a href="module-event-info.html#.updateEventData">updateEventData</a></li><li data-type='method' style='display: none;'><a href="module-event-info.html#~startEventTimer">startEventTimer</a></li></ul></li><li><a href="module-forecast-calendar.html">forecast-calendar</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#.initForecastCalendar">initForecastCalendar</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#.updateEventDiscount">updateEventDiscount</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~createTableHTML">createTableHTML</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~getBrowserTimezone">getBrowserTimezone</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~getCo2Class">getCo2Class</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~getCurrentVisibleDay">getCurrentVisibleDay</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~getFuelClass">getFuelClass</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~isEventActiveAtTime">isEventActiveAtTime</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~isEventActiveOnDay">isEventActiveOnDay</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~loadForecastData">loadForecastData</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~preloadMonth">preloadMonth</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~renderBook">renderBook</a></li><li data-type='method' style='display: none;'><a href="module-forecast-calendar.html#~updateEventBadge">updateEventBadge</a></li></ul></li><li><a href="module-harbor-map-aggregator.html">harbor-map-aggregator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~aggregateReachablePorts">aggregateReachablePorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~aggregateVesselData">aggregateVesselData</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~categorizeVesselsByPort">categorizeVesselsByPort</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~extractPortsFromGameIndex">extractPortsFromGameIndex</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~extractVesselsFromGameIndex">extractVesselsFromGameIndex</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~filterAssignedPorts">filterAssignedPorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~formatPortAbbreviation">formatPortAbbreviation</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~groupVesselsByPortPair">groupVesselsByPortPair</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-aggregator.html#~hasOwnImage">hasOwnImage</a></li></ul></li><li><a href="module-harbor-map-calculator.html">harbor-map-calculator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map-calculator.html#~calculateCargoUtilization">calculateCargoUtilization</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-calculator.html#~calculateDemandLevel">calculateDemandLevel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-calculator.html#~calculateETA">calculateETA</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-calculator.html#~calculateVesselPosition">calculateVesselPosition</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-calculator.html#~formatCargoCapacity">formatCargoCapacity</a></li></ul></li><li><a href="module-harbor-map-init.html">harbor-map-init</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.closeHarborMap">closeHarborMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.forceRefreshMap">forceRefreshMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.initHarborMap">initHarborMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.openHarborMap">openHarborMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.preloadHarborMapData">preloadHarborMapData</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.refreshHarborMapIfOpen">refreshHarborMapIfOpen</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.reloadMap">reloadMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.startHarborMapAutoUpdate">startHarborMapAutoUpdate</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#.stopHarborMapAutoUpdate">stopHarborMapAutoUpdate</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#~departVesselWrapper">departVesselWrapper</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#~getVesselByIdWrapper">getVesselByIdWrapper</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#~selectVesselFromMap">selectVesselFromMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#~sellVesselFromPanelWrapper">sellVesselFromPanelWrapper</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map-init.html#~updateVesselMarkerWrapper">updateVesselMarkerWrapper</a></li></ul></li><li><a href="module-harbor-map_api-client.html">harbor-map/api-client</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.clearHarborMapCache">clearHarborMapCache</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.clearOverviewCache">clearOverviewCache</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.exportVesselHistory">exportVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.fetchHarborMapOverview">fetchHarborMapOverview</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.fetchPortDetails">fetchPortDetails</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.fetchVesselReachablePorts">fetchVesselReachablePorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.getCachedOverview">getCachedOverview</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.invalidateOverviewCache">invalidateOverviewCache</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_api-client.html#.prefetchHarborMapData">prefetchHarborMapData</a></li></ul></li><li><a href="module-harbor-map_filters.html">harbor-map/filters</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.applyDemandFilter">applyDemandFilter</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.calculatePortCurrentCargoDemand">calculatePortCurrentCargoDemand</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.calculatePortCurrentOilDemand">calculatePortCurrentOilDemand</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.calculatePortMaxCargoDemand">calculatePortMaxCargoDemand</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.calculatePortMaxOilDemand">calculatePortMaxOilDemand</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.filterPorts">filterPorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.filterPortsByPortPair">filterPortsByPortPair</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.filterVessels">filterVessels</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.filterVesselsByPortPair">filterVesselsByPortPair</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.getDemandFilterOptions">getDemandFilterOptions</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.getPortFilterOptions">getPortFilterOptions</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#.getVesselFilterOptions">getVesselFilterOptions</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_filters.html#~calculateVesselUtilization">calculateVesselUtilization</a></li></ul></li><li><a href="module-harbor-map_map-controller.html">harbor-map/map-controller</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.clearRoute">clearRoute</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.closeAllPanels">closeAllPanels</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.deselectAll">deselectAll</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.drawRoute">drawRoute</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.getCurrentPorts">getCurrentPorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.getMap">getMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.getOverviewData">getOverviewData</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.getSelectedPortCode">getSelectedPortCode</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.getVesselById">getVesselById</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.highlightPorts">highlightPorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.initMap">initMap</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.loadOverview">loadOverview</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.renderPorts">renderPorts</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.renderVessels">renderVessels</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.resetPortDisplay">resetPortDisplay</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.selectPort">selectPort</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.selectVessel">selectVessel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.setPortFilter">setPortFilter</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.setRouteFilter">setRouteFilter</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.setVesselFilter">setVesselFilter</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.updateVesselMarker">updateVesselMarker</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#.updateWeatherDataSetting">updateWeatherDataSetting</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~addCustomControls">addCustomControls</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~applyFilterModalSelections">applyFilterModalSelections</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~applyFiltersAndRender">applyFiltersAndRender</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~applyMapTheme">applyMapTheme</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~calculateHeading">calculateHeading</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~categorizeVesselsByPortClientSide">categorizeVesselsByPortClientSide</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~changeTileLayer">changeTileLayer</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~closeFilterModal">closeFilterModal</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~createVesselIcon">createVesselIcon</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~getVesselType">getVesselType</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~hideRouteVesselsPanel">hideRouteVesselsPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~initFilterModalDrag">initFilterModalDrag</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~onFilterModalDrag">onFilterModalDrag</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~onFilterModalDragEnd">onFilterModalDragEnd</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~openFilterModal">openFilterModal</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~populateFilterModalDropdowns">populateFilterModalDropdowns</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~resetAllFilters">resetAllFilters</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~showRouteVesselsPanel">showRouteVesselsPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~showWeatherInfo">showWeatherInfo</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~toggleWeatherLayer">toggleWeatherLayer</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~updateDemandFilterDropdowns">updateDemandFilterDropdowns</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_map-controller.html#~updateRouteDropdown">updateRouteDropdown</a></li></ul></li><li><a href="module-harbor-map_panel-drag.html">harbor-map/panel-drag</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_panel-drag.html#.initializePanelDrag">initializePanelDrag</a></li></ul></li><li><a href="module-harbor-map_port-panel.html">harbor-map/port-panel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#.closePortPanel">closePortPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#.fetchAndUpdatePortDemand">fetchAndUpdatePortDemand</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#.hidePortPanel">hidePortPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#.selectVesselFromPort">selectVesselFromPort</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#.showPortPanel">showPortPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~formatPortFullName">formatPortFullName</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~loadPortAllianceData">loadPortAllianceData</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~loadPortWeather">loadPortWeather</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~openAllianceModal">openAllianceModal</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~renderDemandSection">renderDemandSection</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~renderTypicalDemandSection">renderTypicalDemandSection</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~renderVesselList">renderVesselList</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_port-panel.html#~renderVesselsOverview">renderVesselsOverview</a></li></ul></li><li><a href="module-harbor-map_route-vessels-panel.html">harbor-map/route-vessels-panel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_route-vessels-panel.html#.closeRoutePanel">closeRoutePanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_route-vessels-panel.html#.hideRoutePanel">hideRoutePanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_route-vessels-panel.html#.selectRouteVessel">selectRouteVessel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_route-vessels-panel.html#.showRoutePanel">showRoutePanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_route-vessels-panel.html#~storeVessels">storeVessels</a></li></ul></li><li><a href="module-harbor-map_vessel-panel.html">harbor-map/vessel-panel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.closeVesselPanel">closeVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.departVessel">departVessel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.exportHistoryFormat">exportHistoryFormat</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.getCurrentVesselId">getCurrentVesselId</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.hideVesselPanel">hideVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.isLocalDepartInProgress">isLocalDepartInProgress</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.refreshOpenVesselPanel">refreshOpenVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.sellVesselFromPanel">sellVesselFromPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.showVesselPanel">showVesselPanel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.startRenameVessel">startRenameVessel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.toggleExportMenu">toggleExportMenu</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#.updateVesselPanelDepartButtons">updateVesselPanelDepartButtons</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~cancelVesselRename">cancelVesselRename</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~closeExportMenuOnClickOutside">closeExportMenuOnClickOutside</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~formatLoadingStatusText">formatLoadingStatusText</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~formatTimeRemaining">formatTimeRemaining</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~formatVesselStatus">formatVesselStatus</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~getCountryFlag">getCountryFlag</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~getLoadingStatus">getLoadingStatus</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~getPortCountryCode">getPortCountryCode</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~loadRoutePortDemands">loadRoutePortDemands</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~loadVesselWeather">loadVesselWeather</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~openRepairDialog">openRepairDialog</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~openVesselAppearanceEditor">openVesselAppearanceEditor</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~processDepartureQueue">processDepartureQueue</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~renderHistoryPage">renderHistoryPage</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~saveVesselRename">saveVesselRename</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~setupInfiniteScroll">setupInfiniteScroll</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~toggleParkVessel">toggleParkVessel</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~updateVesselCardName">updateVesselCardName</a></li><li data-type='method' style='display: none;'><a href="module-harbor-map_vessel-panel.html#~updateVesselNameInShipsMenu">updateVesselNameInShipsMenu</a></li></ul></li><li><a href="module-logbook.html">logbook</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-logbook.html#.deleteAllLogsConfirmed">deleteAllLogsConfirmed</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#.getLogFileSize">getLogFileSize</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#.initLogbook">initLogbook</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#.prependLogEntry">prependLogEntry</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~applyFiltersToEntries">applyFiltersToEntries</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~convertActionFilterToBackend">convertActionFilterToBackend</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~createLogEntryHTML">createLogEntryHTML</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~ensureScrollable">ensureScrollable</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~exportLogs">exportLogs</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~formatDetails">formatDetails</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~getTransactionType">getTransactionType</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~loadLogs">loadLogs</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~renderLogPage">renderLogPage</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~renderLogTable">renderLogTable</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~setupEventListeners">setupEventListeners</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~updateActionFilter">updateActionFilter</a></li><li data-type='method' style='display: none;'><a href="module-logbook.html#~updateLogCount">updateLogCount</a></li></ul></li><li><a href="module-map-icon-bar.html">map-icon-bar</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-map-icon-bar.html#.closeAllModalOverlays">closeAllModalOverlays</a></li><li data-type='method' style='display: none;'><a href="module-map-icon-bar.html#.initializeMapIconBar">initializeMapIconBar</a></li><li data-type='method' style='display: none;'><a href="module-map-icon-bar.html#~handleIconAction">handleIconAction</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li><li data-type='method' style='display: none;'><a href="module-messenger.html#~stopHijackingPolling">stopHijackingPolling</a></li></ul></li><li><a href="module-public_js_modules_hijacking.html">public/js/modules/hijacking</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#.closeHijackingInbox">closeHijackingInbox</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#.openHijackingInbox">openHijackingInbox</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#.updateHijackedVesselsDisplay">updateHijackedVesselsDisplay</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#.updateHijackingBadge">updateHijackingBadge</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~deleteCase">deleteCase</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~escapeHtml">escapeHtml</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~openCaseDetails">openCaseDetails</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~refreshHijackingBadge">refreshHijackingBadge</a></li><li data-type='method' style='display: none;'><a href="module-public_js_modules_hijacking.html#~renderCaseList">renderCaseList</a></li></ul></li><li><a href="module-route-planner.html">route-planner</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-route-planner.html#.closeRoutePlanner">closeRoutePlanner</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.getPlanningVesselId">getPlanningVesselId</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.initializeRoutePlanner">initializeRoutePlanner</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.isPlanningMode">isPlanningMode</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.openRoutePlanner">openRoutePlanner</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.restorePlanningState">restorePlanningState</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#.selectPortForRoute">selectPortForRoute</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~applyDemandPortFilter">applyDemandPortFilter</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~applyPortFilter">applyPortFilter</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateFuelConsumption">calculateFuelConsumption</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateGuardsCost">calculateGuardsCost</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateHarborFeeRange">calculateHarborFeeRange</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateRouteCreationFee">calculateRouteCreationFee</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~calculateTravelTime">calculateTravelTime</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~clearRouteSelection">clearRouteSelection</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~createRoute">createRoute</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~fetchAndDisplayDemand">fetchAndDisplayDemand</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~fetchAndSetAutoPrice">fetchAndSetAutoPrice</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~fetchRouteData">fetchRouteData</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~fetchRouteTabDemand">fetchRouteTabDemand</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~formatDemandCell">formatDemandCell</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~formatPortName">formatPortName</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~formatTravelTime">formatTravelTime</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~loadSuggestedRoute">loadSuggestedRoute</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~loadVesselPorts">loadVesselPorts</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~populateDemandDropdown">populateDemandDropdown</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~saveRouteChanges">saveRouteChanges</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~showError">showError</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~switchTab">switchTab</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateDemandDisplay">updateDemandDisplay</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updatePortsGuardsDisplay">updatePortsGuardsDisplay</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updatePortsSpeedDisplay">updatePortsSpeedDisplay</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateRouteTabDemandDisplay">updateRouteTabDemandDisplay</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateRouteTabVisibility">updateRouteTabVisibility</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateRouteTabWithCurrentRoute">updateRouteTabWithCurrentRoute</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateSelectedPortDisplay">updateSelectedPortDisplay</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateSliderDisplays">updateSliderDisplays</a></li><li data-type='method' style='display: none;'><a href="module-route-planner.html#~updateVesselCapacityDisplay">updateVesselCapacityDisplay</a></li></ul></li><li><a href="module-server_analytics_aggregator.html">server/analytics/aggregator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~aggregateRansomPayments">aggregateRansomPayments</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~calculateRouteHijackCounts">calculateRouteHijackCounts</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~calculateWeightedAverage">calculateWeightedAverage</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~fetchGameHijackingRisks">fetchGameHijackingRisks</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~filterByDays">filterByDays</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~filterByType">filterByType</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~formatRouteDisplay">formatRouteDisplay</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getActionTypes">getActionTypes</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getContributionAnalysis">getContributionAnalysis</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getDailyRevenueTrend">getDailyRevenueTrend</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getDetailedExpenses">getDetailedExpenses</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getFilteredLogs">getFilteredLogs</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getHarborFeeAnalysis">getHarborFeeAnalysis</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getMergedDepartures">getMergedDepartures</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getMergedOperationsSummary">getMergedOperationsSummary</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getMergedSummary">getMergedSummary</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getPurchaseAnalysis">getPurchaseAnalysis</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getRouteContribution">getRouteContribution</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getRouteProfitability">getRouteProfitability</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getRouteProfitabilityMerged">getRouteProfitabilityMerged</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getRouteProfitabilityWithContribution">getRouteProfitabilityWithContribution</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getVesselNameFromHijackHistory">getVesselNameFromHijackHistory</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getVesselPerformance">getVesselPerformance</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getVesselPerformanceMerged">getVesselPerformanceMerged</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getVesselPerformanceWithContribution">getVesselPerformanceWithContribution</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getVesselsByRoute">getVesselsByRoute</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~getWeeklySummary">getWeeklySummary</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~isAutopilotTransaction">isAutopilotTransaction</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~loadAuditLog">loadAuditLog</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~loadVesselHistory">loadVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~mapContextToAutopilotType">mapContextToAutopilotType</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~mapContextToCategory">mapContextToCategory</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_aggregator.html#~normalizeRouteKey">normalizeRouteKey</a></li></ul></li><li><a href="module-server_analytics_api-stats-store.html">server/analytics/api-stats-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~cleanupOldStats">cleanupOldStats</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~closeDb">closeDb</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~flushBuffer">flushBuffer</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getAvailableDates">getAvailableDates</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getCurrentMinuteKey">getCurrentMinuteKey</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getDb">getDb</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getDbPath">getDbPath</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getHourlyStats">getHourlyStats</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~migrateFromJson">migrateFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~recordCall">recordCall</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~startAutoFlush">startAutoFlush</a></li><li data-type='method' style='display: none;'><a href="module-server_analytics_api-stats-store.html#~stopAutoFlush">stopAutoFlush</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method' style='display: none;'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_autopilot.html">server/autopilot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~analyzeVesselDepartures">analyzeVesselDepartures</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~autoRebuyAll">autoRebuyAll</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~checkPriceAlerts">checkPriceAlerts</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~checkTelegramPriceAlerts">checkTelegramPriceAlerts</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~countActiveCampaignTypes">countActiveCampaignTypes</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~fastEventLoop">fastEventLoop</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~getGameIndexCached">getGameIndexCached</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~initializeAutopilotState">initializeAutopilotState</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~pauseAutopilot">pauseAutopilot</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~resumeAutopilot">resumeAutopilot</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~setBroadcastFunction">setBroadcastFunction</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~slowEventLoop">slowEventLoop</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~startMainEventLoop">startMainEventLoop</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~tryUpdateAllData">tryUpdateAllData</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateAllData">updateAllData</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateCampaigns">updateCampaigns</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updatePrices">updatePrices</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateUnreadMessages">updateUnreadMessages</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot.html#~updateVesselCount">updateVesselCount</a></li></ul></li><li><a href="module-server_autopilot_pilot_atmosphere_broker.html">server/autopilot/pilot_atmosphere_broker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_atmosphere_broker.html#~autoRebuyCO2">autoRebuyCO2</a></li></ul></li><li><a href="module-server_autopilot_pilot_barrel_boss.html">server/autopilot/pilot_barrel_boss</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_barrel_boss.html#~autoRebuyFuel">autoRebuyFuel</a></li></ul></li><li><a href="module-server_autopilot_pilot_captain_blackbeard.html">server/autopilot/pilot_captain_blackbeard</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~autoNegotiateHijacking">autoNegotiateHijacking</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~processHijackingCase">processHijackingCase</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_captain_blackbeard.html#~wait">wait</a></li></ul></li><li><a href="module-server_autopilot_pilot_cargo_marshal.html">server/autopilot/pilot_cargo_marshal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_cargo_marshal.html#~autoDepartVessels">autoDepartVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_cargo_marshal.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_cargo_marshal.html#~departVessels">departVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_cargo_marshal.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_cargo_marshal.html#~resetFuelFailedCacheIfIncreased">resetFuelFailedCacheIfIncreased</a></li></ul></li><li><a href="module-server_autopilot_pilot_drydock_master.html">server/autopilot/pilot_drydock_master</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_drydock_master.html#~autoDrydockVessels">autoDrydockVessels</a></li></ul></li><li><a href="module-server_autopilot_pilot_fair_hand.html">server/autopilot/pilot_fair_hand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_fair_hand.html#~autoCoop">autoCoop</a></li></ul></li><li><a href="module-server_autopilot_pilot_harbormaster.html">server/autopilot/pilot_harbormaster</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_harbormaster.html#~autoAnchorPointPurchase">autoAnchorPointPurchase</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_harbormaster.html#~setBroadcastFunction">setBroadcastFunction</a></li></ul></li><li><a href="module-server_autopilot_pilot_reputation_chief.html">server/autopilot/pilot_reputation_chief</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_reputation_chief.html#~autoCampaignRenewal">autoCampaignRenewal</a></li></ul></li><li><a href="module-server_autopilot_pilot_staff_captain.html">server/autopilot/pilot_staff_captain</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_staff_captain.html#~manageStaffMorale">manageStaffMorale</a></li></ul></li><li><a href="module-server_autopilot_pilot_the_purser.html">server/autopilot/pilot_the_purser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_the_purser.html#~autoBuyStock">autoBuyStock</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_the_purser.html#~autoSellStock">autoSellStock</a></li><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_the_purser.html#~clearPurchasedCache">clearPurchasedCache</a></li></ul></li><li><a href="module-server_autopilot_pilot_yard_foreman.html">server/autopilot/pilot_yard_foreman</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_autopilot_pilot_yard_foreman.html#~autoRepairVessels">autoRepairVessels</a></li></ul></li><li><a href="module-server_cache.html">server/cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_cache.html#~clearAllCaches">clearAllCaches</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~getAllianceCache">getAllianceCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~getCampaignCache">getCampaignCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~getCompanyCache">getCompanyCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~getCoopCache">getCoopCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~getGameIndexCache">getGameIndexCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~invalidateCampaignCache">invalidateCampaignCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~invalidateCoopCache">invalidateCoopCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~invalidateGameIndexCache">invalidateGameIndexCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~isCacheValid">isCacheValid</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~setAllianceCache">setAllianceCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~setCampaignCache">setCampaignCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~setCompanyCache">setCompanyCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~setCoopCache">setCoopCache</a></li><li data-type='method' style='display: none;'><a href="module-server_cache.html#~setGameIndexCache">setGameIndexCache</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~isCertificateInstalled">isCertificateInstalled</a></li><li data-type='method' style='display: none;'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_chatbot.html">server/chatbot</a></li><li><a href="module-server_chatbot_commands.html">server/chatbot/commands</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~generateForecastText">generateForecastText</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~getBroadcastDir">getBroadcastDir</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~getEnabledBroadcastTemplates">getEnabledBroadcastTemplates</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~handleForecastCommand">handleForecastCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~handleHelpCommand">handleHelpCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~handleMsgCommand">handleMsgCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~handleWelcomeCommand">handleWelcomeCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_commands.html#~loadBroadcastTemplates">loadBroadcastTemplates</a></li></ul></li><li><a href="module-server_chatbot_executor.html">server/chatbot/executor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_executor.html#~executeCommand">executeCommand</a></li></ul></li><li><a href="module-server_chatbot_parser.html">server/chatbot/parser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~findCustomCommand">findCustomCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~isCommandAllowedInChannel">isCommandAllowedInChannel</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~processAllianceMessage">processAllianceMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~processPrivateMessage">processPrivateMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~processQueue">processQueue</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~queueCommand">queueCommand</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~resolveCommandName">resolveCommandName</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~validateCommandArguments">validateCommandArguments</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~validateForecastArguments">validateForecastArguments</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_parser.html#~validateWelcomeArguments">validateWelcomeArguments</a></li></ul></li><li><a href="module-server_chatbot_scheduler.html">server/chatbot/scheduler</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_scheduler.html#~scheduleDailyForecast">scheduleDailyForecast</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_scheduler.html#~sendDailyForecast">sendDailyForecast</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_scheduler.html#~setupScheduledTasks">setupScheduledTasks</a></li></ul></li><li><a href="module-server_chatbot_sender.html">server/chatbot/sender</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~broadcastDmFailureNotification">broadcastDmFailureNotification</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~broadcastDmQueuedNotification">broadcastDmQueuedNotification</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~broadcastRateLimitNotification">broadcastRateLimitNotification</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~getDmQueueStatus">getDmQueueStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~processDmQueue">processDmQueue</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~queuePrivateMessage">queuePrivateMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~sendAllianceMessage">sendAllianceMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~sendErrorMessage">sendErrorMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~sendPrivateMessage">sendPrivateMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~sendPrivateMessageDirect">sendPrivateMessageDirect</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_sender.html#~sendResponse">sendResponse</a></li></ul></li><li><a href="module-server_chatbot_settings.html">server/chatbot/settings</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~getDefaultChatBotObject">getDefaultChatBotObject</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~hasManagementRole">hasManagementRole</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~loadSettings">loadSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~mapChatBotObjectToFlatSettings">mapChatBotObjectToFlatSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~mapSettingsToChatBotObject">mapSettingsToChatBotObject</a></li><li data-type='method' style='display: none;'><a href="module-server_chatbot_settings.html#~updateSettings">updateSettings</a></li></ul></li><li><a href="module-server_config.html">server/config</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_config.html#~getAppBaseDir">getAppBaseDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getAppDataDir">getAppDataDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getAppPlatformCookie">getAppPlatformCookie</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getAppVersionCookie">getAppVersionCookie</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getDbDir">getDbDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getInternalBaseUrl">getInternalBaseUrl</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getLocalAppDataDir">getLocalAppDataDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getLogDir">getLogDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getPortFromDatabase">getPortFromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getSessionCookie">getSessionCookie</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~isPackaged">isPackaged</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~loadStartupSettings">loadStartupSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_config.html#~setSessionCookie">setSessionCookie</a></li></ul></li><li><a href="module-server_database.html">server/database</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database.html#~addToStockBlacklist">addToStockBlacklist</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~closeAccountsDb">closeAccountsDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~closeAll">closeAll</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~closeDb">closeDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~createAccountsSchema">createAccountsSchema</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~createSchema">createSchema</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~deleteAccount">deleteAccount</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~deleteRouteSettings">deleteRouteSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~ensureDbDir">ensureDbDir</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~findNextAvailablePort">findNextAvailablePort</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAccount">getAccount</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAccountsDb">getAccountsDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAccountsDbPath">getAccountsDbPath</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAllAccounts">getAllAccounts</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAllGlobalSettings">getAllGlobalSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getAllRouteSettings">getAllRouteSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getDb">getDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getDbDir">getDbDir</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getDbPath">getDbPath</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getGlobalSetting">getGlobalSetting</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getHijackHistoryDir">getHijackHistoryDir</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getMetadata">getMetadata</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getRouteSettings">getRouteSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getStockBlacklist">getStockBlacklist</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~getUserSettings">getUserSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~isMigrationComplete">isMigrationComplete</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~isStockBlacklisted">isStockBlacklisted</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~markMigrationComplete">markMigrationComplete</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~migrateAllHijackHistoryFromJson">migrateAllHijackHistoryFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~migrateHijackHistoryFromJson">migrateHijackHistoryFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~removeFromStockBlacklist">removeFromStockBlacklist</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~saveAccount">saveAccount</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~saveRouteSettings">saveRouteSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~saveUserSettings">saveUserSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~setAccountAutostart">setAccountAutostart</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~setAccountPort">setAccountPort</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~setGlobalSetting">setGlobalSetting</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~setMetadata">setMetadata</a></li><li data-type='method' style='display: none;'><a href="module-server_database.html#~transaction">transaction</a></li></ul></li><li><a href="module-server_database_alliance-cache.html">server/database/alliance-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~bulkUpdate">bulkUpdate</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~clearCache">clearCache</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~closeDb">closeDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~deleteAlliance">deleteAlliance</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getAll">getAll</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getById">getById</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getCount">getCount</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getDb">getDb</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getDbPath">getDbPath</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getLastUpdate">getLastUpdate</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~getTopByContribution">getTopByContribution</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~importFromJson">importFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~search">search</a></li><li data-type='method' style='display: none;'><a href="module-server_database_alliance-cache.html#~upsertAlliance">upsertAlliance</a></li></ul></li><li><a href="module-server_database_init.html">server/database/init</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_init.html#~initAllUserDatabases">initAllUserDatabases</a></li><li data-type='method' style='display: none;'><a href="module-server_database_init.html#~initUserDatabase">initUserDatabase</a></li></ul></li><li><a href="module-server_database_json-repair.html">server/database/json-repair</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_json-repair.html#~findLastValidJsonEnd">findLastValidJsonEnd</a></li><li data-type='method' style='display: none;'><a href="module-server_database_json-repair.html#~removeBadControlChars">removeBadControlChars</a></li><li data-type='method' style='display: none;'><a href="module-server_database_json-repair.html#~repairAllUserFiles">repairAllUserFiles</a></li><li data-type='method' style='display: none;'><a href="module-server_database_json-repair.html#~repairJsonFile">repairJsonFile</a></li><li data-type='method' style='display: none;'><a href="module-server_database_json-repair.html#~repairJsonString">repairJsonString</a></li></ul></li><li><a href="module-server_database_migration.html">server/database/migration</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~findAllUsersWithData">findAllUsersWithData</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~findUserHijackFiles">findUserHijackFiles</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~findUserJsonFiles">findUserJsonFiles</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~findUserVesselAppearanceFiles">findUserVesselAppearanceFiles</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~getLegacyOlduserdataDirs">getLegacyOlduserdataDirs</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~getOlddataDir">getOlddataDir</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~getUserdataDir">getUserdataDir</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importAutopilotLog">importAutopilotLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importHijackCase">importHijackCase</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importLookup">importLookup</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importMessengerCache">importMessengerCache</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importProcessedDmMessages">importProcessedDmMessages</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importTransactions">importTransactions</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importTripData">importTripData</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importVesselAppearance">importVesselAppearance</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~importVesselHistory">importVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~migrateAll">migrateAll</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~migrateUser">migrateUser</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~moveToOldData">moveToOldData</a></li><li data-type='method' style='display: none;'><a href="module-server_database_migration.html#~safeParseJson">safeParseJson</a></li></ul></li><li><a href="module-server_database_store-adapter.html">server/database/store-adapter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_store-adapter.html#~ensureUserInitialized">ensureUserInitialized</a></li><li data-type='method' style='display: none;'><a href="module-server_database_store-adapter.html#~wrapStore">wrapStore</a></li></ul></li><li><a href="module-server_database_stores.html">server/database/stores</a></li><li><a href="module-server_database_stores_lookup-store.html">server/database/stores/lookup-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~buildLookup">buildLookup</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~buildLookupAsync">buildLookupAsync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~cancelBuild">cancelBuild</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~clearStore">clearStore</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~extractAllVesselsFromLog">extractAllVesselsFromLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~extractCashFromLog">extractCashFromLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~extractPerItemPriceFromLog">extractPerItemPriceFromLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~extractPriceFromLog">extractPriceFromLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~extractVesselFromLog">extractVesselFromLog</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getBreakdownByDay">getBreakdownByDay</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getBreakdownByType">getBreakdownByType</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getBuildStatus">getBuildStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getContextsFromAutopilot">getContextsFromAutopilot</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getEntries">getEntries</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getEntriesByDays">getEntriesByDays</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getEntryDetails">getEntryDetails</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getStoreInfo">getStoreInfo</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~getTotals">getTotals</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~loadPaged">loadPaged</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_lookup-store.html#~rematchPOD3">rematchPOD3</a></li></ul></li><li><a href="module-server_database_stores_port-demand-store.html">server/database/stores/port-demand-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~cleanupOldEntries">cleanupOldEntries</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~getLatestDemand">getLatestDemand</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~getPortHistory">getPortHistory</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~getPortTrends">getPortTrends</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~getStoreStats">getStoreStats</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_port-demand-store.html#~saveDemandSnapshot">saveDemandSnapshot</a></li></ul></li><li><a href="module-server_database_stores_transaction-store.html">server/database/stores/transaction-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~fetchFromAPI">fetchFromAPI</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~generateTransactionId">generateTransactionId</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getDailyBreakdown">getDailyBreakdown</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getStoreInfo">getStoreInfo</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getTransactionSummary">getTransactionSummary</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getTransactionTypes">getTransactionTypes</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getTransactions">getTransactions</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~getTransactionsByDays">getTransactionsByDays</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~startAutoSync">startAutoSync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~stopAutoSync">stopAutoSync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_transaction-store.html#~syncTransactions">syncTransactions</a></li></ul></li><li><a href="module-server_database_stores_vessel-history-store.html">server/database/stores/vessel-history-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~clearStore">clearStore</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~fetchAllVessels">fetchAllVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~fetchVesselHistory">fetchVesselHistory</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~generateDepartureId">generateDepartureId</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getDepartures">getDepartures</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getDeparturesBefore">getDeparturesBefore</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getDeparturesByDays">getDeparturesByDays</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getRouteHijackingRisks">getRouteHijackingRisks</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getStoreInfo">getStoreInfo</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getSyncProgress">getSyncProgress</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~getVesselTrips">getVesselTrips</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~loadSyncProgress">loadSyncProgress</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~migrateTankerCargo">migrateTankerCargo</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~parseGameDate">parseGameDate</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~saveSyncProgress">saveSyncProgress</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~startAutoSync">startAutoSync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~stopAutoSync">stopAutoSync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~stopSync">stopSync</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~syncNextVesselInRotation">syncNextVesselInRotation</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~syncSpecificVessels">syncSpecificVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_database_stores_vessel-history-store.html#~syncVesselHistory">syncVesselHistory</a></li></ul></li><li><a href="module-server_gameapi.html">server/gameapi</a></li><li><a href="module-server_gameapi_alliance.html">server/gameapi/alliance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_alliance.html#~fetchUserContribution">fetchUserContribution</a></li></ul></li><li><a href="module-server_gameapi_bunker.html">server/gameapi/bunker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_bunker.html#~fetchBunkerState">fetchBunkerState</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_bunker.html#~fetchPrices">fetchPrices</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_bunker.html#~purchaseCO2">purchaseCO2</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_bunker.html#~purchaseFuel">purchaseFuel</a></li></ul></li><li><a href="module-server_gameapi_campaign.html">server/gameapi/campaign</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_campaign.html#~activateCampaign">activateCampaign</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_campaign.html#~fetchCampaigns">fetchCampaigns</a></li></ul></li><li><a href="module-server_gameapi_maintenance.html">server/gameapi/maintenance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_maintenance.html#~bulkRepairVessels">bulkRepairVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_maintenance.html#~fetchRepairCount">fetchRepairCount</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_maintenance.html#~getMaintenanceCost">getMaintenanceCost</a></li></ul></li><li><a href="module-server_gameapi_port.html">server/gameapi/port</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_port.html#~fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_port.html#~fetchAutoPrice">fetchAutoPrice</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_port.html#~getAssignedPorts">getAssignedPorts</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_port.html#~getRoutesByPorts">getRoutesByPorts</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_port.html#~getVesselPorts">getVesselPorts</a></li></ul></li><li><a href="module-server_gameapi_util.html">server/gameapi/util</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_util.html#~fetchEventData">fetchEventData</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_util.html#~fetchUnreadMessages">fetchUnreadMessages</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_util.html#~getGameIndex">getGameIndex</a></li></ul></li><li><a href="module-server_gameapi_vessel.html">server/gameapi/vessel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_gameapi_vessel.html#~departVessel">departVessel</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_vessel.html#~fetchVessels">fetchVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_vessel.html#~getAllUserVessels">getAllUserVessels</a></li><li data-type='method' style='display: none;'><a href="module-server_gameapi_vessel.html#~getVesselHistory">getVesselHistory</a></li></ul></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-high-scores">GET /api/alliance-high-scores</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-info">GET /api/alliance-info</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-info/:id">GET /api/alliance-info/:id</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-members/:id">GET /api/alliance-members/:id</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/alliance-settings">GET /api/alliance-settings</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.GET/api/league-info">GET /api/league-info</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-accept-user">POST /api/alliance-accept-user</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-decline-user">POST /api/alliance-decline-user</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-exclude-user">POST /api/alliance-exclude-user</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-leave">POST /api/alliance-leave</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-queue-pool">POST /api/alliance-queue-pool</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/alliance-update-user-role">POST /api/alliance-update-user-role</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/chat/mark-read">POST /api/chat/mark-read</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_alliance-logo.html">server/routes/alliance-logo</a></li><li><a href="module-server_routes_alliances.html">server/routes/alliances</a></li><li><a href="module-server_routes_analytics.html">server/routes/analytics</a></li><li><a href="module-server_routes_anchor.html">server/routes/anchor</a></li><li><a href="module-server_routes_broadcast.html">server/routes/broadcast</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_broadcast.html#~ensureDirectory">ensureDirectory</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_broadcast.html#~getTemplatesFilePath">getTemplatesFilePath</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_broadcast.html#~loadTemplates">loadTemplates</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_broadcast.html#~saveTemplates">saveTemplates</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_coop.html#.POST/api/coop/send-max">POST /api/coop/send-max</a></li></ul></li><li><a href="module-server_routes_forecast.html">server/routes/forecast</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~convertCESTToTimezone">convertCESTToTimezone</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~generateChatbotText">generateChatbotText</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~generateMetadata">generateMetadata</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getDaysInMonth">getDaysInMonth</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getForecastDataPath">getForecastDataPath</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getMonthForDay">getMonthForDay</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getNextDayData">getNextDayData</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getPreviousDayData">getPreviousDayData</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getServerLocalTimezone">getServerLocalTimezone</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getTimezoneOffsetHours">getTimezoneOffsetHours</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~getValidTimezones">getValidTimezones</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_forecast.html#~parseNumericOffset">parseNumericOffset</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_game_autopilot.html">server/routes/game/autopilot</a></li><li><a href="module-server_routes_game_bunker.html">server/routes/game/bunker</a></li><li><a href="module-server_routes_game_depart.html">server/routes/game/depart</a></li><li><a href="module-server_routes_game_maintenance.html">server/routes/game/maintenance</a></li><li><a href="module-server_routes_game_marketing.html">server/routes/game/marketing</a></li><li><a href="module-server_routes_game_user.html">server/routes/game/user</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_game_user.html#~compareVersions">compareVersions</a></li></ul></li><li><a href="module-server_routes_game_vessel.html">server/routes/game/vessel</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_game_vessel.html#~refreshAndBroadcastHeader">refreshAndBroadcastHeader</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_game_vessel.html#~validateImageData">validateImageData</a></li></ul></li><li><a href="module-server_routes_harbor-map.html">server/routes/harbor-map</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_harbor-map.html#~escapeCSVFormula">escapeCSVFormula</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_harbor-map.html#~formatHistoryAsTXT">formatHistoryAsTXT</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_harbor-map.html#~getGameIndexCached">getGameIndexCached</a></li></ul></li><li><a href="module-server_routes_health.html">server/routes/health</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.GET/api/hijacking/get-cases">GET /api/hijacking/get-cases</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_messenger.html#.POST/api/user/search">POST /api/user/search</a></li></ul></li><li><a href="module-server_routes_poi.html">server/routes/poi</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~ensureCacheDir">ensureCacheDir</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~fetchAllMuseumsFromAPI">fetchAllMuseumsFromAPI</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~fetchAllWrecksFromAPI">fetchAllWrecksFromAPI</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~filterPOIsByBbox">filterPOIsByBbox</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~initializePOICache">initializePOICache</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~isCacheValid">isCacheValid</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~loadFromCache">loadFromCache</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~reduceWreckData">reduceWreckData</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~saveToCache">saveToCache</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_poi.html#~startAutomaticCacheRefresh">startAutomaticCacheRefresh</a></li></ul></li><li><a href="module-server_routes_route-planner.html">server/routes/route-planner</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_route-planner.html#~calculateRouteCreationFee">calculateRouteCreationFee</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_route-planner.html#~getRouteFeeDiscountMultiplier">getRouteFeeDiscountMultiplier</a></li></ul></li><li><a href="module-server_routes_server-config.html">server/routes/server-config</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_server-config.html#~getDirectoryStats">getDirectoryStats</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_routes_staff.html">server/routes/staff</a></li><li><a href="module-server_routes_stock.html">server/routes/stock</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.GET/api/stock/check-company-age">GET /api/stock/check-company-age</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.GET/api/stock/finance-overview">GET /api/stock/finance-overview</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.GET/api/stock/market">GET /api/stock/market</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.GET/api/stock/purchase-times">GET /api/stock/purchase-times</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.GET/api/stock/recent-ipos">GET /api/stock/recent-ipos</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.POST/api/stock/increase-stock-for-sale">POST /api/stock/increase-stock-for-sale</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.POST/api/stock/purchase">POST /api/stock/purchase</a></li><li data-type='method' style='display: none;'><a href="module-server_routes_stock.html#.POST/api/stock/sell">POST /api/stock/sell</a></li></ul></li><li><a href="module-server_routes_transactions.html">server/routes/transactions</a></li><li><a href="module-server_routes_vessel-image.html">server/routes/vessel-image</a></li><li><a href="module-server_scheduler.html">server/scheduler</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_scheduler.html#~getInitError">getInitError</a></li><li data-type='method' style='display: none;'><a href="module-server_scheduler.html#~initScheduler">initScheduler</a></li><li data-type='method' style='display: none;'><a href="module-server_scheduler.html#~isServerReady">isServerReady</a></li></ul></li><li><a href="module-server_services_alliance-indexer.html">server/services/alliance-indexer</a></li><li><a href="module-server_services_port-demand-sync.html">server/services/port-demand-sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~fetchAndSavePort">fetchAndSavePort</a></li><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~getStatus">getStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~initPortCodes">initPortCodes</a></li><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~processNextBatch">processNextBatch</a></li><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~startSync">startSync</a></li><li data-type='method' style='display: none;'><a href="module-server_services_port-demand-sync.html#~stopSync">stopSync</a></li></ul></li><li><a href="module-server_settings-schema.html">server/settings-schema</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~getDefault">getDefault</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~getDefaults">getDefaults</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~getRequiredKeys">getRequiredKeys</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~getSettingsFilePath">getSettingsFilePath</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~initializeSettings">initializeSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~saveSettings">saveSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~validateSettings">validateSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_settings-schema.html#~validateValue">validateValue</a></li></ul></li><li><a href="module-server_state.html">server/state</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_state.html#~getAllLocks">getAllLocks</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getAutopilotState">getAutopilotState</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getBunkerState">getBunkerState</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getCampaignStatus">getCampaignStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getCoopData">getCoopData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getDrydockCount">getDrydockCount</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getEventData">getEventData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getHeaderData">getHeaderData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getLastCO2Alert">getLastCO2Alert</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getLastFuelAlert">getLastFuelAlert</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getLockStatus">getLockStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getPrices">getPrices</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getRepairCount">getRepairCount</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getSettings">getSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getStaffData">getStaffData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getUserState">getUserState</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~getVesselCounts">getVesselCounts</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~isAutopilotPaused">isAutopilotPaused</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~setAutopilotPaused">setAutopilotPaused</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~setAutopilotState">setAutopilotState</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~setLastCO2Alert">setLastCO2Alert</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~setLastFuelAlert">setLastFuelAlert</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~setLockStatus">setLockStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateBunkerState">updateBunkerState</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateCampaignStatus">updateCampaignStatus</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateCoopData">updateCoopData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateDrydockCount">updateDrydockCount</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateEventData">updateEventData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateHeaderData">updateHeaderData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updatePrices">updatePrices</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateRepairCount">updateRepairCount</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateSettings">updateSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateStaffData">updateStaffData</a></li><li data-type='method' style='display: none;'><a href="module-server_state.html#~updateVesselCounts">updateVesselCounts</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~apiCallWithRetry">apiCallWithRetry</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~checkAndUpdateAllianceId">checkAndUpdateAllianceId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getAllianceName">getAllianceName</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~setAllianceId">setAllianceId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_api.html#~sleep">sleep</a></li></ul></li><li><a href="module-server_utils_audit-logger.html">server/utils/audit-logger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_audit-logger.html#~auditLog">auditLog</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_audit-logger.html#~formatCurrency">formatCurrency</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_audit-logger.html#~formatNumber">formatNumber</a></li></ul></li><li><a href="module-server_utils_encryption.html">server/utils/encryption</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~cleanupOldCredentials">cleanupOldCredentials</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~decryptData">decryptData</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~deleteEncryptedData">deleteEncryptedData</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~encryptData">encryptData</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~getEncryptionInfo">getEncryptionInfo</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_encryption.html#~isEncrypted">isEncrypted</a></li></ul></li><li><a href="module-server_utils_fuel-calculator.html">server/utils/fuel-calculator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~calculateCO2Consumption">calculateCO2Consumption</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~calculateFuelConsumption">calculateFuelConsumption</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~calculateFuelFromFormula">calculateFuelFromFormula</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~getFuelConsumptionDisplay">getFuelConsumptionDisplay</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~getVesselCapacityForFormula">getVesselCapacityForFormula</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_fuel-calculator.html#~getVesselFuelData">getVesselFuelData</a></li></ul></li><li><a href="module-server_utils_ipo-tracker.html">server/utils/ipo-tracker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~getHighestSeenUserId">getHighestSeenUserId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~getLegacyJsonPath">getLegacyJsonPath</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~getSeenIpoUserIds">getSeenIpoUserIds</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~hasSeenIpo">hasSeenIpo</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~initializeWithIpos">initializeWithIpos</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~isFirstCheck">isFirstCheck</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~loadIpoTracking">loadIpoTracking</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~markIpoAsSeen">markIpoAsSeen</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~migrateFromJson">migrateFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_ipo-tracker.html#~saveIpoTracking">saveIpoTracking</a></li></ul></li><li><a href="module-server_utils_logger.html">server/utils/logger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~debug">debug</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~error">error</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~getUserIdPrefix">getUserIdPrefix</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~info">info</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~isDebugMode">isDebugMode</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~loadLogLevel">loadLogLevel</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_logger.html#~warn">warn</a></li></ul></li><li><a href="module-server_utils_migrate-harbor-fees.html">server/utils/migrate-harbor-fees</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_migrate-harbor-fees.html#~migrateAllHarborFees">migrateAllHarborFees</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_migrate-harbor-fees.html#~migrateHarborFeesForUser">migrateHarborFeesForUser</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_migrate-harbor-fees.html#~resolveVesselNameToId">resolveVesselNameToId</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_migrate-harbor-fees.html#~timestampToMySQLDatetime">timestampToMySQLDatetime</a></li></ul></li><li><a href="module-server_utils_read-tracker.html">server/utils/read-tracker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_read-tracker.html#~getLastReadTimestamp">getLastReadTimestamp</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_read-tracker.html#~getLegacyJsonPath">getLegacyJsonPath</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_read-tracker.html#~migrateFromJson">migrateFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_read-tracker.html#~updateLastReadTimestamp">updateLastReadTimestamp</a></li></ul></li><li><a href="module-server_utils_session-manager.html">server/utils/session-manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~findAvailablePort">findAvailablePort</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~getAllUserIds">getAllUserIds</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~getAvailableSessions">getAvailableSessions</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~getFirstValidSession">getFirstValidSession</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~hasSession">hasSession</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~isPortAvailable">isPortAvailable</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~migrateToEncrypted">migrateToEncrypted</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~migrateToNormalizedCookies">migrateToNormalizedCookies</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~normalizeCookie">normalizeCookie</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~saveSession">saveSession</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~setAutostart">setAutostart</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~setPort">setPort</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_session-manager.html#~validateSessionCookie">validateSessionCookie</a></li></ul></li><li><a href="module-server_utils_settings-migrator.html">server/utils/settings-migrator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_settings-migrator.html#~getGlobalSettingsFromDb">getGlobalSettingsFromDb</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_settings-migrator.html#~getSettingsDir">getSettingsDir</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_settings-migrator.html#~migrateAllSettings">migrateAllSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_settings-migrator.html#~migrateGlobalSettings">migrateGlobalSettings</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_settings-migrator.html#~migrateUserSettings">migrateUserSettings</a></li></ul></li><li><a href="module-server_utils_telegram.html">server/utils/telegram</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_telegram.html#~checkGreenPrices">checkGreenPrices</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_telegram.html#~sendPriceAlert">sendPriceAlert</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_telegram.html#~sendTelegramMessage">sendTelegramMessage</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_telegram.html#~testTelegramConnection">testTelegramConnection</a></li></ul></li><li><a href="module-server_utils_trip-data-store.html">server/utils/trip-data-store</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~enrichHistoryWithTripData">enrichHistoryWithTripData</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~findLookupDataFuzzy">findLookupDataFuzzy</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~findTripDataFuzzy">findTripDataFuzzy</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~getTripData">getTripData</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~migrateFromOldStores">migrateFromOldStores</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~saveHarborFee">saveHarborFee</a></li><li data-type='method' style='display: none;'><a href="module-server_utils_trip-data-store.html#~saveTripData">saveTripData</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li></ul></li><li><a href="module-server_websocket_broadcaster.html">server/websocket/broadcaster</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~broadcast">broadcast</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~broadcastBunkerUpdate">broadcastBunkerUpdate</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~broadcastHarborMapRefresh">broadcastHarborMapRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~broadcastToUser">broadcastToUser</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~getWebSocketServer">getWebSocketServer</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_broadcaster.html#~setWebSocketServer">setWebSocketServer</a></li></ul></li><li><a href="module-server_websocket_chat-refresh.html">server/websocket/chat-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_chat-refresh.html#~performChatRefresh">performChatRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_chat-refresh.html#~setMessengerRefreshFn">setMessengerRefreshFn</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_chat-refresh.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_chat-refresh.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_chat-refresh.html#~triggerImmediateChatRefresh">triggerImmediateChatRefresh</a></li></ul></li><li><a href="module-server_websocket_hijacking-cache.html">server/websocket/hijacking-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~getCachedHijackingCase">getCachedHijackingCase</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~invalidateHijackingCase">invalidateHijackingCase</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~markCaseResolved">markCaseResolved</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~readLocalCaseFromDb">readLocalCaseFromDb</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~saveLocalCaseToDb">saveLocalCaseToDb</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~saveNegotiationEvent">saveNegotiationEvent</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-cache.html#~updateCaseVesselInfo">updateCaseVesselInfo</a></li></ul></li><li><a href="module-server_websocket_hijacking-refresh.html">server/websocket/hijacking-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-refresh.html#~performHijackingRefresh">performHijackingRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-refresh.html#~startHijackingAutoRefresh">startHijackingAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-refresh.html#~stopHijackingAutoRefresh">stopHijackingAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_hijacking-refresh.html#~triggerImmediateHijackingRefresh">triggerImmediateHijackingRefresh</a></li></ul></li><li><a href="module-server_websocket_ipo-refresh.html">server/websocket/ipo-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~getFreshIpos">getFreshIpos</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~performIpoRefresh">performIpoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~resetIpoCache">resetIpoCache</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~sendToAllianceChat">sendToAllianceChat</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~startIpoAutoRefresh">startIpoAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~stopIpoAutoRefresh">stopIpoAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_ipo-refresh.html#~triggerImmediateIpoRefresh">triggerImmediateIpoRefresh</a></li></ul></li><li><a href="module-server_websocket_message-cache.html">server/websocket/message-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~addProcessedMessageId">addProcessedMessageId</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~getLegacyJsonPath">getLegacyJsonPath</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~getProcessedMessageIds">getProcessedMessageIds</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~isMessageProcessed">isMessageProcessed</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~loadProcessedMessageCache">loadProcessedMessageCache</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~migrateFromJson">migrateFromJson</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_message-cache.html#~saveProcessedMessageCache">saveProcessedMessageCache</a></li></ul></li><li><a href="module-server_websocket_messenger-cache.html">server/websocket/messenger-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-cache.html#~getCachedMessengerChats">getCachedMessengerChats</a></li></ul></li><li><a href="module-server_websocket_messenger-content-cache.html">server/websocket/messenger-content-cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~deleteChatFromCache">deleteChatFromCache</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~getCacheStats">getCacheStats</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~getCachedChatList">getCachedChatList</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~getCachedChatMessages">getCachedChatMessages</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~hasNewMessages">hasNewMessages</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~loadChatListFromDb">loadChatListFromDb</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~loadMessengerCache">loadMessengerCache</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~markChatAsReadInCache">markChatAsReadInCache</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~updateChatList">updateChatList</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-content-cache.html#~updateChatMessages">updateChatMessages</a></li></ul></li><li><a href="module-server_websocket_messenger-refresh.html">server/websocket/messenger-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-refresh.html#~performMessengerRefresh">performMessengerRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-refresh.html#~startMessengerAutoRefresh">startMessengerAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-refresh.html#~stopMessengerAutoRefresh">stopMessengerAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_messenger-refresh.html#~triggerImmediateMessengerRefresh">triggerImmediateMessengerRefresh</a></li></ul></li><li><a href="module-server_websocket_staff-refresh.html">server/websocket/staff-refresh</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-server_websocket_staff-refresh.html#~performStaffRefresh">performStaffRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_staff-refresh.html#~startStaffAutoRefresh">startStaffAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_staff-refresh.html#~stopStaffAutoRefresh">stopStaffAutoRefresh</a></li><li data-type='method' style='display: none;'><a href="module-server_websocket_staff-refresh.html#~triggerImmediateStaffRefresh">triggerImmediateStaffRefresh</a></li></ul></li><li><a href="module-stock-manager.html">stock-manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.calculatePriceStats">calculatePriceStats</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.closeStockManager">closeStockManager</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.initStockManager">initStockManager</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.initializeChart">initializeChart</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.openCompanyDetail">openCompanyDetail</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.renderChartSection">renderChartSection</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.showBuyDialog">showBuyDialog</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.showSellDialog">showSellDialog</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.showStockManager">showStockManager</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#.showStockManagerIpoAlerts">showStockManagerIpoAlerts</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~calculateMA">calculateMA</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~calculateSharePriceTier">calculateSharePriceTier</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~closeCompanyDetail">closeCompanyDetail</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~createEnhancedChart">createEnhancedChart</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~createMASeries">createMASeries</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~createMarketRow">createMarketRow</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~createTierRow">createTierRow</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~destroyChart">destroyChart</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~escapeHtml">escapeHtml</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~estimatePurchaseDateFromPrice">estimatePurchaseDateFromPrice</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~filterDataByTimeframe">filterDataByTimeframe</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~formatPurchaseDate">formatPurchaseDate</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~generateMarketRowHtml">generateMarketRowHtml</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~handleIncreaseSharesClick">handleIncreaseSharesClick</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~initTooltipSystem">initTooltipSystem</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadInvestments">loadInvestments</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadInvestors">loadInvestors</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadIpoAlerts">loadIpoAlerts</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadMarket">loadMarket</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadMarketList">loadMarketList</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadMoreMarketItems">loadMoreMarketItems</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~loadPortfolio">loadPortfolio</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~refreshIpoAlertTab">refreshIpoAlertTab</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~renderIpoAlertsTable">renderIpoAlertsTable</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~resetMarketState">resetMarketState</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupChartToolbar">setupChartToolbar</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupCompanyNameClickHandlers">setupCompanyNameClickHandlers</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupInvestmentSellButtons">setupInvestmentSellButtons</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupMarketRowClickHandlers">setupMarketRowClickHandlers</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupMarketScrollHandler">setupMarketScrollHandler</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~setupTooltips">setupTooltips</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~showIncreaseSharesModal">showIncreaseSharesModal</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~switchTab">switchTab</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~updateChart">updateChart</a></li><li data-type='method' style='display: none;'><a href="module-stock-manager.html#~updateMovingAverages">updateMovingAverages</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.showPurchaseDialog">showPurchaseDialog</a></li><li data-type='method' style='display: none;'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.formatCompactNumber">formatCompactNumber</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.getCO2PriceClass">getCO2PriceClass</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.getFuelPriceClass">getFuelPriceClass</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.isMobileDevice">isMobileDevice</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.loadBackupInfo">loadBackupInfo</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.loadServerConfig">loadServerConfig</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#.toGameCode">toGameCode</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#~formatFileSize">formatFileSize</a></li><li data-type='method' style='display: none;'><a href="module-utils.html#~updateHostInfo">updateHostInfo</a></li></ul></li><li><a href="module-vessel-appearance-editor.html">vessel-appearance-editor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#.getVesselImageOnerror">getVesselImageOnerror</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#.handleVesselImageError">handleVesselImageError</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#.initVesselAppearanceEditor">initVesselAppearanceEditor</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#.openAppearanceEditor">openAppearanceEditor</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~buildSvgUrl">buildSvgUrl</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~closeAppearanceEditor">closeAppearanceEditor</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~getFormData">getFormData</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~handleImageSelection">handleImageSelection</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~handleRemoveCustomImage">handleRemoveCustomImage</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~resetColorValues">resetColorValues</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~resizeImage">resizeImage</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~saveAppearance">saveAppearance</a></li><li data-type='method' style='display: none;'><a href="module-vessel-appearance-editor.html#~updateSvgPreview">updateSvgPreview</a></li></ul></li><li><a href="module-vessel-building.html">vessel-building</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-vessel-building.html#.initBuildShipModal">initBuildShipModal</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#.openBuildShipModal">openBuildShipModal</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~applyPerkEffects">applyPerkEffects</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~buildPreviewUrl">buildPreviewUrl</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~calculateBaseRangeFromCapacity">calculateBaseRangeFromCapacity</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~calculateBaseStats">calculateBaseStats</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~calculateGameBaseSpeed">calculateGameBaseSpeed</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~calculatePrice">calculatePrice</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~calculateSpeedForEngine">calculateSpeedForEngine</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~closeBuildShipModal">closeBuildShipModal</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~formatBuildTime">formatBuildTime</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~interpolate">interpolate</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~nextStep">nextStep</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~prevStep">prevStep</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~renderCurrentStep">renderCurrentStep</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~renderStep1">renderStep1</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~renderStep3">renderStep3</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~renderStep4">renderStep4</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~renderStep5">renderStep5</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~submitBuild">submitBuild</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~updateStatsPreview">updateStatsPreview</a></li><li data-type='method' style='display: none;'><a href="module-vessel-building.html#~updateSvgPreview">updateSvgPreview</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#.openRepairAndDrydockDialog">openRepairAndDrydockDialog</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#.updateLockStateFromServer">updateLockStateFromServer</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~createVesselCard">createVesselCard</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~displayFilteredVessels">displayFilteredVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~executeDrydock">executeDrydock</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~getAvailableAnchorSlots">getAvailableAnchorSlots</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~loadCartFromStorage">loadCartFromStorage</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~loadMorePendingVessels">loadMorePendingVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~loadMoreVessels">loadMoreVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~populateDynamicFilters">populateDynamicFilters</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~renderDrydockTab">renderDrydockTab</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~renderRepairTab">renderRepairTab</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~saveCartToStorage">saveCartToStorage</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~showRepairAndDrydockDialog">showRepairAndDrydockDialog</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~updateCapacityDropdowns">updateCapacityDropdowns</a></li><li data-type='method' style='display: none;'><a href="module-vessel-management.html#~vesselPassesFilters">vesselPassesFilters</a></li></ul></li><li><a href="module-vessel-selling.html">vessel-selling</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.bulkSellVessels">bulkSellVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.closeSellVesselsOverlay">closeSellVesselsOverlay</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.openSellVesselsOverlay">openSellVesselsOverlay</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.refreshVesselsForSale">refreshVesselsForSale</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.setSellFilter">setSellFilter</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#.showSellCart">showSellCart</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~clearSellCartCache">clearSellCartCache</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~displaySellVessels">displaySellVessels</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~fetchAllSellPrices">fetchAllSellPrices</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~getCO2EfficiencyClass">getCO2EfficiencyClass</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~getCapacityDisplay">getCapacityDisplay</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~getFuelEfficiencyClass">getFuelEfficiencyClass</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~groupVesselsByModel">groupVesselsByModel</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~loadSellCartFromCache">loadSellCartFromCache</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~loadUserVesselsForSale">loadUserVesselsForSale</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~removeVesselSelectionFromCart">removeVesselSelectionFromCart</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~saveSellCartToCache">saveSellCartToCache</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~updateBulkSellButton">updateBulkSellButton</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~updateSelectButtonState">updateSelectButtonState</a></li><li data-type='method' style='display: none;'><a href="module-vessel-selling.html#~updateVesselSelectionInCart">updateVesselSelectionInCart</a></li></ul></li></ul></li><li class="nav-list-toggle"><a>Global</a><ul style="display: none;"><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#deleteAllLogs">deleteAllLogs</a></li><li><a href="global.html#escapeCSVFormula">escapeCSVFormula</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#extractAllVesselsFromLog">extractAllVesselsFromLog</a></li><li><a href="global.html#extractCashFromLog">extractCashFromLog</a></li><li><a href="global.html#extractPerItemPriceFromLog">extractPerItemPriceFromLog</a></li><li><a href="global.html#extractPriceFromLog">extractPriceFromLog</a></li><li><a href="global.html#extractVesselFromLog">extractVesselFromLog</a></li><li><a href="global.html#flushAllToDisk">flushAllToDisk</a></li><li><a href="global.html#formatDetailsAsTXT">formatDetailsAsTXT</a></li><li><a href="global.html#formatFileSize">formatFileSize</a></li><li><a href="global.html#formatLogsAsCSV">formatLogsAsCSV</a></li><li><a href="global.html#formatLogsAsTXT">formatLogsAsTXT</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#generateContainerSvg">generateContainerSvg</a></li><li><a href="global.html#generateTankerSvg">generateTankerSvg</a></li><li><a href="global.html#generateVesselSvg">generateVesselSvg</a></li><li><a href="global.html#getCategoryFromAction">getCategoryFromAction</a></li><li><a href="global.html#getContextsFromAutopilot">getContextsFromAutopilot</a></li><li><a href="global.html#getLogCount">getLogCount</a></li><li><a href="global.html#getLogEntries">getLogEntries</a></li><li><a href="global.html#getLogFileSize">getLogFileSize</a></li><li><a href="global.html#getPublicBaseDir">getPublicBaseDir</a></li><li><a href="global.html#getSourceFromAction">getSourceFromAction</a></li><li><a href="global.html#getTransactionType">getTransactionType</a></li><li><a href="global.html#isContainerVessel">isContainerVessel</a></li><li><a href="global.html#isDepartInProgress">isDepartInProgress</a></li><li><a href="global.html#loadBaseContainerSvg">loadBaseContainerSvg</a></li><li><a href="global.html#loadBaseTankerSvg">loadBaseTankerSvg</a></li><li><a href="global.html#lockBulkBuyButton">lockBulkBuyButton</a></li><li><a href="global.html#lockCo2Button">lockCo2Button</a></li><li><a href="global.html#lockCoopButtons">lockCoopButtons</a></li><li><a href="global.html#lockDepartButton">lockDepartButton</a></li><li><a href="global.html#lockDrydockButton">lockDrydockButton</a></li><li><a href="global.html#lockFuelButton">lockFuelButton</a></li><li><a href="global.html#lockRepairButton">lockRepairButton</a></li><li><a href="global.html#logAutopilotAction">logAutopilotAction</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#searchInObject">searchInObject</a></li><li><a href="global.html#showAnchorTimer">showAnchorTimer</a></li><li><a href="global.html#shutdown">shutdown</a></li><li><a href="global.html#unlockBulkBuyButton">unlockBulkBuyButton</a></li><li><a href="global.html#unlockCo2Button">unlockCo2Button</a></li><li><a href="global.html#unlockCoopButtons">unlockCoopButtons</a></li><li><a href="global.html#unlockDepartButton">unlockDepartButton</a></li><li><a href="global.html#unlockDrydockButton">unlockDrydockButton</a></li><li><a href="global.html#unlockFuelButton">unlockFuelButton</a></li><li><a href="global.html#unlockRepairButton">unlockRepairButton</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/analytics.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Analytics Dashboard Module
 *
 * Business intelligence dashboard showing:
 * - Weekly cash flow summary (revenue, expenses, profit)
 * - Detailed expense breakdown by category
 * - Vessel performance metrics
 * - Route profitability analysis
 * - Route contribution analysis
 * - Revenue trend chart (using TradingView Lightweight Charts)
 *
 * @module analytics
 */

import { getAnalyticsOverview, getAnalyticsVessels, getAnalyticsRoutes, getLookupEntries, getLookupAll, getLookupInfo, getLookupBuildStatus, getLookupDetails, checkDevelMode, getApiStats, getApiStatsDates, getPortDemandStatus, getPortDemandHistory } from './api.js';
import { escapeHtml, showNotification, formatNumber, toGameCode } from './utils.js';
import logger from './core/logger.js';

// State
let analyticsData = null;
let lookupData = null; // Used for export
let currentDays = null;
let trendChart = null;
let isDevelMode = false;
let apiStatsChart = null;

// Cache TTL in milliseconds (1 minute)
const CACHE_TTL = 60000;

// Lazy loading state for tabs with timestamps
const lazyLoadState = {
  vessels: { loaded: false, loading: false, loadedAt: 0 },
  routes: { loaded: false, loading: false, loadedAt: 0 },
  overview: { loaded: false, loading: false, loadedAt: 0 },
  ports: { loaded: false, loading: false, loadedAt: 0 }
};

// Sort state for tables
const sortState = {
  vessels: { column: 'totalRevenue', direction: 'desc' },
  routes: { column: 'avgRevenuePerHour', direction: 'desc' }
};

// Route filter state (which route types to show)
const routeFilterState = {
  showActive: true,
  showInactive: true
};

// Vessel filter state (owned vs sold)
const vesselFilterState = {
  showOwned: true,
  showSold: true
};

// Raw transactions lazy loading state
const rawTransactionState = {
  transactions: [],
  offset: 0,
  limit: 50,
  total: 0,
  sortBy: 'time',
  sortDir: 'desc',
  loading: false,
  observer: null,
  hasMore: true
};

/**
 * Check if cache is still valid (within TTL)
 * @param {number} loadedAt - Timestamp when data was loaded
 * @returns {boolean} True if cache is still valid
 */
function isCacheValid(loadedAt) {
  return loadedAt > 0 &amp;&amp; (Date.now() - loadedAt) &lt; CACHE_TTL;
}

/**
 * Format currency with $ sign and K/M suffixes
 * @param {number} amount - Amount to format
 * @param {boolean} showSign - Show + sign for positive
 * @returns {string} Formatted amount
 */
function formatCurrency(amount, showSign = false) {
  const sign = showSign &amp;&amp; amount > 0 ? '+' : '';
  const absAmount = Math.abs(amount);

  if (absAmount >= 1000000) {
    return `${sign}$${(amount / 1000000).toFixed(2)}M`;
  } else if (absAmount >= 1000) {
    return `${sign}$${(amount / 1000).toFixed(1)}K`;
  }
  return `${sign}$${formatNumber(Math.round(amount))}`;
}

/**
 * Format percentage
 * @param {number} value - Percentage value
 * @returns {string} Formatted percentage
 */
function formatPercent(value) {
  return `${value.toFixed(1)}%`;
}

/**
 * Check if lookup store needs building and handle the build process
 * Shows full-modal overlay during build, polls for completion
 * Also checks for background builds (from server startup) and waits for them
 * @returns {Promise&lt;boolean>} True if build was needed/in-progress
 */
async function checkAndBuildIndex() {
  const buildingOverlay = document.getElementById('analyticsIndexBuilding');
  const statusEl = document.getElementById('analyticsIndexStatus');
  const tabsEl = document.querySelector('.analytics-tabs');
  const loadingEl = document.getElementById('analyticsLoading');
  const contentEl = document.getElementById('analyticsContent');

  try {
    // First check if a background build is already in progress (from server startup)
    const buildStatus = await getLookupBuildStatus();

    if (buildStatus.building) {
      // Background build in progress - show overlay and poll until complete
      if (buildingOverlay) buildingOverlay.classList.remove('hidden');
      if (tabsEl) tabsEl.style.display = 'none';
      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.add('hidden');

      // Poll for build completion
      while (true) {
        const currentStatus = await getLookupBuildStatus();

        if (!currentStatus.building) {
          // Build complete
          if (statusEl) statusEl.textContent = 'Index ready!';
          await new Promise(resolve => setTimeout(resolve, 300));
          break;
        }

        // Update progress
        const percent = currentStatus.total > 0
          ? Math.round((currentStatus.progress / currentStatus.total) * 100)
          : 0;
        if (statusEl) {
          statusEl.textContent = `Processing ${currentStatus.progress.toLocaleString()} of ${currentStatus.total.toLocaleString()} entries (${percent}%)...`;
        }

        // Wait before next poll
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Hide overlay, show normal UI
      if (buildingOverlay) buildingOverlay.classList.add('hidden');
      if (tabsEl) tabsEl.style.display = '';

      // Now load the analytics data
      await loadAnalyticsData();

      return true;
    }

    // Check if lookup store has data and is up-to-date
    const info = await getLookupInfo();

    // If we have data and version is current, no build needed
    if (info.lastSync &amp;&amp; info.totalEntries > 0 &amp;&amp; !info.needsRebuild) {
      return false;
    }

    // Need to build - show full overlay, hide everything else
    if (buildingOverlay) buildingOverlay.classList.remove('hidden');
    if (tabsEl) tabsEl.style.display = 'none';
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.add('hidden');

    // Show appropriate message
    if (info.needsRebuild) {
      if (statusEl) statusEl.textContent = 'Upgrading index to new version...';
    } else {
      if (statusEl) statusEl.textContent = 'Starting index build...';
    }

    // Trigger rebuild
    const rebuildResponse = await fetch(window.apiUrl('/api/analytics/lookup/rebuild'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ days: 0 })
    });

    if (!rebuildResponse.ok) {
      const errorData = await rebuildResponse.json().catch(() => ({}));
      throw new Error(errorData.error || 'Rebuild failed');
    }

    const result = await rebuildResponse.json();

    if (statusEl) {
      statusEl.textContent = `Index built: ${result.lookup?.newEntries || 0} entries`;
    }

    // Small delay to show success message
    await new Promise(resolve => setTimeout(resolve, 500));

    // Hide overlay, show normal UI
    if (buildingOverlay) buildingOverlay.classList.add('hidden');
    if (tabsEl) tabsEl.style.display = '';

    // Now load the analytics data
    await loadAnalyticsData();

    return true;
  } catch (error) {
    console.error('[Analytics] Failed to check/build index:', error);

    // Hide overlay and show error
    if (buildingOverlay) buildingOverlay.classList.add('hidden');
    if (tabsEl) tabsEl.style.display = '';

    showNotification('Failed to build transaction index: ' + error.message, 'error');
    return false;
  }
}

/**
 * Update the filter name display based on selected period
 * @param {HTMLSelectElement} selectEl - The period select element
 */
function updateFilterName(selectEl) {
  const filterNameEl = document.getElementById('analytics-filter-name');
  if (filterNameEl &amp;&amp; selectEl) {
    const selectedOption = selectEl.options[selectEl.selectedIndex];
    filterNameEl.textContent = selectedOption ? selectedOption.text : 'All Time';
  }
}

/**
 * Initialize the analytics module
 */
export function initAnalytics() {
  const overlay = document.getElementById('analyticsOverlay');
  const closeBtn = document.getElementById('analyticsCloseBtn');
  const periodSelect = document.getElementById('analyticsPeriodSelect');
  const refreshBtn = document.getElementById('analyticsRefreshBtn');

  if (!overlay) {
    console.warn('[Analytics] Overlay not found');
    return;
  }

  // Expose function to open analytics
  window.showAnalytics = async () => {
    overlay.classList.remove('hidden');

    // Check if we need to build the index first
    const needsBuild = await checkAndBuildIndex();
    if (!needsBuild) {
      // Index exists, load normally
      await loadAnalyticsData();
    }
    // If needsBuild was true, loadAnalyticsData is called after build completes
  };

  // Close button
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      overlay.classList.add('hidden');
      destroyChart();
    });
  }

  // Period selector - read initial value from DOM
  if (periodSelect) {
    currentDays = parseInt(periodSelect.value, 10);
    periodSelect.addEventListener('change', async (e) => {
      currentDays = parseInt(e.target.value, 10);
      updateFilterName(periodSelect);
      // Invalidate all cached data so it reloads with new days
      lookupData = null;
      lazyLoadState.overview.loadedAt = 0;
      lazyLoadState.vessels.loadedAt = 0;
      lazyLoadState.routes.loadedAt = 0;
      // Clear cached analyticsData for vessels and routes
      if (analyticsData) {
        analyticsData.vessels = null;
        analyticsData.routes = null;
      }
      await loadAnalyticsData();
      // Reload active tab data
      const gameLogTab = document.getElementById('analytics-game-log');
      const vesselsTab = document.getElementById('analytics-vessels');
      const routesTab = document.getElementById('analytics-routes');
      if (gameLogTab &amp;&amp; !gameLogTab.classList.contains('hidden')) {
        await loadGameLogData();
      }
      if (vesselsTab &amp;&amp; !vesselsTab.classList.contains('hidden')) {
        await lazyLoadVessels();
      }
      if (routesTab &amp;&amp; !routesTab.classList.contains('hidden')) {
        await lazyLoadRoutes();
      }
      // Reload ports chart if tab is active and a port is selected
      const portsTab = document.getElementById('analytics-ports');
      if (portsTab &amp;&amp; !portsTab.classList.contains('hidden')) {
        const portSelect = document.getElementById('portDemandPortSelect');
        if (portSelect &amp;&amp; portSelect.value) {
          await loadPortDemandChart(portSelect.value);
        }
      }
    });
    // Set initial filter name
    updateFilterName(periodSelect);
  }

  // Refresh button
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      // Invalidate all cached data to force reload
      lookupData = null;
      lazyLoadState.overview.loadedAt = 0;
      lazyLoadState.vessels.loadedAt = 0;
      lazyLoadState.routes.loadedAt = 0;
      // Clear cached analyticsData for vessels and routes
      if (analyticsData) {
        analyticsData.vessels = null;
        analyticsData.routes = null;
      }
      await loadAnalyticsData();
      // Reload active tab data
      const gameLogTab = document.getElementById('analytics-game-log');
      const vesselsTab = document.getElementById('analytics-vessels');
      const routesTab = document.getElementById('analytics-routes');
      if (gameLogTab &amp;&amp; !gameLogTab.classList.contains('hidden')) {
        await loadGameLogData();
      }
      if (vesselsTab &amp;&amp; !vesselsTab.classList.contains('hidden')) {
        await lazyLoadVessels();
      }
      if (routesTab &amp;&amp; !routesTab.classList.contains('hidden')) {
        await lazyLoadRoutes();
      }
    });
  }

  // Export dropdown
  const exportBtn = document.getElementById('analyticsExportBtn');
  const exportMenu = document.getElementById('analyticsExportMenu');
  const exportTxt = document.getElementById('analyticsExportTxt');
  const exportCsv = document.getElementById('analyticsExportCsv');
  const exportJson = document.getElementById('analyticsExportJson');

  if (exportBtn &amp;&amp; exportMenu) {
    exportBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      exportMenu.classList.toggle('hidden');
    });

    // Close menu when clicking outside
    document.addEventListener('click', () => {
      exportMenu.classList.add('hidden');
    });

    exportMenu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  if (exportTxt) {
    exportTxt.addEventListener('click', () => {
      exportAnalyticsData('txt');
      exportMenu.classList.add('hidden');
    });
  }
  if (exportCsv) {
    exportCsv.addEventListener('click', () => {
      exportAnalyticsData('csv');
      exportMenu.classList.add('hidden');
    });
  }
  if (exportJson) {
    exportJson.addEventListener('click', () => {
      exportAnalyticsData('json');
      exportMenu.classList.add('hidden');
    });
  }

  // Tab navigation
  const tabBtns = document.querySelectorAll('.analytics-tab-btn');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;
      switchTab(tabId);
    });
  });

  // Check develMode and add API Stats tab if enabled
  checkDevelMode().then(enabled => {
    isDevelMode = enabled;
    if (enabled) {
      addApiStatsTab();
    }
  });

  // Game Log category filter (INCOME/EXPENSE)
  const categoryFilter = document.getElementById('game-log-category-filter');
  if (categoryFilter) {
    categoryFilter.addEventListener('change', () => {
      if (lookupData?.breakdown) {
        renderGameLogTable(lookupData.breakdown);
      }
      loadRawTransactions(true);
    });
  }

  // Game Log type filter (Departure, Repair, Fuel, etc.)
  const typeFilter = document.getElementById('game-log-type-filter');
  if (typeFilter) {
    typeFilter.addEventListener('change', () => {
      if (lookupData?.breakdown) {
        renderGameLogTable(lookupData.breakdown);
      }
      loadRawTransactions(true);
    });
  }

  // Initialize sortable table headers
  initSortableHeaders();

  // Vessel row click handler
  const vesselsTbody = document.getElementById('analytics-vessels-tbody');
  if (vesselsTbody) {
    vesselsTbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (row &amp;&amp; row.dataset.vesselId) {
        handleVesselClick(row.dataset.vesselId);
      }
    });
  }

  // Route row click handler
  const routesTbody = document.getElementById('analytics-routes-tbody');
  if (routesTbody) {
    routesTbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (row &amp;&amp; row.dataset.origin &amp;&amp; row.dataset.destination) {
        handleRouteClick(row.dataset.origin, row.dataset.destination);
      }
    });
  }

  // Route vessels info icon - shows explanation tooltip
  const routeVesselsInfo = document.getElementById('route-vessels-info');
  if (routeVesselsInfo) {
    routeVesselsInfo.addEventListener('click', (e) => {
      e.stopPropagation();
      showRouteVesselsInfoTooltip(routeVesselsInfo);
    });
  }

  // Route filter icons - toggle active/inactive route visibility
  const routeFilterActive = document.getElementById('route-filter-active');
  const routeFilterInactive = document.getElementById('route-filter-inactive');

  if (routeFilterActive) {
    routeFilterActive.addEventListener('click', (e) => {
      e.stopPropagation();
      routeFilterState.showActive = !routeFilterState.showActive;
      updateRouteFilterIcons();
      if (analyticsData?.routes) {
        renderRouteTable(sortData(analyticsData.routes, sortState.routes));
      }
    });
  }

  if (routeFilterInactive) {
    routeFilterInactive.addEventListener('click', (e) => {
      e.stopPropagation();
      routeFilterState.showInactive = !routeFilterState.showInactive;
      updateRouteFilterIcons();
      if (analyticsData?.routes) {
        renderRouteTable(sortData(analyticsData.routes, sortState.routes));
      }
    });
  }

  // Initialize filter icon states
  updateRouteFilterIcons();

  // Vessel filter icons - toggle owned/sold vessel visibility
  const vesselFilterOwned = document.getElementById('vessel-filter-owned');
  const vesselFilterSold = document.getElementById('vessel-filter-sold');

  if (vesselFilterOwned) {
    vesselFilterOwned.addEventListener('click', (e) => {
      e.stopPropagation();
      vesselFilterState.showOwned = !vesselFilterState.showOwned;
      updateVesselFilterIcons();
      if (analyticsData?.vessels) {
        renderVesselTable(sortData(analyticsData.vessels, sortState.vessels));
      }
    });
  }

  if (vesselFilterSold) {
    vesselFilterSold.addEventListener('click', (e) => {
      e.stopPropagation();
      vesselFilterState.showSold = !vesselFilterState.showSold;
      updateVesselFilterIcons();
      if (analyticsData?.vessels) {
        renderVesselTable(sortData(analyticsData.vessels, sortState.vessels));
      }
    });
  }

  // Initialize vessel filter icon states
  updateVesselFilterIcons();

  // Raw transaction row click handler
  const rawTbody = document.getElementById('game-log-raw-tbody');
  if (rawTbody) {
    rawTbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (row &amp;&amp; row.dataset.lookupId) {
        showLookupEntryDetails(row.dataset.lookupId);
      }
    });
  }

  // Raw transactions - Lazy loading with IntersectionObserver
  setupRawTransactionsLazyLoading();

  // Raw transactions table header sorting
  const rawTable = document.getElementById('game-log-raw-table');
  if (rawTable) {
    rawTable.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.sort;
        handleRawTransactionSort(column);
      });
    });
  }
}

/**
 * Handle vessel row click - open harbor map and show vessel panel
 * @param {string} vesselId - Vessel ID
 */
async function handleVesselClick(vesselId) {
  // Mark that we came from analytics so closing vessel panel returns here
  localStorage.setItem('returnToAnalytics', 'true');
  logger.debug('[Analytics] handleVesselClick - set returnToAnalytics=true for vesselId:', vesselId);

  // Check if vessel is sold (look up in analyticsData.vessels)
  let vesselData = null;
  if (analyticsData &amp;&amp; analyticsData.vessels) {
    vesselData = analyticsData.vessels.find(v => v.vesselId === parseInt(vesselId, 10));
  }

  const isSoldVessel = vesselData &amp;&amp; vesselData.isOwned === false;

  // Close analytics overlay
  const overlay = document.getElementById('analyticsOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
    destroyChart();
  }

  // Open harbor map overlay
  const harborMapOverlay = document.getElementById('harborMapOverlay');
  if (harborMapOverlay) {
    harborMapOverlay.classList.remove('hidden');
  }

  // For sold vessels, show special sold vessel panel with history only
  if (isSoldVessel) {
    logger.debug('[Analytics] Opening sold vessel panel for:', vesselId);
    try {
      await showSoldVesselPanel(parseInt(vesselId, 10), vesselData.name);
    } catch (error) {
      console.error('[Analytics] Failed to show sold vessel panel:', error);
      showNotification('Failed to load vessel history', 'error');
    }
    return;
  }

  // For owned vessels, try to select on harbor map
  if (window.harborMap &amp;&amp; typeof window.harborMap.selectVesselFromPort === 'function') {
    try {
      window.harborMap.selectVesselFromPort(parseInt(vesselId, 10));
    } catch (error) {
      console.error('[Analytics] Failed to select vessel:', error);
      showNotification(`Vessel ID: ${vesselId} - View on map`, 'info');
    }
  } else {
    showNotification(`Vessel ID: ${vesselId} - View on map`, 'info');
  }
}

/**
 * Show sold vessel panel with history only
 * Creates a simplified vessel panel for vessels that have been sold
 * @param {number} vesselId - Vessel ID
 * @param {string} vesselName - Vessel name
 */
async function showSoldVesselPanel(vesselId, vesselName) {
  const panel = document.getElementById('vessel-detail-panel');
  if (!panel) return;

  // Fetch vessel history from API
  let historyData = [];
  try {
    const response = await fetch(window.apiUrl(`/api/harbor-map/vessel/${vesselId}/history`));
    if (!response.ok) {
      throw new Error(`Failed to fetch vessel history: ${response.statusText}`);
    }
    const data = await response.json();
    historyData = data.history || [];
  } catch (error) {
    console.error('[Analytics] Error fetching sold vessel history:', error);
    historyData = [];
  }

  // Render simplified panel for sold vessels
  panel.innerHTML = `
    &lt;div class="panel-header">
      &lt;h3>
        &lt;span class="vessel-name-display">${escapeHtml(vesselName)}&lt;/span>
        &lt;span class="vessel-status sold" title="Sold" style="margin-left: 8px;">&amp;#x1F578;&amp;#xFE0F; Sold&lt;/span>
      &lt;/h3>
      &lt;button class="close-btn" onclick="window.analytics.closeSoldVesselPanel()">&lt;/button>
    &lt;/div>

    &lt;div class="panel-body">
      &lt;div class="vessel-info-section">
        &lt;p style="color: var(--color-text-secondary); font-style: italic; margin-bottom: 16px;">
          This vessel has been sold. Only trip history is available.
        &lt;/p>
      &lt;/div>

      &lt;div class="vessel-info-section vessel-history-section collapsible">
        &lt;h4 class="section-toggle" onclick="this.parentElement.classList.toggle('collapsed')">
          &lt;span class="toggle-icon">&lt;/span> Trip History
        &lt;/h4>
        &lt;div class="section-content">
          &lt;div id="vessel-history-loading">${historyData.length === 0 ? 'No trip history available' : ''}&lt;/div>
          &lt;div id="vessel-history-content">&lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  `;

  // Show panel
  panel.classList.add('active');

  // Render history if available
  if (historyData.length > 0) {
    renderSoldVesselHistory(historyData);
  }
}

/**
 * Render trip history for sold vessels
 * Simplified version without live vessel status updates
 * @param {Array} historyData - Array of trip history entries
 */
function renderSoldVesselHistory(historyData) {
  const contentEl = document.getElementById('vessel-history-content');
  if (!contentEl) return;

  // Reverse to show newest first
  const trips = historyData.reverse();

  // Format port name helper - uses game display codes (e.g., "US NYC")
  const formatPortName = (portCode) => {
    if (!portCode) return 'N/A';
    return escapeHtml(toGameCode(portCode));
  };

  // Format cargo helper
  const formatCargo = (cargo) => {
    if (!cargo) return 'N/A';
    if (typeof cargo === 'string') return escapeHtml(cargo);

    if (cargo.dry !== undefined || cargo.refrigerated !== undefined) {
      const dry = cargo.dry || 0;
      const ref = cargo.refrigerated || 0;
      return `${(dry + ref).toLocaleString()} TEU`;
    }

    if (cargo.fuel !== undefined || cargo.crude_oil !== undefined) {
      const fuel = cargo.fuel || 0;
      const crude = cargo.crude_oil || 0;
      return `${(fuel + crude).toLocaleString()} bbl`;
    }

    return escapeHtml(JSON.stringify(cargo));
  };

  // Format duration
  const formatDuration = (seconds) => {
    if (!seconds) return 'N/A';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${minutes}m`;
  };

  // Render trips
  const historyHtml = trips.map(trip => {
    const isDrydockOperation = trip.is_drydock_operation === true;
    const isServiceTrip = !isDrydockOperation &amp;&amp; !trip.profit &amp;&amp; trip.cargo &amp;&amp;
      (trip.cargo.dry === 0 &amp;&amp; trip.cargo.refrigerated === 0 &amp;&amp;
       trip.cargo.fuel === 0 &amp;&amp; trip.cargo.crude_oil === 0);

    return `
    &lt;div class="history-entry">
      &lt;div class="history-route">
        &lt;strong>${formatPortName(trip.origin)}&lt;/strong> &amp;rarr; &lt;strong>${formatPortName(trip.destination)}&lt;/strong>
      &lt;/div>
      &lt;div class="history-details">
        &lt;div class="history-row">
          &lt;span>Date: ${trip.date ? new Date(trip.date + ' UTC').toLocaleString() : 'N/A'}&lt;/span>
        &lt;/div>
        ${isDrydockOperation ? `
        &lt;div class="history-row drydock-trip">
          &lt;span>Drydock Operation&lt;/span>
        &lt;/div>` : `
        &lt;div class="history-row">
          &lt;span>Cargo: ${formatCargo(trip.cargo)}&lt;/span>
        &lt;/div>
        &lt;div class="history-row">
          &lt;span>Income: ${isServiceTrip ? 'Service Trip' : '$' + (trip.profit !== null &amp;&amp; trip.profit !== undefined ? trip.profit.toLocaleString() : '?')}&lt;/span>
        &lt;/div>
        ${trip.harbor_fee !== null &amp;&amp; trip.harbor_fee !== undefined ? `
        &lt;div class="history-row">
          &lt;span>Harbor Fee: $${trip.harbor_fee.toLocaleString()}&lt;/span>
        &lt;/div>
        ` : ''}`}
        &lt;div class="history-row">
          &lt;span>Distance: ${trip.distance ? trip.distance.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' nm' : 'N/A'}&lt;/span>
        &lt;/div>
        &lt;div class="history-row">
          &lt;span>Duration: ${formatDuration(trip.duration)}&lt;/span>
        &lt;/div>
      &lt;/div>
    &lt;/div>
    `;
  }).join('');

  contentEl.innerHTML = historyHtml;
}

/**
 * Close sold vessel panel and return to analytics
 */
function closeSoldVesselPanel() {
  const panel = document.getElementById('vessel-detail-panel');
  if (panel) {
    panel.classList.remove('active');
  }

  // Return to analytics overlay
  localStorage.removeItem('returnToAnalytics');
  const harborMapOverlay = document.getElementById('harborMapOverlay');
  if (harborMapOverlay) {
    harborMapOverlay.classList.add('hidden');
  }

  const analyticsOverlay = document.getElementById('analyticsOverlay');
  if (analyticsOverlay) {
    analyticsOverlay.classList.remove('hidden');
  }
}

/**
 * Handle route row click - open harbor map with route filter
 * @param {string} origin - Origin port name
 * @param {string} destination - Destination port name
 */
async function handleRouteClick(origin, destination) {
  // Sort alphabetically and join with "&lt;>" (harbor map format: sorted port codes)
  const sortedPorts = [origin, destination].sort();
  const pairKey = sortedPorts.join('&lt;>');

  // Save to localStorage so map picks it up when loading
  localStorage.setItem('harborMapRouteFilter', pairKey);

  // Mark that we came from analytics so closing route panel returns here
  localStorage.setItem('returnToAnalytics', 'true');

  // Close analytics overlay
  const overlay = document.getElementById('analyticsOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
    destroyChart();
  }

  // Open harbor map overlay
  const harborMapOverlay = document.getElementById('harborMapOverlay');
  if (harborMapOverlay) {
    harborMapOverlay.classList.remove('hidden');
  }

  // Apply route filter - wait for map to be ready if needed
  if (window.harborMap &amp;&amp; typeof window.harborMap.setRouteFilter === 'function') {
    await window.harborMap.setRouteFilter(pairKey);
  }
}

/**
 * Initialize sortable table headers
 */
function initSortableHeaders() {
  // Vessel table headers
  const vesselTable = document.querySelector('#analytics-vessels .analytics-table thead');
  if (vesselTable) {
    const vesselHeaders = vesselTable.querySelectorAll('th');
    const vesselColumns = ['name', 'trips', 'totalRevenue', 'avgRevenuePerTrip', 'contribution', 'avgRevenuePerHour', 'avgRevenuePerNm', 'avgUtilization', 'primaryRoute'];
    vesselHeaders.forEach((th, index) => {
      if (index &lt; vesselColumns.length) {
        th.dataset.column = vesselColumns[index];
        th.dataset.table = 'vessels';
        // Remove existing listener if any (prevent duplicates)
        th.onclick = null;
        th.onclick = () => handleSort('vessels', vesselColumns[index]);
      }
    });
  }

  // Route table headers
  // Order: Route, Vessels, Trips, Revenue, Avg/Trip, Avg/h, $/nm, Hijack %, Harbor Fee %
  const routeTable = document.querySelector('#analytics-routes .analytics-table thead');
  if (routeTable) {
    const routeHeaders = routeTable.querySelectorAll('th');
    const routeColumns = ['route', 'vesselCount', 'trips', 'totalRevenue', 'avgRevenuePerTrip', 'avgRevenuePerHour', 'avgIncomePerNm', 'hijackingRisk', 'harborFeePercent'];
    routeHeaders.forEach((th, index) => {
      if (index &lt; routeColumns.length) {
        th.dataset.column = routeColumns[index];
        th.dataset.table = 'routes';
        // Remove existing listener if any (prevent duplicates)
        th.onclick = null;
        th.onclick = () => handleSort('routes', routeColumns[index]);
      }
    });
  }

  // Update sort indicators for initial state
  updateSortIndicators('vessels');
  updateSortIndicators('routes');
}

/**
 * Handle sort click on table header
 * @param {string} table - Table name (vessels or routes)
 * @param {string} column - Column to sort by
 */
function handleSort(table, column) {
  // Toggle direction if same column, else default to desc
  if (sortState[table].column === column) {
    sortState[table].direction = sortState[table].direction === 'asc' ? 'desc' : 'asc';
  } else {
    sortState[table].column = column;
    sortState[table].direction = 'desc';
  }

  // Update header indicators
  updateSortIndicators(table);

  // Re-render table
  if (table === 'vessels' &amp;&amp; analyticsData?.vessels) {
    renderVesselTable(sortData(analyticsData.vessels, sortState.vessels));
  } else if (table === 'routes' &amp;&amp; analyticsData?.routes) {
    renderRouteTable(sortData(analyticsData.routes, sortState.routes));
  }
}

/**
 * Sort data array by column and direction
 * @param {Array} data - Data to sort
 * @param {Object} sort - Sort state with column and direction
 * @returns {Array} Sorted data
 */
function sortData(data, sort) {
  const sorted = [...data];
  sorted.sort((a, b) => {
    let aVal = a[sort.column];
    let bVal = b[sort.column];

    // Handle string comparisons
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = (bVal || '').toLowerCase();
    }

    // Handle nullish values
    if (aVal == null) aVal = sort.direction === 'asc' ? Infinity : -Infinity;
    if (bVal == null) bVal = sort.direction === 'asc' ? Infinity : -Infinity;

    if (aVal &lt; bVal) return sort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return sort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  return sorted;
}

/**
 * Update sort indicators on table headers
 * @param {string} table - Table name
 */
function updateSortIndicators(table) {
  const containerId = table === 'vessels' ? '#analytics-vessels' : '#analytics-routes';
  const headers = document.querySelectorAll(`${containerId} .analytics-table thead th`);

  headers.forEach(th => {
    // Remove sort direction attribute from all headers
    delete th.dataset.sortDir;

    // Set sort direction on current sorted column
    if (th.dataset.column === sortState[table].column) {
      th.dataset.sortDir = sortState[table].direction;
    }
  });
}

/**
 * Switch between tabs
 * @param {string} tabId - Tab identifier
 */
function switchTab(tabId) {
  // Update tab buttons
  document.querySelectorAll('.analytics-tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabId);
  });

  // Update tab content
  document.querySelectorAll('.analytics-tab-content').forEach(content => {
    content.classList.toggle('hidden', content.id !== `analytics-${tabId}`);
  });

  // Initialize chart when overview tab becomes visible
  if (tabId === 'overview' &amp;&amp; analyticsData &amp;&amp; analyticsData.summary) {
    setTimeout(() => renderTrendChart(analyticsData.summary.dailyBreakdown), 100);
  }

  // Lazy load vessels data when vessels tab is clicked
  if (tabId === 'vessels') {
    lazyLoadVessels();
  }

  // Lazy load routes data when routes tab is clicked
  if (tabId === 'routes') {
    lazyLoadRoutes();
  }

  // Load game log data when tab becomes visible
  if (tabId === 'game-log' &amp;&amp; !lookupData) {
    loadGameLogData();
  }

  // Load API stats when tab becomes visible (develMode only)
  if (tabId === 'api-stats' &amp;&amp; isDevelMode) {
    loadApiStats();
  }

  // Load port demand data when tab becomes visible
  if (tabId === 'ports') {
    lazyLoadPorts();
  }
}

/**
 * Load analytics data from API - uses lazy loading for vessels/routes tabs
 */
async function loadAnalyticsData() {
  const loadingEl = document.getElementById('analyticsLoading');
  const contentEl = document.getElementById('analyticsContent');

  // Check if overview cache is still valid
  if (isCacheValid(lazyLoadState.overview.loadedAt) &amp;&amp; analyticsData) {
    logger.debug('[Analytics] Using cached overview data');
    // Just re-render from cache
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
    renderSummary(analyticsData.summary);
    renderExpenseTable(analyticsData.detailedExpenses);
    renderQuickSummary(analyticsData);
    initSortableHeaders();
    const overviewTab = document.getElementById('analytics-overview');
    if (overviewTab &amp;&amp; !overviewTab.classList.contains('hidden') &amp;&amp; analyticsData.summary) {
      setTimeout(() => renderTrendChart(analyticsData.summary.dailyBreakdown), 50);
    }
    return;
  }

  try {
    if (loadingEl) loadingEl.classList.remove('hidden');
    if (contentEl) contentEl.classList.add('hidden');

    // Reset lazy load state for vessels/routes (they need to reload with new data)
    lazyLoadState.vessels.loaded = false;
    lazyLoadState.vessels.loading = false;
    lazyLoadState.vessels.loadedAt = 0;
    lazyLoadState.routes.loaded = false;
    lazyLoadState.routes.loading = false;
    lazyLoadState.routes.loadedAt = 0;

    // Load only overview data first (fast)
    const overviewData = await getAnalyticsOverview(currentDays);

    // Initialize analyticsData with overview data
    analyticsData = {
      summary: overviewData.summary,
      detailedExpenses: overviewData.detailedExpenses,
      vessels: null,
      routes: null,
      days: overviewData.days
    };

    // Mark overview as loaded with timestamp
    lazyLoadState.overview.loaded = true;
    lazyLoadState.overview.loadedAt = Date.now();

    // Render overview immediately
    renderSummary(analyticsData.summary);
    renderExpenseTable(analyticsData.detailedExpenses);
    renderQuickSummary(analyticsData);

    // Re-initialize sortable headers after data is loaded
    initSortableHeaders();

    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');

    // Render chart AFTER content is visible so container has width
    const overviewTab = document.getElementById('analytics-overview');
    if (overviewTab &amp;&amp; !overviewTab.classList.contains('hidden') &amp;&amp; analyticsData.summary) {
      setTimeout(() => renderTrendChart(analyticsData.summary.dailyBreakdown), 50);
    }

    // Re-render vessel revenue charts with new time-filtered entries
    // (preloadAllTabs won't re-render if vessels are already cached)
    if (analyticsData.vessels) {
      renderVesselsRevenueChart(analyticsData.vessels, analyticsData.summary?.vesselRevenueEntries);
      renderBottomVesselsRevenueChart(analyticsData.vessels, analyticsData.summary?.vesselRevenueEntries);
    }

    // Preload all tabs in background (parallel)
    preloadAllTabs();

  } catch (error) {
    console.error('[Analytics] Failed to load data:', error);
    showNotification('Failed to load analytics data', 'error');
    if (loadingEl) loadingEl.classList.add('hidden');
  }
}

/**
 * Lazy load vessels data when tab is opened
 */
async function lazyLoadVessels() {
  const loadingEl = document.getElementById('analytics-vessels-loading');
  const contentEl = document.getElementById('analytics-vessels-content');

  // If already loading, skip
  if (lazyLoadState.vessels.loading) return;

  // If analyticsData not initialized yet, load overview first
  if (!analyticsData) {
    logger.debug('[Analytics] Overview not loaded yet, loading first...');
    await loadAnalyticsData();
    // After loadAnalyticsData, analyticsData should be initialized
    if (!analyticsData) {
      console.error('[Analytics] Failed to initialize analyticsData');
      if (loadingEl) loadingEl.textContent = 'Failed to load analytics data';
      return;
    }
  }

  // If cache is still valid, just render from cache
  if (isCacheValid(lazyLoadState.vessels.loadedAt) &amp;&amp; analyticsData.vessels) {
    logger.debug('[Analytics] Using cached vessels data');
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
    renderVesselTable(sortData(analyticsData.vessels, sortState.vessels));
    setTimeout(() => renderVesselCharts(analyticsData.vessels, analyticsData.summary?.utilizationEntries), 100);
    return;
  }

  // Show loading, hide content
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (contentEl) contentEl.classList.add('hidden');

  lazyLoadState.vessels.loading = true;
  try {
    const data = await getAnalyticsVessels(currentDays);
    // Check again after async call - analyticsData could have been reset
    if (!analyticsData) {
      console.warn('[Analytics] analyticsData was reset during vessel load');
      return;
    }
    analyticsData.vessels = data.vessels;
    lazyLoadState.vessels.loaded = true;
    lazyLoadState.vessels.loadedAt = Date.now();

    // Hide loading, show content
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');

    renderVesselTable(sortData(analyticsData.vessels, sortState.vessels));

    // Render vessel charts
    setTimeout(() => renderVesselCharts(analyticsData.vessels, analyticsData.summary?.utilizationEntries), 100);
  } catch (error) {
    console.error('[Analytics] Failed to load vessels:', error);
    // Show error in loading div
    if (loadingEl) loadingEl.textContent = 'Failed to load vessel data';
  } finally {
    lazyLoadState.vessels.loading = false;
  }
}

/**
 * Lazy load routes data when tab is opened
 */
async function lazyLoadRoutes() {
  const loadingEl = document.getElementById('analytics-routes-loading');
  const contentEl = document.getElementById('analytics-routes-content');

  // If already loading, skip
  if (lazyLoadState.routes.loading) return;

  // If analyticsData not initialized yet, load overview first
  if (!analyticsData) {
    logger.debug('[Analytics] Overview not loaded yet, loading first...');
    await loadAnalyticsData();
    // After loadAnalyticsData, analyticsData should be initialized
    if (!analyticsData) {
      console.error('[Analytics] Failed to initialize analyticsData');
      if (loadingEl) loadingEl.textContent = 'Failed to load analytics data';
      return;
    }
  }

  // If cache is still valid, just render from cache
  if (isCacheValid(lazyLoadState.routes.loadedAt) &amp;&amp; analyticsData.routes) {
    logger.debug('[Analytics] Using cached routes data');
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
    renderRouteTable(sortData(analyticsData.routes, sortState.routes));
    return;
  }

  // Show loading, hide content
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (contentEl) contentEl.classList.add('hidden');

  lazyLoadState.routes.loading = true;
  try {
    const data = await getAnalyticsRoutes(currentDays);
    // Check again after async call - analyticsData could have been reset
    if (!analyticsData) {
      console.warn('[Analytics] analyticsData was reset during routes load');
      return;
    }
    analyticsData.routes = data.routes;
    lazyLoadState.routes.loaded = true;
    lazyLoadState.routes.loadedAt = Date.now();

    // Hide loading, show content
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');

    renderRouteTable(sortData(analyticsData.routes, sortState.routes));
  } catch (error) {
    console.error('[Analytics] Failed to load routes:', error);
    // Show error in loading div
    if (loadingEl) loadingEl.textContent = 'Failed to load route data';
  } finally {
    lazyLoadState.routes.loading = false;
  }
}

/**
 * Lazy load port demand data when Ports tab is clicked
 */
async function lazyLoadPorts() {
  const loadingEl = document.getElementById('portDemandLoading');
  const contentEl = document.getElementById('portDemandContent');

  // If already loading, skip
  if (lazyLoadState.ports.loading) return;

  // If cache is still valid, skip reload
  if (isCacheValid(lazyLoadState.ports.loadedAt)) {
    logger.debug('[Analytics] Using cached ports data');
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
    return;
  }

  // Show loading, hide content
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (contentEl) contentEl.classList.add('hidden');

  lazyLoadState.ports.loading = true;
  try {
    // Load status and harbor-map overview (has all ports with country) in parallel
    const [statusData, harborData] = await Promise.all([
      getPortDemandStatus(),
      fetch(window.apiUrl('/api/harbor-map/overview?filter=all_ports')).then(r => r.json())
    ]);

    // Update sync status display
    updatePortDemandStatus(statusData);

    // Populate port dropdown with all ports from harbor-map (have code + country)
    populatePortDropdown(harborData.ports);

    lazyLoadState.ports.loaded = true;
    lazyLoadState.ports.loadedAt = Date.now();

    // Hide loading, show content
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');

  } catch (error) {
    console.error('[Analytics] Failed to load port demand:', error);
    if (loadingEl) loadingEl.textContent = 'Failed to load port demand data';
  } finally {
    lazyLoadState.ports.loading = false;
  }
}

/**
 * Update port demand sync status display
 */
function updatePortDemandStatus(statusData) {
  const dataPointsEl = document.getElementById('portDemandDataPoints');
  const syncProgressEl = document.getElementById('portDemandSyncProgress');
  const lastCycleEl = document.getElementById('portDemandLastCycle');
  const totalPortsEl = document.getElementById('portDemandTotalPorts');

  if (!statusData) {
    throw new Error('No status data received');
  }

  const store = statusData.store;
  const sync = statusData.sync;

  if (!store || !sync) {
    throw new Error('Invalid status data structure');
  }

  if (dataPointsEl) {
    dataPointsEl.textContent = formatNumber(store.totalEntries);
  }
  if (syncProgressEl) {
    syncProgressEl.textContent = sync.cycleProgress;
  }
  if (lastCycleEl) {
    if (sync.lastFullCycleAt) {
      const date = new Date(sync.lastFullCycleAt);
      lastCycleEl.textContent = date.toLocaleTimeString();
    } else {
      lastCycleEl.textContent = 'In progress...';
    }
  }
  if (totalPortsEl) {
    totalPortsEl.textContent = sync.totalPorts;
  }
}

// Store ports data for filtering
let portSearchData = [];
let portSearchHighlightIndex = -1;

/**
 * Populate port dropdown with available ports (searchable)
 */
function populatePortDropdown(ports) {
  const searchInput = document.getElementById('portDemandSearch');
  const hiddenSelect = document.getElementById('portDemandPortSelect');
  const dropdown = document.getElementById('portDemandDropdown');

  if (!searchInput || !hiddenSelect || !dropdown) return;

  // Handle null/undefined ports
  if (!ports || !Array.isArray(ports)) {
    portSearchData = [];
    return;
  }

  // Format port name to Title Case (new_york -> New York)
  const formatName = (code) => {
    return code.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  };

  // Sort ports by name and store with display text
  portSearchData = [...ports].sort((a, b) => {
    const nameA = formatName(a.code);
    const nameB = formatName(b.code);
    return nameA.localeCompare(nameB);
  }).map(port => ({
    code: port.code,
    country: port.country,
    display: `${formatName(port.code)} (${toGameCode(port.code, port.country)})`
  }));

  // Render dropdown items
  function renderDropdown(filter = '') {
    const filterLower = filter.toLowerCase();
    const filtered = filter
      ? portSearchData.filter(p => p.display.toLowerCase().includes(filterLower))
      : portSearchData;

    if (filtered.length === 0) {
      dropdown.innerHTML = '&lt;div class="port-search-no-results">No ports found&lt;/div>';
      return;
    }

    dropdown.innerHTML = filtered.map((port, idx) => `
      &lt;div class="port-search-item${idx === portSearchHighlightIndex ? ' highlighted' : ''}"
           data-code="${port.code}" data-display="${port.display}">
        ${port.display}
      &lt;/div>
    `).join('');
  }

  // Select a port
  function selectPort(code, display) {
    hiddenSelect.value = code;
    hiddenSelect.dataset.display = display;
    searchInput.value = display;
    dropdown.classList.add('hidden');
    portSearchHighlightIndex = -1;
    if (code) {
      loadPortDemandChart(code);
    } else {
      clearPortDemandChart();
    }
  }

  // Input handler for filtering
  searchInput.addEventListener('input', () => {
    portSearchHighlightIndex = -1;
    renderDropdown(searchInput.value);
    dropdown.classList.remove('hidden');
  });

  // Focus handler - show dropdown
  searchInput.addEventListener('focus', () => {
    renderDropdown(searchInput.value);
    dropdown.classList.remove('hidden');
  });

  // Keyboard navigation
  searchInput.addEventListener('keydown', (e) => {
    const items = dropdown.querySelectorAll('.port-search-item');
    if (items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      portSearchHighlightIndex = Math.min(portSearchHighlightIndex + 1, items.length - 1);
      updateHighlight(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      portSearchHighlightIndex = Math.max(portSearchHighlightIndex - 1, 0);
      updateHighlight(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (portSearchHighlightIndex >= 0 &amp;&amp; items[portSearchHighlightIndex]) {
        const item = items[portSearchHighlightIndex];
        selectPort(item.dataset.code, item.dataset.display);
      }
    } else if (e.key === 'Escape') {
      dropdown.classList.add('hidden');
      portSearchHighlightIndex = -1;
    }
  });

  function updateHighlight(items) {
    items.forEach((item, idx) => {
      item.classList.toggle('highlighted', idx === portSearchHighlightIndex);
      if (idx === portSearchHighlightIndex) {
        item.scrollIntoView({ block: 'nearest' });
      }
    });
  }

  // Click handler for dropdown items
  dropdown.addEventListener('click', (e) => {
    const item = e.target.closest('.port-search-item');
    if (item) {
      selectPort(item.dataset.code, item.dataset.display);
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.port-search-dropdown')) {
      dropdown.classList.add('hidden');
      portSearchHighlightIndex = -1;
    }
  });

  // Initial render
  renderDropdown();
}

/**
 * Load and render port demand chart for a specific port
 */
async function loadPortDemandChart(portCode) {
  const teuContainer = document.getElementById('portDemandChartContainerTEU');
  const bblContainer = document.getElementById('portDemandChartContainerBBL');
  if (!teuContainer) return;

  // Get port name from dropdown
  const portSelect = document.getElementById('portDemandPortSelect');
  const portName = portSelect?.dataset?.display ? portSelect.dataset.display : portCode;

  // Show loading in chart areas
  teuContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">Loading demand history...&lt;/div>';
  if (bblContainer) {
    bblContainer.classList.remove('hidden');
    bblContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">Loading demand history...&lt;/div>';
  }

  try {
    // Fetch both demand history and port vessel data in parallel
    const [historyData, portData] = await Promise.all([
      getPortDemandHistory(portCode, currentDays),
      fetch(window.apiUrl(`/api/harbor-map/port/${portCode}`)).then(r => r.json())
    ]);

    // Update vessel metrics
    updatePortVesselMetrics(portData);

    if (!historyData.history || historyData.history.length === 0) {
      teuContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">No demand history available for this port yet&lt;/div>';
      if (bblContainer) bblContainer.classList.add('hidden');
      return;
    }

    renderPortDemandCharts(historyData.history, portName);

  } catch (error) {
    console.error('[Analytics] Failed to load port demand chart:', error);
    teuContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">Failed to load demand history&lt;/div>';
    if (bblContainer) bblContainer.classList.add('hidden');
  }
}

/**
 * Update vessel metrics for the selected port
 */
function updatePortVesselMetrics(portData) {
  const activeVesselsEl = document.getElementById('portDemandActiveVessels');
  const maxTEUEl = document.getElementById('portDemandMaxTEU');
  const maxBBLEl = document.getElementById('portDemandMaxBBL');

  // Always show BBL metric (tanker building works without tanker ops due to game bug)
  if (maxBBLEl) {
    const bblContainer = maxBBLEl.closest('.analytics-metric');
    if (bblContainer) {
      bblContainer.classList.remove('hidden');
    }
  }

  // Reset values
  if (activeVesselsEl) activeVesselsEl.textContent = '-';
  if (maxTEUEl) maxTEUEl.textContent = '-';
  if (maxBBLEl) maxBBLEl.textContent = '-';

  if (!portData || !portData.vessels) return;

  // Combine all vessel categories
  const allVessels = [
    ...(portData.vessels.inPort || []),
    ...(portData.vessels.toPort || []),
    ...(portData.vessels.fromPort || []),
    ...(portData.vessels.pending || [])
  ];

  // Count active vessels
  if (activeVesselsEl) {
    activeVesselsEl.textContent = formatNumber(allVessels.length);
  }

  // Calculate max TEU and max BBL
  let totalTEU = 0;
  let totalBBL = 0;

  for (const vessel of allVessels) {
    if (vessel.capacity_type === 'container' &amp;&amp; vessel.capacity_max) {
      const dry = vessel.capacity_max.dry || 0;
      const ref = vessel.capacity_max.refrigerated || 0;
      totalTEU += dry + ref;
    } else if (vessel.capacity_type === 'tanker' &amp;&amp; vessel.capacity_max) {
      const fuel = vessel.capacity_max.fuel || 0;
      const crude = vessel.capacity_max.crude_oil || 0;
      totalBBL += fuel + crude;
    }
  }

  if (maxTEUEl) {
    maxTEUEl.textContent = totalTEU > 0 ? formatNumber(totalTEU) : '-';
  }
  if (maxBBLEl) {
    maxBBLEl.textContent = totalBBL > 0 ? formatNumber(totalBBL) : '-';
  }
}

// Track port demand series visibility state
const portDemandSeriesStateTEU = { dry: true, refrigerated: true };
const portDemandSeriesStateBBL = { fuel: true, crude: true };

// Series colors
const portDemandColors = {
  dry: '#2196F3',
  refrigerated: '#4CAF50',
  fuel: '#FF9800',
  crude: '#9C27B0'
};

// Chart instances
let portDemandChartTEU = null;
let portDemandChartBBL = null;
let portDemandSeriesTEU = {};
let portDemandSeriesBBL = {};

/**
 * Create chart options (reusable)
 */
function getPortDemandChartOptions() {
  return {
    autoSize: true,
    height: 280,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal
    },
    rightPriceScale: {
      borderColor: 'rgba(255,255,255,0.2)'
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: false
    },
    localization: {
      priceFormatter: (price) => Math.round(price).toLocaleString('en-US')
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  };
}

/**
 * Render TEU chart (Container demand - Dry + Refrigerated)
 * Shows current demand (demand - consumed)
 */
function renderTEUChart(container, history, portName) {
  container.innerHTML = '';

  const sortedHistory = [...history].sort((a, b) => a.timestamp - b.timestamp);

  // Current demand = max - consumed
  const dryData = sortedHistory.map(e => ({
    time: e.timestamp,
    value: Math.max(0, (e.dry_demand || 0) - (e.dry_consumed || 0))
  }));
  const refData = sortedHistory.map(e => ({
    time: e.timestamp,
    value: Math.max(0, (e.refrigerated_demand || 0) - (e.refrigerated_consumed || 0))
  }));

  const filterText = currentDays === 0 ? 'All Time' : `${currentDays} Days`;
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">${escapeHtml(portName || 'Port')} - Container Demand TEU (${filterText})&lt;/span>
    &lt;/div>
  `;

  const chartDiv = document.createElement('div');
  chartDiv.style.height = '280px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  portDemandChartTEU = LightweightCharts.createChart(chartDiv, getPortDemandChartOptions());

  const addLine = (chart, options) => {
    if (typeof chart.addLineSeries === 'function') {
      return chart.addLineSeries(options);
    }
    return chart.addSeries(LightweightCharts.LineSeries, options);
  };

  portDemandSeriesTEU.dry = addLine(portDemandChartTEU, {
    color: portDemandColors.dry,
    lineWidth: 2,
    visible: portDemandSeriesStateTEU.dry,
    priceFormat: { type: 'volume', precision: 0 }
  });
  portDemandSeriesTEU.dry.setData(dryData);

  portDemandSeriesTEU.refrigerated = addLine(portDemandChartTEU, {
    color: portDemandColors.refrigerated,
    lineWidth: 2,
    visible: portDemandSeriesStateTEU.refrigerated,
    priceFormat: { type: 'volume', precision: 0 }
  });
  portDemandSeriesTEU.refrigerated.setData(refData);

  portDemandChartTEU.timeScale().fitContent();

  const togglesDiv = document.createElement('div');
  togglesDiv.className = 'analytics-chart-toggles';
  togglesDiv.innerHTML = `
    &lt;button class="analytics-chart-toggle ${portDemandSeriesStateTEU.dry ? 'active' : ''}" data-series="dry" style="border-color: ${portDemandColors.dry}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${portDemandColors.dry};">&lt;/span>
      Dry TEU
    &lt;/button>
    &lt;button class="analytics-chart-toggle ${portDemandSeriesStateTEU.refrigerated ? 'active' : ''}" data-series="refrigerated" style="border-color: ${portDemandColors.refrigerated}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${portDemandColors.refrigerated};">&lt;/span>
      Ref TEU
    &lt;/button>
  `;
  container.appendChild(togglesDiv);

  togglesDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const seriesKey = btn.dataset.series;
      const series = portDemandSeriesTEU[seriesKey];
      if (!series) return;
      const isActive = btn.classList.toggle('active');
      portDemandSeriesStateTEU[seriesKey] = isActive;
      series.applyOptions({ visible: isActive });
    });
  });
}

/**
 * Render BBL chart (Tanker demand - Fuel + Crude)
 * Shows current demand (demand - consumed)
 */
function renderBBLChart(container, history, portName) {
  container.innerHTML = '';

  const sortedHistory = [...history].sort((a, b) => a.timestamp - b.timestamp);

  // Current demand = max - consumed
  const fuelData = sortedHistory.map(e => ({
    time: e.timestamp,
    value: Math.max(0, (e.fuel_demand || 0) - (e.fuel_consumed || 0))
  }));
  const crudeData = sortedHistory.map(e => ({
    time: e.timestamp,
    value: Math.max(0, (e.crude_demand || 0) - (e.crude_consumed || 0))
  }));

  const filterText = currentDays === 0 ? 'All Time' : `${currentDays} Days`;
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">${escapeHtml(portName || 'Port')} - Tanker Demand BBL (${filterText})&lt;/span>
    &lt;/div>
  `;

  const chartDiv = document.createElement('div');
  chartDiv.style.height = '280px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  portDemandChartBBL = LightweightCharts.createChart(chartDiv, getPortDemandChartOptions());

  const addLine = (chart, options) => {
    if (typeof chart.addLineSeries === 'function') {
      return chart.addLineSeries(options);
    }
    return chart.addSeries(LightweightCharts.LineSeries, options);
  };

  portDemandSeriesBBL.fuel = addLine(portDemandChartBBL, {
    color: portDemandColors.fuel,
    lineWidth: 2,
    visible: portDemandSeriesStateBBL.fuel,
    priceFormat: { type: 'volume', precision: 0 }
  });
  portDemandSeriesBBL.fuel.setData(fuelData);

  portDemandSeriesBBL.crude = addLine(portDemandChartBBL, {
    color: portDemandColors.crude,
    lineWidth: 2,
    visible: portDemandSeriesStateBBL.crude,
    priceFormat: { type: 'volume', precision: 0 }
  });
  portDemandSeriesBBL.crude.setData(crudeData);

  portDemandChartBBL.timeScale().fitContent();

  const togglesDiv = document.createElement('div');
  togglesDiv.className = 'analytics-chart-toggles';
  togglesDiv.innerHTML = `
    &lt;button class="analytics-chart-toggle ${portDemandSeriesStateBBL.fuel ? 'active' : ''}" data-series="fuel" style="border-color: ${portDemandColors.fuel}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${portDemandColors.fuel};">&lt;/span>
      Fuel BBL
    &lt;/button>
    &lt;button class="analytics-chart-toggle ${portDemandSeriesStateBBL.crude ? 'active' : ''}" data-series="crude" style="border-color: ${portDemandColors.crude}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${portDemandColors.crude};">&lt;/span>
      Crude BBL
    &lt;/button>
  `;
  container.appendChild(togglesDiv);

  togglesDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const seriesKey = btn.dataset.series;
      const series = portDemandSeriesBBL[seriesKey];
      if (!series) return;
      const isActive = btn.classList.toggle('active');
      portDemandSeriesStateBBL[seriesKey] = isActive;
      series.applyOptions({ visible: isActive });
    });
  });
}

/**
 * Render port demand charts (TEU + BBL if user has tanker)
 */
function renderPortDemandCharts(history, portName) {
  const teuContainer = document.getElementById('portDemandChartContainerTEU');
  const bblContainer = document.getElementById('portDemandChartContainerBBL');

  if (!teuContainer) return;

  // Always render TEU chart
  renderTEUChart(teuContainer, history, portName);

  // Always render BBL chart (tanker building works without tanker ops due to game bug)
  if (bblContainer) {
    bblContainer.classList.remove('hidden');
    renderBBLChart(bblContainer, history, portName);
  }
}

/**
 * Clear port demand charts
 */
function clearPortDemandChart() {
  const teuContainer = document.getElementById('portDemandChartContainerTEU');
  const bblContainer = document.getElementById('portDemandChartContainerBBL');

  if (teuContainer) {
    teuContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">Select a port to view demand history&lt;/div>';
  }
  if (bblContainer) {
    bblContainer.innerHTML = '&lt;div class="port-demand-chart-placeholder">Select a port to view demand history&lt;/div>';
  }

  if (portDemandChartTEU) {
    portDemandChartTEU.remove();
    portDemandChartTEU = null;
    portDemandSeriesTEU = {};
  }
  if (portDemandChartBBL) {
    portDemandChartBBL.remove();
    portDemandChartBBL = null;
    portDemandSeriesBBL = {};
  }

  // Reset vessel metrics
  const activeVesselsEl = document.getElementById('portDemandActiveVessels');
  const maxTEUEl = document.getElementById('portDemandMaxTEU');
  const maxBBLEl = document.getElementById('portDemandMaxBBL');
  if (activeVesselsEl) activeVesselsEl.textContent = '-';
  if (maxTEUEl) maxTEUEl.textContent = '-';
  if (maxBBLEl) maxBBLEl.textContent = '-';
}

/**
 * Preload all tabs in background (parallel)
 * Data is cached so tabs open instantly when clicked
 */
async function preloadAllTabs() {
  // Load vessels and routes in parallel
  const vesselsPromise = (async () => {
    try {
      if (analyticsData?.vessels) return; // Already cached

      const data = await getAnalyticsVessels(currentDays);
      // Check again after async call
      if (!analyticsData) return;
      analyticsData.vessels = data.vessels;
      lazyLoadState.vessels.loaded = true;
      lazyLoadState.vessels.loadedAt = Date.now();

      // Render Top/Bottom charts in Overview
      const entries = analyticsData.summary?.vesselRevenueEntries;
      renderVesselsRevenueChart(data.vessels, entries);
      renderBottomVesselsRevenueChart(data.vessels, entries);
    } catch (error) {
      console.error('[Analytics] Failed to preload vessels:', error);
    }
  })();

  const routesPromise = (async () => {
    try {
      if (analyticsData?.routes) return; // Already cached

      const data = await getAnalyticsRoutes(currentDays);
      // Check again after async call
      if (!analyticsData) return;
      analyticsData.routes = data.routes;
      lazyLoadState.routes.loaded = true;
      lazyLoadState.routes.loadedAt = Date.now();
    } catch (error) {
      console.error('[Analytics] Failed to preload routes:', error);
    }
  })();

  // Wait for both (non-blocking for UI)
  await Promise.all([vesselsPromise, routesPromise]);
}

/**
 * Render summary cards
 * @param {Object} summary - Summary data (merged format)
 */
function renderSummary(summary) {
  if (!summary) return;

  // Revenue card - use income.total to match Game Log tab's "Total Income"
  const revenueEl = document.getElementById('analytics-revenue');
  if (revenueEl) {
    revenueEl.textContent = formatCurrency(summary.income?.total || 0);
  }

  // Expenses card
  const expensesEl = document.getElementById('analytics-expenses');
  if (expensesEl) {
    expensesEl.textContent = formatCurrency(summary.expenses?.total || 0);
  }

  // Profit card
  const profitEl = document.getElementById('analytics-profit');
  if (profitEl) {
    const profit = summary.profit?.net || 0;
    profitEl.textContent = formatCurrency(profit, true);
    profitEl.classList.toggle('positive', profit >= 0);
    profitEl.classList.toggle('negative', profit &lt; 0);
  }

  // Margin card
  const marginEl = document.getElementById('analytics-margin');
  if (marginEl) {
    marginEl.textContent = formatPercent(summary.profit?.margin || 0);
  }

  // Trips card
  const tripsEl = document.getElementById('analytics-trips');
  if (tripsEl) {
    tripsEl.textContent = formatNumber(summary.operations?.trips || 0);
  }

  // Avg Fuel Price card - from local purchase logs
  const avgFuelEl = document.getElementById('analytics-avg-fuel');
  if (avgFuelEl) {
    const avgFuelPrice = summary.averages?.fuelPrice;
    if (avgFuelPrice &amp;&amp; avgFuelPrice > 0) {
      avgFuelEl.textContent = `$${avgFuelPrice.toFixed(0)}/t`;
    } else {
      avgFuelEl.textContent = 'N/A';
    }
  }
}

/**
 * Render quick summary on overview tab
 * Shows operational data from local logs and expense totals from game API
 * Uses card grid layout (3 cards per row)
 * @param {Object} data - Full analytics data
 */
function renderQuickSummary() {
  // Quick summary section removed - all relevant data shown in main summary cards and chart
  const container = document.getElementById('analytics-quick-summary');
  if (container) container.innerHTML = '';
}

/**
 * Render expense details table (merged from breakdown + details)
 * @param {Object} expenses - Detailed expense data (already merged in backend)
 */
function renderExpenseTable(expenses) {
  const tbody = document.getElementById('analytics-expenses-tbody');
  if (!tbody || !expenses) return;

  // Category display name mapping
  const categoryLabels = {
    fuel: 'Fuel',
    co2: 'CO2',
    harborFees: 'Harbor Fees',
    repairs: 'Repairs',
    drydock: 'Drydock',
    campaigns: 'Marketing',
    salary: 'Salaries',
    guards: 'Guards',
    routeFees: 'Route Fees',
    anchors: 'Anchors',
    hijacking: 'Hijacking Ransom',
    pirateRaid: 'Pirate Raid',
    vesselPurchases: 'Vessel Purchases',
    vesselBuilding: 'Vessel Building',
    stockPurchases: 'Stock Purchases',
    allianceContribution: 'Alliance Contribution'
  };

  // Build rows dynamically from expenses object
  const rows = [];
  const skipKeys = ['grandTotal', 'netVesselCost', 'vesselSales'];

  Object.keys(expenses).forEach(key => {
    if (skipKeys.includes(key)) return;

    const data = expenses[key];
    if (!data) return;

    // Handle hijacking special structure
    if (key === 'hijacking') {
      if (data.ransomPaid > 0) {
        rows.push({
          name: categoryLabels[key] || key,
          data: { total: data.ransomPaid, auto: 0, manual: data.ransomPaid, count: data.count || 0 }
        });
      }
      return;
    }

    // Handle harborFees special structure
    if (key === 'harborFees') {
      if (data.total > 0) {
        rows.push({
          name: categoryLabels[key] || key,
          data: { total: data.total, auto: data.total, manual: 0, count: data.count || 0 }
        });
      }
      return;
    }

    // Handle vesselPurchases special structure
    if (key === 'vesselPurchases') {
      if (data.total > 0) {
        rows.push({
          name: categoryLabels[key] || key,
          data: { total: data.total, auto: 0, manual: data.total, count: data.count || 0 }
        });
      }
      return;
    }

    // Standard category
    if (typeof data.total === 'number' &amp;&amp; data.total > 0) {
      rows.push({
        name: categoryLabels[key] || key,
        data: data
      });
    }
  });

  // Sort rows by total descending
  rows.sort((a, b) => (b.data?.total || 0) - (a.data?.total || 0));

  // Use merged grand total from backend
  const grandTotal = expenses.grandTotal || 0;
  let totalAuto = 0;
  let totalManual = 0;
  let totalCount = 0;

  let html = '';
  rows.forEach(row => {
    if (row.data &amp;&amp; row.data.total > 0) {
      totalAuto += row.data.auto || 0;
      totalManual += row.data.manual || 0;
      totalCount += row.data.count || 0;

      const percentage = grandTotal > 0 ? ((row.data.total / grandTotal) * 100).toFixed(1) : 0;

      html += `
        &lt;tr>
          &lt;td>${row.name}&lt;/td>
          &lt;td class="num">${formatCurrency(row.data.total)}&lt;/td>
          &lt;td class="num">${percentage}%&lt;/td>
          &lt;td class="num">${row.data.auto > 0 ? formatCurrency(row.data.auto) : '-'}&lt;/td>
          &lt;td class="num">${row.data.manual > 0 ? formatCurrency(row.data.manual) : '-'}&lt;/td>
          &lt;td class="num">${row.data.count || '-'}&lt;/td>
        &lt;/tr>
      `;
    }
  });

  // Add total row with proper sums
  html += `
    &lt;tr style="font-weight: bold; border-top: 2px solid var(--white-20);">
      &lt;td>Total Expenses&lt;/td>
      &lt;td class="num">${formatCurrency(grandTotal)}&lt;/td>
      &lt;td class="num">100%&lt;/td>
      &lt;td class="num">${totalAuto > 0 ? formatCurrency(totalAuto) : '-'}&lt;/td>
      &lt;td class="num">${totalManual > 0 ? formatCurrency(totalManual) : '-'}&lt;/td>
      &lt;td class="num">${totalCount || '-'}&lt;/td>
    &lt;/tr>
  `;

  // Add vessel sales if any
  if (expenses.vesselSales?.total > 0) {
    html += `
      &lt;tr class="positive">
        &lt;td>Vessel Sales (Income)&lt;/td>
        &lt;td class="num positive">+${formatCurrency(expenses.vesselSales.total)}&lt;/td>
        &lt;td class="num">-&lt;/td>
        &lt;td class="num">-&lt;/td>
        &lt;td class="num">+${formatCurrency(expenses.vesselSales.total)}&lt;/td>
        &lt;td class="num">${expenses.vesselSales.count || 0}&lt;/td>
      &lt;/tr>
      &lt;tr style="font-weight: bold;">
        &lt;td>Net Vessel Cost&lt;/td>
        &lt;td class="num ${expenses.netVesselCost > 0 ? 'negative' : 'positive'}">${formatCurrency(expenses.netVesselCost, true)}&lt;/td>
        &lt;td class="num">-&lt;/td>
        &lt;td class="num">-&lt;/td>
        &lt;td class="num">-&lt;/td>
        &lt;td class="num">-&lt;/td>
      &lt;/tr>
    `;
  }

  tbody.innerHTML = html || '&lt;tr>&lt;td colspan="6" class="no-data">No expense data&lt;/td>&lt;/tr>';
}

/**
 * Render vessel performance table
 * @param {Array} vessels - Vessel data
 */
function renderVesselTable(vessels) {
  const tbody = document.getElementById('analytics-vessels-tbody');
  if (!tbody) return;

  if (!vessels || vessels.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="9" class="no-data">No vessel data available&lt;/td>&lt;/tr>';
    return;
  }

  // Apply vessel filter (owned vs sold)
  const filteredVessels = vessels.filter(v => {
    const isOwned = v.isOwned !== false; // Default to owned if not specified
    if (isOwned &amp;&amp; !vesselFilterState.showOwned) return false;
    if (!isOwned &amp;&amp; !vesselFilterState.showSold) return false;
    return true;
  });

  if (filteredVessels.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="9" class="no-data">No vessels match current filter&lt;/td>&lt;/tr>';
    return;
  }

  let html = '';
  filteredVessels.forEach(v => {
    const isOwned = v.isOwned !== false;
    const statusIcon = isOwned
      ? '&lt;span class="vessel-status owned" title="Currently owned">&amp;#x1F7E2;&lt;/span>'
      : '&lt;span class="vessel-status sold" title="Sold">&amp;#x1F578;&amp;#xFE0F;&lt;/span>';

    html += `
      &lt;tr data-vessel-id="${v.vesselId}">
        &lt;td class="vessel-name">${statusIcon} ${escapeHtml(v.name)}&lt;/td>
        &lt;td class="num">${v.trips}&lt;/td>
        &lt;td class="num">${formatCurrency(v.totalRevenue)}&lt;/td>
        &lt;td class="num">${formatCurrency(v.avgRevenuePerTrip)}&lt;/td>
        &lt;td class="num">${formatNumber(v.contribution || v.totalContribution || 0)}&lt;/td>
        &lt;td class="num">${formatCurrency(v.avgRevenuePerHour)}&lt;/td>
        &lt;td class="num">${formatCurrency(v.avgRevenuePerNm)}&lt;/td>
        &lt;td class="num">${formatPercent(v.avgUtilization)}&lt;/td>
        &lt;td class="route">${escapeHtml(v.primaryRoute || '-')}&lt;/td>
      &lt;/tr>
    `;
  });

  tbody.innerHTML = html;
}

// Vessel chart instances
let vesselsRevenueChart = null;
let bottomVesselsRevenueChart = null;
let vesselsUtilizationChart = null;

/**
 * Render vessel charts for Vessels tab (composition and utilization only)
 * Top/Bottom revenue charts are now in Overview tab
 * @param {Array} vessels - Vessel data
 * @param {Array} utilizationEntries - Individual utilization entries with timestamps
 */
function renderVesselCharts(vessels, utilizationEntries) {
  if (!vessels || vessels.length === 0) return;

  // Top/Bottom revenue charts are now rendered in Overview tab
  renderVesselsCompositionChart(vessels);
  renderVesselsUtilizationChart(utilizationEntries);
}

/**
 * Render Top 10 Vessels by Revenue line chart with timestamp-based zoom
 * @param {Array|null} vessels - Vessel data (optional, can derive top 10 from entries)
 * @param {Array} vesselRevenueEntries - Individual entries with {time, value, vesselId, vesselName}
 */
function renderVesselsRevenueChart(vessels, vesselRevenueEntries, retryCount = 0) {
  const container = document.getElementById('vessels-revenue-chart-container');
  if (!container) return;

  if (vesselsRevenueChart) {
    vesselsRevenueChart.remove();
    vesselsRevenueChart = null;
  }

  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not loaded&lt;/div>';
    return;
  }

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderVesselsRevenueChart(vessels, vesselRevenueEntries, retryCount + 1), 100);
    return;
  }

  // Determine top 10 vessels by total revenue
  let top10;
  if (vessels &amp;&amp; vessels.length > 0) {
    // Use provided vessels data
    top10 = [...vessels]
      .sort((a, b) => b.totalRevenue - a.totalRevenue)
      .slice(0, 10);
  } else if (vesselRevenueEntries &amp;&amp; vesselRevenueEntries.length > 0) {
    // Calculate from entries
    const vesselTotals = new Map();
    for (const entry of vesselRevenueEntries) {
      const id = String(entry.vesselId);
      if (!vesselTotals.has(id)) {
        vesselTotals.set(id, { vesselId: id, vesselName: entry.vesselName, totalRevenue: 0 });
      }
      vesselTotals.get(id).totalRevenue += entry.value;
    }
    top10 = [...vesselTotals.values()]
      .sort((a, b) => b.totalRevenue - a.totalRevenue)
      .slice(0, 10);
  } else {
    top10 = [];
  }

  // Colors for vessels
  const colors = [
    '#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6',
    '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#a855f7'
  ];

  // Header with filter info
  const filterText = currentDays === 0 ? 'All Time' : `${currentDays} Days`;
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Top 10 Vessels - Daily Revenue (filtered by ${filterText})&lt;/span>
    &lt;/div>
  `;

  if (!vesselRevenueEntries || vesselRevenueEntries.length === 0) {
    container.innerHTML += '&lt;div class="no-data">No vessel revenue data available&lt;/div>';
    return;
  }

  // Create chart container
  const chartDiv = document.createElement('div');
  chartDiv.style.height = '300px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  // Create chart with timestamp support and zoom enabled
  vesselsRevenueChart = LightweightCharts.createChart(chartDiv, {
    autoSize: true,
    height: 300,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal
    },
    rightPriceScale: {
      borderColor: 'rgba(255,255,255,0.2)'
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: true,
      minBarSpacing: 0.0001
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  });

  // Build daily breakdown data per vessel (aggregate by day)
  const top10Ids = new Set(top10.map(v => String(v.vesselId)));
  const dailyByVessel = {};

  for (const vessel of top10) {
    dailyByVessel[vessel.vesselId] = new Map(); // day timestamp -> daily total
  }

  // Filter entries for top 10 vessels and aggregate by day
  const sortedEntries = vesselRevenueEntries
    .filter(e => top10Ids.has(String(e.vesselId)))
    .sort((a, b) => a.time - b.time);

  for (const entry of sortedEntries) {
    const vesselId = String(entry.vesselId);
    if (dailyByVessel[vesselId]) {
      // Convert timestamp to day (start of day in UTC)
      const dayTimestamp = Math.floor(entry.time / 86400) * 86400;
      const currentTotal = dailyByVessel[vesselId].get(dayTimestamp) || 0;
      dailyByVessel[vesselId].set(dayTimestamp, currentTotal + entry.value);
    }
  }

  // Create series for each vessel (daily bars/lines)
  const seriesMap = {};
  top10.forEach((vessel, i) => {
    const lineOptions = {
      color: colors[i],
      lineWidth: 2,
      lastValueVisible: true,
      priceLineVisible: false,
      priceFormat: {
        type: 'custom',
        formatter: formatChartPrice
      }
    };

    let series;
    if (typeof vesselsRevenueChart.addLineSeries === 'function') {
      series = vesselsRevenueChart.addLineSeries(lineOptions);
    } else {
      series = vesselsRevenueChart.addSeries(LightweightCharts.LineSeries, lineOptions);
    }

    // Convert daily Map to sorted array
    const dataMap = dailyByVessel[vessel.vesselId];
    const data = dataMap
      ? Array.from(dataMap.entries())
          .sort((a, b) => a[0] - b[0])
          .map(([time, value]) => ({ time, value }))
      : [];

    series.setData(data);
    seriesMap[vessel.vesselId] = series;
  });

  vesselsRevenueChart.timeScale().fitContent();

  // Add toggles under chart
  const togglesDiv = document.createElement('div');
  togglesDiv.className = 'analytics-chart-toggles';
  togglesDiv.innerHTML = top10.map((v, i) => `
    &lt;button class="analytics-chart-toggle active" data-vessel-id="${v.vesselId}" style="border-color: ${colors[i]}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${colors[i]};">&lt;/span>
      ${escapeHtml(v.name || v.vesselName)}
    &lt;/button>
  `).join('');
  container.appendChild(togglesDiv);

  // Toggle handlers
  togglesDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const vesselId = btn.dataset.vesselId;
      const isActive = btn.classList.toggle('active');
      if (seriesMap[vesselId]) {
        seriesMap[vesselId].applyOptions({ visible: isActive });
      }
    });
  });
}

/**
 * Render Bottom 10 Vessels by Daily Revenue (worst performers)
 * @param {Array|null} vessels - Vessel data (optional, can derive bottom 10 from entries)
 * @param {Array} vesselRevenueEntries - Time-series revenue entries
 */
function renderBottomVesselsRevenueChart(vessels, vesselRevenueEntries, retryCount = 0) {
  const container = document.getElementById('vessels-bottom-revenue-chart-container');
  if (!container) return;

  if (bottomVesselsRevenueChart) {
    bottomVesselsRevenueChart.remove();
    bottomVesselsRevenueChart = null;
  }

  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not loaded&lt;/div>';
    return;
  }

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderBottomVesselsRevenueChart(vessels, vesselRevenueEntries, retryCount + 1), 100);
    return;
  }

  // Determine bottom 10 vessels by total revenue (ascending)
  let bottom10;
  if (vessels &amp;&amp; vessels.length > 0) {
    // Use provided vessels data
    bottom10 = [...vessels]
      .sort((a, b) => a.totalRevenue - b.totalRevenue)
      .slice(0, 10);
  } else if (vesselRevenueEntries &amp;&amp; vesselRevenueEntries.length > 0) {
    // Calculate from entries
    const vesselTotals = new Map();
    for (const entry of vesselRevenueEntries) {
      const id = String(entry.vesselId);
      if (!vesselTotals.has(id)) {
        vesselTotals.set(id, { vesselId: id, vesselName: entry.vesselName, totalRevenue: 0 });
      }
      vesselTotals.get(id).totalRevenue += entry.value;
    }
    bottom10 = [...vesselTotals.values()]
      .sort((a, b) => a.totalRevenue - b.totalRevenue)
      .slice(0, 10);
  } else {
    bottom10 = [];
  }

  // Colors for vessels (no red - reserved for zero line)
  const colors = [
    '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899',
    '#14b8a6', '#f97316', '#06b6d4', '#a855f7', '#84cc16'
  ];

  // Header with filter info
  const filterText = currentDays === 0 ? 'All Time' : `${currentDays} Days`;
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Bottom 10 Vessels - Daily Revenue (filtered by ${filterText})&lt;/span>
    &lt;/div>
  `;

  if (!vesselRevenueEntries || vesselRevenueEntries.length === 0) {
    container.innerHTML += '&lt;div class="no-data">No vessel revenue data available&lt;/div>';
    return;
  }

  // Create chart container
  const chartDiv = document.createElement('div');
  chartDiv.style.height = '300px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  // Create chart with timestamp support and zoom enabled
  bottomVesselsRevenueChart = LightweightCharts.createChart(chartDiv, {
    autoSize: true,
    height: 300,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal
    },
    rightPriceScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      autoScale: true,
      entireTextOnly: true
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: true,
      minBarSpacing: 0.0001
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  });

  // Build daily breakdown data per vessel (aggregate by day)
  const bottom10Ids = new Set(bottom10.map(v => String(v.vesselId)));
  const dailyByVessel = {};

  for (const vessel of bottom10) {
    dailyByVessel[vessel.vesselId] = new Map(); // day timestamp -> daily total
  }

  // Filter entries for bottom 10 vessels and aggregate by day
  const sortedEntries = vesselRevenueEntries
    .filter(e => bottom10Ids.has(String(e.vesselId)))
    .sort((a, b) => a.time - b.time);

  for (const entry of sortedEntries) {
    const vesselId = String(entry.vesselId);
    if (dailyByVessel[vesselId]) {
      // Convert timestamp to day (start of day in UTC)
      const dayTimestamp = Math.floor(entry.time / 86400) * 86400;
      const currentTotal = dailyByVessel[vesselId].get(dayTimestamp) || 0;
      dailyByVessel[vesselId].set(dayTimestamp, currentTotal + entry.value);
    }
  }

  // Create series for each vessel (daily bars/lines)
  const seriesMap = {};
  bottom10.forEach((vessel, i) => {
    const lineOptions = {
      color: colors[i],
      lineWidth: 2,
      lastValueVisible: true,
      priceLineVisible: false,
      priceFormat: {
        type: 'custom',
        formatter: formatChartPrice
      }
    };

    let series;
    if (typeof bottomVesselsRevenueChart.addLineSeries === 'function') {
      series = bottomVesselsRevenueChart.addLineSeries(lineOptions);
    } else {
      series = bottomVesselsRevenueChart.addSeries(LightweightCharts.LineSeries, lineOptions);
    }

    // Convert daily Map to sorted array
    const dataMap = dailyByVessel[vessel.vesselId];
    const data = dataMap
      ? Array.from(dataMap.entries())
          .sort((a, b) => a[0] - b[0])
          .map(([time, value]) => ({ time, value }))
      : [];

    series.setData(data);
    seriesMap[vessel.vesselId] = series;
  });

  bottomVesselsRevenueChart.timeScale().fitContent();

  // Add zero line using createPriceLine on first series
  const firstVesselId = Object.keys(seriesMap)[0];
  if (firstVesselId &amp;&amp; seriesMap[firstVesselId]) {
    seriesMap[firstVesselId].createPriceLine({
      price: 0,
      color: '#ef4444',
      lineWidth: 1,
      axisLabelVisible: true
    });
  }

  // Add toggles under chart
  const togglesDiv = document.createElement('div');
  togglesDiv.className = 'analytics-chart-toggles';
  togglesDiv.innerHTML = bottom10.map((v, i) => `
    &lt;button class="analytics-chart-toggle active" data-vessel-id="${v.vesselId}" style="border-color: ${colors[i]}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${colors[i]};">&lt;/span>
      ${escapeHtml(v.name || v.vesselName)}
    &lt;/button>
  `).join('');
  container.appendChild(togglesDiv);

  // Toggle handlers
  togglesDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const vesselId = btn.dataset.vesselId;
      const isActive = btn.classList.toggle('active');
      if (seriesMap[vesselId]) {
        seriesMap[vesselId].applyOptions({ visible: isActive });
      }
    });
  });
}

/**
 * Render Fleet Composition as SVG pie chart
 * @param {Array} vessels - Vessel data
 */
function renderVesselsCompositionChart(vessels, retryCount = 0) {
  const container = document.getElementById('vessels-composition-chart-container');
  if (!container) return;

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderVesselsCompositionChart(vessels, retryCount + 1), 100);
    return;
  }

  // Calculate total revenue
  const totalRevenue = vessels.reduce((sum, v) => sum + v.totalRevenue, 0);

  // Sort and get contribution percentage - filter out vessels with 0 revenue
  const withPercent = [...vessels]
    .filter(v => v.totalRevenue > 0)
    .sort((a, b) => b.totalRevenue - a.totalRevenue)
    .map(v => ({
      ...v,
      percent: totalRevenue > 0 ? (v.totalRevenue / totalRevenue * 100) : 0
    }));

  // Cluster vessels by rounded percent (1 decimal place)
  const clusters = new Map();
  for (const v of withPercent) {
    const roundedPercent = Math.round(v.percent * 10) / 10; // Round to 0.1%
    if (!clusters.has(roundedPercent)) {
      clusters.set(roundedPercent, []);
    }
    clusters.get(roundedPercent).push(v);
  }

  // Build slices - single vessels stay single, groups become clusters
  const slices = [];
  for (const [roundedPercent, group] of clusters.entries()) {
    if (group.length === 1) {
      // Single vessel
      slices.push({
        name: group[0].name,
        totalRevenue: group[0].totalRevenue,
        percent: group[0].percent,
        vesselData: [{ name: group[0].name, vesselId: group[0].vesselId }]
      });
    } else {
      // Cluster multiple vessels
      const totalRev = group.reduce((sum, v) => sum + v.totalRevenue, 0);
      const totalPct = group.reduce((sum, v) => sum + v.percent, 0);
      slices.push({
        name: `${group.length} vessels @ ${roundedPercent.toFixed(1)}%`,
        totalRevenue: totalRev,
        percent: totalPct,
        vesselData: group.map(v => ({ name: v.name, vesselId: v.vesselId }))
      });
    }
  }

  // Sort slices by percent descending
  slices.sort((a, b) => b.percent - a.percent);

  // Colors for slices
  const colors = [
    '#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6',
    '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#a855f7',
    '#84cc16', '#e11d48', '#0ea5e9', '#d946ef', '#22c55e', '#eab308'
  ];

  // Header
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Fleet Revenue Composition&lt;/span>
    &lt;/div>
  `;

  // Create main wrapper with pie chart and treemap side by side
  const mainWrapper = document.createElement('div');
  mainWrapper.className = 'fleet-composition-wrapper';

  // Create container for pie chart with tooltip
  const chartWrapper = document.createElement('div');
  chartWrapper.className = 'fleet-pie-wrapper';

  // Create SVG pie chart (larger since no legend)
  const size = 280;
  const radius = 130;
  const centerX = size / 2;
  const centerY = size / 2;

  let paths = '';
  let currentAngle = -90; // Start at top

  // Draw slices (single vessels or clusters)
  slices.forEach((slice, i) => {
    const angle = (slice.percent / 100) * 360;
    const startAngle = currentAngle;
    const endAngle = currentAngle + angle;

    // Convert to radians
    const startRad = (startAngle * Math.PI) / 180;
    const endRad = (endAngle * Math.PI) / 180;

    // Calculate arc points
    const x1 = centerX + radius * Math.cos(startRad);
    const y1 = centerY + radius * Math.sin(startRad);
    const x2 = centerX + radius * Math.cos(endRad);
    const y2 = centerY + radius * Math.sin(endRad);

    // Large arc flag (1 if angle > 180)
    const largeArc = angle > 180 ? 1 : 0;

    // Create path with data attributes for tooltip (include vessel data for clicks)
    const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
    const vesselDataJson = JSON.stringify(slice.vesselData);
    paths += `&lt;path class="fleet-pie-path" d="${pathData}" fill="${colors[i % colors.length]}" stroke="#1f2937" stroke-width="1"
      data-name="${escapeHtml(slice.name)}"
      data-revenue="${formatCurrency(slice.totalRevenue)}"
      data-percent="${slice.percent.toFixed(1)}"
      data-vessel-data='${vesselDataJson.replace(/'/g, "&amp;#39;")}'>&lt;/path>`;

    currentAngle = endAngle;
  });

  const svgDiv = document.createElement('div');
  svgDiv.className = 'fleet-pie-svg-container';
  svgDiv.innerHTML = `&lt;svg class="fleet-pie-svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${paths}&lt;/svg>`;
  chartWrapper.appendChild(svgDiv);

  // Zoom and pan state
  let scale = 1;
  let panX = 0;
  let panY = 0;
  let isPanning = false;
  let startX = 0;
  let startY = 0;
  const svg = svgDiv.querySelector('svg');

  const updateTransform = () => {
    svg.style.transform = `scale(${scale}) translate(${panX}px, ${panY}px)`;
  };

  // Mouse wheel zoom (up to 20x for small slices)
  svgDiv.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    scale = Math.max(0.5, Math.min(20, scale * delta));
    updateTransform();
  });

  // Pan with mouse drag
  svgDiv.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    isPanning = true;
    startX = e.clientX - panX * scale;
    startY = e.clientY - panY * scale;
    svgDiv.style.cursor = 'grabbing';
  });

  svgDiv.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    panX = (e.clientX - startX) / scale;
    panY = (e.clientY - startY) / scale;
    updateTransform();
  });

  svgDiv.addEventListener('mouseup', () => {
    isPanning = false;
    svgDiv.style.cursor = 'grab';
  });

  svgDiv.addEventListener('mouseleave', () => {
    isPanning = false;
    svgDiv.style.cursor = 'grab';
  });

  // Double-click to reset
  svgDiv.addEventListener('dblclick', () => {
    scale = 1;
    panX = 0;
    panY = 0;
    updateTransform();
  });

  // Simple hover tooltip (follows mouse, summary only)
  const hoverTooltip = document.createElement('div');
  hoverTooltip.className = 'fleet-hover-tooltip';
  chartWrapper.appendChild(hoverTooltip);

  // Fixed detail panel (opens on click, stays open)
  const detailPanel = document.createElement('div');
  detailPanel.className = 'fleet-detail-panel fleet-pie-detail-panel';
  chartWrapper.appendChild(detailPanel);

  let selectedPath = null;

  const closeDetailPanel = () => {
    detailPanel.classList.remove('visible');
    if (selectedPath) {
      selectedPath.style.opacity = '1';
      selectedPath = null;
    }
  };

  const openDetailPanel = (path) => {
    // Close previous
    if (selectedPath &amp;&amp; selectedPath !== path) {
      selectedPath.style.opacity = '1';
    }

    selectedPath = path;
    path.style.opacity = '0.7';

    const name = path.dataset.name;
    const revenue = path.dataset.revenue;
    const percent = path.dataset.percent;
    const vesselData = JSON.parse(path.dataset.vesselData || '[]');

    // Build vessel list with clickable pins
    const vesselListHtml = vesselData.map(v => `
      &lt;div class="fleet-vessel-item">
        &lt;span class="fleet-vessel-name">${escapeHtml(v.name)}&lt;/span>
        &lt;button class="fleet-vessel-pin" data-vessel-id="${v.vesselId}" title="Show on map">&amp;#x1F4CD;&lt;/button>
      &lt;/div>
    `).join('');

    detailPanel.innerHTML = `
      &lt;div class="fleet-detail-header">
        &lt;span class="fleet-detail-name">${escapeHtml(name)}&lt;/span>
        &lt;button class="close-btn">&lt;span>&amp;times;&lt;/span>&lt;/button>
      &lt;/div>
      &lt;div class="fleet-detail-revenue">${revenue} (${percent}%)&lt;/div>
      &lt;div class="fleet-detail-vessels-label">Vessels (${vesselData.length}):&lt;/div>
      ${vesselListHtml}
    `;

    // Close button handler
    detailPanel.querySelector('.close-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      closeDetailPanel();
    });

    // Pin click handlers
    detailPanel.querySelectorAll('.fleet-vessel-pin').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const vesselId = parseInt(btn.dataset.vesselId, 10);
        if (window.harborMap &amp;&amp; window.harborMap.selectVesselFromPort) {
          const modal = document.getElementById('analyticsModal');
          if (modal) modal.classList.add('hidden');
          window.harborMap.selectVesselFromPort(vesselId);
        }
      });
    });

    detailPanel.classList.add('visible');
  };

  // Hover events (simple tooltip)
  svg.querySelectorAll('path').forEach(path => {
    path.addEventListener('mouseenter', () => {
      if (selectedPath === path) return; // Don't show hover tooltip for selected
      const name = path.dataset.name;
      const percent = path.dataset.percent;
      hoverTooltip.textContent = `${name} (${percent}%)`;
      hoverTooltip.classList.add('visible');
      if (selectedPath !== path) path.style.opacity = '0.85';
    });

    path.addEventListener('mousemove', (e) => {
      const rect = chartWrapper.getBoundingClientRect();
      hoverTooltip.style.left = (e.clientX - rect.left + 12) + 'px';
      hoverTooltip.style.top = (e.clientY - rect.top - 8) + 'px';
    });

    path.addEventListener('mouseleave', () => {
      hoverTooltip.classList.remove('visible');
      if (selectedPath !== path) path.style.opacity = '1';
    });

    // Click to open detail panel
    path.addEventListener('click', (e) => {
      e.stopPropagation();
      if (selectedPath === path) {
        closeDetailPanel();
      } else {
        openDetailPanel(path);
      }
    });
  });

  // Click outside to close panel
  chartWrapper.addEventListener('click', (e) => {
    if (!e.target.closest('path') &amp;&amp; !e.target.closest('.close-btn')) {
      closeDetailPanel();
    }
  });

  // Add pie chart to main wrapper
  mainWrapper.appendChild(chartWrapper);

  // === TREEMAP VISUALIZATION ===
  const treemapWrapper = document.createElement('div');
  treemapWrapper.className = 'fleet-treemap-wrapper';

  // Treemap dimensions - height matches pie chart diameter
  const treemapWidth = 320;
  const treemapHeight = 280; // Same as pie SVG size

  // Squarified treemap algorithm
  function squarify(items, x, y, width, height) {
    const rects = [];
    if (items.length === 0) return rects;

    const totalValue = items.reduce((sum, item) => sum + item.percent, 0);
    if (totalValue &lt;= 0) return rects;

    // Create a copy sorted by value descending
    const remaining = [...items].sort((a, b) => b.percent - a.percent);

    let currentX = x;
    let currentY = y;
    let remainingWidth = width;
    let remainingHeight = height;

    while (remaining.length > 0) {
      // Decide if we split horizontally or vertically
      const isWide = remainingWidth >= remainingHeight;

      // Get items for this row/column (use simple slice algorithm)
      const rowItems = [];
      let rowTotal = 0;
      const areaPerUnit = (remainingWidth * remainingHeight) / remaining.reduce((s, i) => s + i.percent, 0);

      // Take items until aspect ratio starts getting worse
      let bestAspect = Infinity;
      for (let i = 0; i &lt; remaining.length; i++) {
        const item = remaining[i];
        rowItems.push(item);
        rowTotal += item.percent;

        const rowArea = rowTotal * areaPerUnit;
        const rowSize = isWide ? rowArea / remainingHeight : rowArea / remainingWidth;
        const worstAspect = Math.max(...rowItems.map(ri => {
          const itemArea = ri.percent * areaPerUnit;
          const itemSize = itemArea / rowSize;
          return Math.max(rowSize / itemSize, itemSize / rowSize);
        }));

        if (worstAspect &lt;= bestAspect) {
          bestAspect = worstAspect;
        } else {
          // Aspect got worse, remove last item
          rowItems.pop();
          rowTotal -= item.percent;
          break;
        }
      }

      // Calculate row dimensions
      const rowAreaTotal = rowTotal * areaPerUnit;
      const rowSize = isWide
        ? Math.min(rowAreaTotal / remainingHeight, remainingWidth)
        : Math.min(rowAreaTotal / remainingWidth, remainingHeight);

      // Layout items in this row
      let itemOffset = 0;
      for (const item of rowItems) {
        const itemArea = item.percent * areaPerUnit;
        const itemSize = rowSize > 0 ? itemArea / rowSize : 0;

        let rx, ry, rw, rh;
        if (isWide) {
          rx = currentX;
          ry = currentY + itemOffset;
          rw = rowSize;
          rh = itemSize;
        } else {
          rx = currentX + itemOffset;
          ry = currentY;
          rw = itemSize;
          rh = rowSize;
        }

        rects.push({
          ...item,
          x: rx,
          y: ry,
          width: Math.max(0, rw - 1),
          height: Math.max(0, rh - 1)
        });

        itemOffset += itemSize;

        // Remove from remaining
        const idx = remaining.indexOf(item);
        if (idx > -1) remaining.splice(idx, 1);
      }

      // Update remaining area
      if (isWide) {
        currentX += rowSize;
        remainingWidth -= rowSize;
      } else {
        currentY += rowSize;
        remainingHeight -= rowSize;
      }
    }

    return rects;
  }

  // Build treemap rectangles
  const treemapRects = squarify(slices, 0, 0, treemapWidth, treemapHeight);

  // Create treemap SVG
  let treemapPaths = '';
  treemapRects.forEach((rect, i) => {
    if (rect.width &lt; 2 || rect.height &lt; 2) return; // Skip tiny rects

    const vesselDataJson = JSON.stringify(rect.vesselData);
    const showLabel = rect.width > 40 &amp;&amp; rect.height > 20;
    const labelText = showLabel ? (rect.name.length > 12 ? rect.name.substring(0, 10) + '..' : rect.name) : '';

    treemapPaths += `
      &lt;g class="fleet-treemap-cell" data-name="${escapeHtml(rect.name)}"
         data-revenue="${formatCurrency(rect.totalRevenue)}"
         data-percent="${rect.percent.toFixed(1)}"
         data-vessel-data='${vesselDataJson.replace(/'/g, "&amp;#39;")}'>
        &lt;rect x="${rect.x}" y="${rect.y}" width="${rect.width}" height="${rect.height}"
              fill="${colors[i % colors.length]}" stroke="#1f2937" stroke-width="1"/>
        ${showLabel ? `&lt;text x="${rect.x + rect.width / 2}" y="${rect.y + rect.height / 2}"
              text-anchor="middle" dominant-baseline="middle"
              fill="#fff" font-size="10" font-weight="500">${escapeHtml(labelText)}&lt;/text>` : ''}
      &lt;/g>
    `;
  });

  treemapWrapper.innerHTML = `&lt;svg width="${treemapWidth}" height="${treemapHeight}" viewBox="0 0 ${treemapWidth} ${treemapHeight}">${treemapPaths}&lt;/svg>`;

  // Treemap hover tooltip
  const treemapTooltip = document.createElement('div');
  treemapTooltip.className = 'fleet-hover-tooltip';
  treemapWrapper.appendChild(treemapTooltip);

  // Treemap detail panel
  const treemapPanel = document.createElement('div');
  treemapPanel.className = 'fleet-detail-panel fleet-treemap-detail-panel';
  treemapWrapper.appendChild(treemapPanel);

  let selectedTreemapCell = null;

  const closeTreemapPanel = () => {
    treemapPanel.classList.remove('visible');
    if (selectedTreemapCell) {
      selectedTreemapCell.querySelector('rect').style.opacity = '1';
      selectedTreemapCell = null;
    }
  };

  const openTreemapPanel = (cell) => {
    if (selectedTreemapCell &amp;&amp; selectedTreemapCell !== cell) {
      selectedTreemapCell.querySelector('rect').style.opacity = '1';
    }

    selectedTreemapCell = cell;
    cell.querySelector('rect').style.opacity = '0.7';

    const name = cell.dataset.name;
    const revenue = cell.dataset.revenue;
    const percent = cell.dataset.percent;
    const vesselData = JSON.parse(cell.dataset.vesselData || '[]');

    const vesselListHtml = vesselData.map(v => `
      &lt;div class="fleet-vessel-item">
        &lt;span class="fleet-vessel-name">${escapeHtml(v.name)}&lt;/span>
        &lt;button class="fleet-vessel-pin" data-vessel-id="${v.vesselId}" title="Show on map">&amp;#x1F4CD;&lt;/button>
      &lt;/div>
    `).join('');

    treemapPanel.innerHTML = `
      &lt;div class="fleet-detail-header">
        &lt;span class="fleet-detail-name">${escapeHtml(name)}&lt;/span>
        &lt;button class="close-btn">&lt;span>&amp;times;&lt;/span>&lt;/button>
      &lt;/div>
      &lt;div class="fleet-detail-revenue">${revenue} (${percent}%)&lt;/div>
      &lt;div class="fleet-detail-vessels-label">Vessels (${vesselData.length}):&lt;/div>
      ${vesselListHtml}
    `;

    treemapPanel.querySelector('.close-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      closeTreemapPanel();
    });

    treemapPanel.querySelectorAll('.fleet-vessel-pin').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const vesselId = parseInt(btn.dataset.vesselId, 10);
        if (window.harborMap &amp;&amp; window.harborMap.selectVesselFromPort) {
          const modal = document.getElementById('analyticsModal');
          if (modal) modal.classList.add('hidden');
          window.harborMap.selectVesselFromPort(vesselId);
        }
      });
    });

    treemapPanel.classList.add('visible');
  };

  // Treemap interactions
  treemapWrapper.querySelectorAll('.fleet-treemap-cell').forEach(cell => {
    const rect = cell.querySelector('rect');

    cell.addEventListener('mouseenter', () => {
      if (selectedTreemapCell === cell) return;
      const name = cell.dataset.name;
      const percent = cell.dataset.percent;
      treemapTooltip.textContent = `${name} (${percent}%)`;
      treemapTooltip.classList.add('visible');
      if (selectedTreemapCell !== cell) rect.style.opacity = '0.85';
    });

    cell.addEventListener('mousemove', (e) => {
      const wrapperRect = treemapWrapper.getBoundingClientRect();
      treemapTooltip.style.left = (e.clientX - wrapperRect.left + 10) + 'px';
      treemapTooltip.style.top = (e.clientY - wrapperRect.top - 8) + 'px';
    });

    cell.addEventListener('mouseleave', () => {
      treemapTooltip.classList.remove('visible');
      if (selectedTreemapCell !== cell) rect.style.opacity = '1';
    });

    cell.addEventListener('click', (e) => {
      e.stopPropagation();
      if (selectedTreemapCell === cell) {
        closeTreemapPanel();
      } else {
        openTreemapPanel(cell);
      }
    });
  });

  // Click outside to close treemap panel
  treemapWrapper.addEventListener('click', (e) => {
    if (!e.target.closest('.fleet-treemap-cell') &amp;&amp; !e.target.closest('.close-btn')) {
      closeTreemapPanel();
    }
  });

  mainWrapper.appendChild(treemapWrapper);
  container.appendChild(mainWrapper);
}

/**
 * Render Utilization Over Time chart
 * Shows individual utilization points with timestamps for zoom capability
 * @param {Array} utilizationEntries - Individual entries with {time, value, vesselName}
 */
function renderVesselsUtilizationChart(utilizationEntries, retryCount = 0) {
  const container = document.getElementById('vessels-utilization-chart-container');
  if (!container) return;

  if (vesselsUtilizationChart) {
    vesselsUtilizationChart.remove();
    vesselsUtilizationChart = null;
  }

  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not loaded&lt;/div>';
    return;
  }

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderVesselsUtilizationChart(utilizationEntries, retryCount + 1), 100);
    return;
  }

  // Filter valid entries - ensure valid timestamps (Unix seconds 2020-2030)
  const minTime = 1577836800; // 2020-01-01
  const maxTime = 1893456000; // 2030-01-01
  const validEntries = utilizationEntries ? utilizationEntries.filter(e =>
    e.time &amp;&amp; e.time >= minTime &amp;&amp; e.time &lt;= maxTime &amp;&amp;
    e.value !== null &amp;&amp; e.value !== undefined &amp;&amp; typeof e.value === 'number'
  ) : [];

  if (validEntries.length === 0) {
    container.innerHTML = `
      &lt;div class="analytics-chart-header">
        &lt;span class="analytics-chart-title">Utilization Over Time&lt;/span>
      &lt;/div>
      &lt;div class="no-data">No utilization data available&lt;/div>
    `;
    return;
  }

  // Calculate overall average for display
  const overallAvg = validEntries.reduce((sum, e) => sum + e.value, 0) / validEntries.length;

  // Header with overall average
  container.innerHTML = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Utilization Over Time&lt;/span>
      &lt;span class="analytics-chart-subtitle">Avg: ${overallAvg.toFixed(1)}% (${validEntries.length} departures)&lt;/span>
    &lt;/div>
  `;

  // Create chart container
  const chartDiv = document.createElement('div');
  chartDiv.style.height = '200px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  // Create chart with timestamp support and zoom enabled
  vesselsUtilizationChart = LightweightCharts.createChart(chartDiv, {
    autoSize: true,
    height: 200,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    rightPriceScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      scaleMargins: { top: 0.1, bottom: 0.1 }
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: true,
      minBarSpacing: 0.0001
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  });

  // Colors for utilization ranges (red to green)
  const rangeColors = {
    '0-25': '#ef4444',
    '25-50': '#f59e0b',
    '50-75': '#84cc16',
    '75-100': '#10b981'
  };

  // Categorize entries by utilization range
  // Use Maps to deduplicate timestamps (LightweightCharts requires unique timestamps)
  const rangeMaps = {
    '0-25': new Map(),
    '25-50': new Map(),
    '50-75': new Map(),
    '75-100': new Map()
  };

  validEntries.forEach(e => {
    const val = e.value;
    let rangeKey;
    if (val &lt; 25) rangeKey = '0-25';
    else if (val &lt; 50) rangeKey = '25-50';
    else if (val &lt; 75) rangeKey = '50-75';
    else rangeKey = '75-100';

    // If same timestamp exists, average the values
    if (rangeMaps[rangeKey].has(e.time)) {
      const existing = rangeMaps[rangeKey].get(e.time);
      rangeMaps[rangeKey].set(e.time, (existing + val) / 2);
    } else {
      rangeMaps[rangeKey].set(e.time, val);
    }
  });

  // Convert Maps to sorted arrays
  const rangeData = {};
  for (const key of Object.keys(rangeMaps)) {
    rangeData[key] = Array.from(rangeMaps[key].entries())
      .sort((a, b) => a[0] - b[0])
      .map(([time, value]) => ({ time, value }));
  }

  // Create scatter-like series for each range using line series with markers
  const rangeSeries = {};
  const rangeKeys = ['75-100', '50-75', '25-50', '0-25'];

  for (const key of rangeKeys) {
    const lineOptions = {
      color: rangeColors[key],
      lineWidth: 1,
      lastValueVisible: false,
      priceLineVisible: false,
      crosshairMarkerVisible: true,
      crosshairMarkerRadius: 4,
      visible: rangeData[key].length > 0, // Hide if no data
      priceFormat: {
        type: 'custom',
        formatter: (value) => `${value.toFixed(1)}%`
      }
    };

    let series;
    if (typeof vesselsUtilizationChart.addLineSeries === 'function') {
      series = vesselsUtilizationChart.addLineSeries(lineOptions);
    } else {
      series = vesselsUtilizationChart.addSeries(LightweightCharts.LineSeries, lineOptions);
    }

    // Always set data (empty array is OK)
    series.setData(rangeData[key]);
    rangeSeries[key] = series;
  }

  vesselsUtilizationChart.timeScale().fitContent();

  // Calculate totals for legend
  const totals = {
    '0-25': rangeData['0-25'].length,
    '25-50': rangeData['25-50'].length,
    '50-75': rangeData['50-75'].length,
    '75-100': rangeData['75-100'].length
  };

  // Add legend under chart
  const legendDiv = document.createElement('div');
  legendDiv.className = 'analytics-chart-toggles';
  legendDiv.innerHTML = `
    &lt;button class="analytics-chart-toggle active" data-series="75-100" style="border-color: ${rangeColors['75-100']}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${rangeColors['75-100']};">&lt;/span>
      75-100% (${totals['75-100']})
    &lt;/button>
    &lt;button class="analytics-chart-toggle active" data-series="50-75" style="border-color: ${rangeColors['50-75']}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${rangeColors['50-75']};">&lt;/span>
      50-75% (${totals['50-75']})
    &lt;/button>
    &lt;button class="analytics-chart-toggle active" data-series="25-50" style="border-color: ${rangeColors['25-50']}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${rangeColors['25-50']};">&lt;/span>
      25-50% (${totals['25-50']})
    &lt;/button>
    &lt;button class="analytics-chart-toggle active" data-series="0-25" style="border-color: ${rangeColors['0-25']}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${rangeColors['0-25']};">&lt;/span>
      0-25% (${totals['0-25']})
    &lt;/button>
  `;
  container.appendChild(legendDiv);

  // Toggle handlers
  legendDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const seriesKey = btn.dataset.series;
      btn.classList.toggle('active');
      const isVisible = btn.classList.contains('active');

      if (rangeSeries[seriesKey]) {
        rangeSeries[seriesKey].applyOptions({ visible: isVisible });
      }
    });
  });
}

/**
 * Update route filter icon visual states
 */
function updateRouteFilterIcons() {
  const activeIcon = document.getElementById('route-filter-active');
  const inactiveIcon = document.getElementById('route-filter-inactive');

  if (activeIcon) {
    activeIcon.classList.toggle('filter-enabled', routeFilterState.showActive);
    activeIcon.classList.toggle('filter-disabled', !routeFilterState.showActive);
  }
  if (inactiveIcon) {
    inactiveIcon.classList.toggle('filter-enabled', routeFilterState.showInactive);
    inactiveIcon.classList.toggle('filter-disabled', !routeFilterState.showInactive);
  }
}

/**
 * Update vessel filter icon visual states
 */
function updateVesselFilterIcons() {
  const ownedIcon = document.getElementById('vessel-filter-owned');
  const soldIcon = document.getElementById('vessel-filter-sold');

  if (ownedIcon) {
    ownedIcon.classList.toggle('filter-enabled', vesselFilterState.showOwned);
    ownedIcon.classList.toggle('filter-disabled', !vesselFilterState.showOwned);
  }
  if (soldIcon) {
    soldIcon.classList.toggle('filter-enabled', vesselFilterState.showSold);
    soldIcon.classList.toggle('filter-disabled', !vesselFilterState.showSold);
  }
}

/**
 * Render Top 10 Routes highlight boxes
 * @param {Array} routes - Route data (unsorted, we sort here)
 */
function renderTop10Routes(routes) {
  const byHourEl = document.getElementById('top-routes-by-hour');
  const byNmEl = document.getElementById('top-routes-by-nm');

  if (!byHourEl || !byNmEl || !routes || routes.length === 0) return;

  // Filter to only routes with valid data
  const validRoutes = routes.filter(r => r.avgRevenuePerHour > 0 || r.avgIncomePerNm > 0);

  // Top 10 by $/Hour
  const topByHour = [...validRoutes]
    .filter(r => r.avgRevenuePerHour > 0)
    .sort((a, b) => b.avgRevenuePerHour - a.avgRevenuePerHour)
    .slice(0, 10);

  // Top 10 by $/NM
  const topByNm = [...validRoutes]
    .filter(r => r.avgIncomePerNm > 0)
    .sort((a, b) => b.avgIncomePerNm - a.avgIncomePerNm)
    .slice(0, 10);

  // Reset headers
  const hourHeader = byHourEl.closest('.top-routes-section')?.querySelector('h4');
  if (hourHeader) hourHeader.textContent = 'Top 10 by $/Hour';

  const nmHeader = byNmEl.closest('.top-routes-section')?.querySelector('h4');
  if (nmHeader) nmHeader.textContent = 'Top 10 by $/NM';

  // Render $/Hour list
  byHourEl.innerHTML = topByHour.length > 0
    ? topByHour.map((r, i) => `
        &lt;div class="top-route-item" data-route="${escapeHtml(r.route)}" title="Click to scroll to route">
          &lt;span class="top-route-rank">${i + 1}&lt;/span>
          &lt;span class="top-route-name">${escapeHtml(r.displayRoute || r.route)}&lt;/span>
          &lt;span class="top-route-value">${formatCurrency(r.avgRevenuePerHour)}/h&lt;/span>
        &lt;/div>
      `).join('')
    : '&lt;div class="top-routes-empty">No data&lt;/div>';

  // Render $/NM list
  byNmEl.innerHTML = topByNm.length > 0
    ? topByNm.map((r, i) => `
        &lt;div class="top-route-item" data-route="${escapeHtml(r.route)}" title="Click to scroll to route">
          &lt;span class="top-route-rank">${i + 1}&lt;/span>
          &lt;span class="top-route-name">${escapeHtml(r.displayRoute || r.route)}&lt;/span>
          &lt;span class="top-route-value">$${formatNumber(Math.round(r.avgIncomePerNm))}/nm&lt;/span>
        &lt;/div>
      `).join('')
    : '&lt;div class="top-routes-empty">No data&lt;/div>';

  // Add click handlers to scroll to route in table
  document.querySelectorAll('.top-route-item').forEach(item => {
    item.addEventListener('click', () => {
      const routeKey = item.dataset.route;
      // Find row in table and scroll to it
      const row = document.querySelector(`#analytics-routes-tbody tr[data-route="${routeKey}"]`);
      if (row) {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        row.classList.add('highlight-row');
        setTimeout(() => row.classList.remove('highlight-row'), 2000);
      }
    });
  });
}

/**
 * Render route profitability table
 * @param {Array} routes - Route data
 */
function renderRouteTable(routes) {
  const tbody = document.getElementById('analytics-routes-tbody');
  if (!tbody) return;

  // Also render Top 10 boxes with original (unsorted) data
  renderTop10Routes(routes);

  if (!routes || routes.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="9" class="no-data">No route data available&lt;/td>&lt;/tr>';
    return;
  }

  // Apply route filters
  const filteredRoutes = routes.filter(r => {
    const isActive = r.isActive || r.activeVesselCount > 0;
    if (isActive &amp;&amp; !routeFilterState.showActive) return false;
    if (!isActive &amp;&amp; !routeFilterState.showInactive) return false;
    return true;
  });

  if (filteredRoutes.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="9" class="no-data">No routes match the current filter&lt;/td>&lt;/tr>';
    return;
  }

  let html = '';
  filteredRoutes.forEach(r => {
    const feeClass = r.harborFeePercent > 20 ? 'warning' : '';
    const incomePerNm = r.avgIncomePerNm ? `$${formatNumber(Math.round(r.avgIncomePerNm))}` : '-';

    // Hijacking risk from Game API + incident count from logs
    const hijackingRisk = r.hijackingRisk !== null ? r.hijackingRisk : null;
    const incidents = r.ransomIncidents !== null ? r.ransomIncidents : null;
    const hijackClass = hijackingRisk > 20 ? 'warning' : '';

    // Format: "25% (2)" with tooltips
    let hijackDisplay = '-';
    if (hijackingRisk !== null) {
      const riskSpan = `&lt;span class="hijack-risk" title="Route hijacking probability from game">${hijackingRisk}%&lt;/span>`;
      if (incidents !== null &amp;&amp; incidents > 0) {
        const incidentSpan = `&lt;span class="hijack-incidents" title="Your hijacking incidents on this route (total ransom: $${formatNumber(r.totalRansomPaid)})">(${incidents})&lt;/span>`;
        hijackDisplay = `${riskSpan} ${incidentSpan}`;
      } else {
        hijackDisplay = riskSpan;
      }
    } else if (incidents !== null &amp;&amp; incidents > 0) {
      hijackDisplay = `&lt;span class="hijack-incidents" title="Your hijacking incidents on this route (total ransom: $${formatNumber(r.totalRansomPaid)})">(${incidents})&lt;/span>`;
    }

    // Route status icon and vessel count with active vessels
    const isActive = r.isActive || r.activeVesselCount > 0;
    const statusIcon = isActive
      ? '&lt;span class="route-status active" title="Active Route">&amp;#x1F7E2;&lt;/span>'
      : '&lt;span class="route-status inactive" title="Inactive Route">&amp;#x1F578;&amp;#xFE0F;&lt;/span>';

    // Format vessel count: "5 (2)" = 5 historical, 2 currently active
    const activeCount = r.activeVesselCount || 0;
    const vesselDisplay = activeCount > 0
      ? `${r.vesselCount} &lt;span class="active-vessel-count" title="Currently ${activeCount} vessel(s) on this route">(${activeCount})&lt;/span>`
      : `${r.vesselCount}`;

    const avgPerHour = r.avgRevenuePerHour ? formatCurrency(r.avgRevenuePerHour) : '-';

    html += `
      &lt;tr data-origin="${escapeHtml(r.origin)}" data-destination="${escapeHtml(r.destination)}" data-route="${escapeHtml(r.route)}" class="${isActive ? '' : 'inactive-route'}">
        &lt;td class="route-name">${statusIcon} ${escapeHtml(r.displayRoute || r.origin + ' - ' + r.destination)}&lt;/td>
        &lt;td class="num">${vesselDisplay}&lt;/td>
        &lt;td class="num">${r.trips}&lt;/td>
        &lt;td class="num">${formatCurrency(r.totalRevenue)}&lt;/td>
        &lt;td class="num">${formatCurrency(r.avgRevenuePerTrip)}&lt;/td>
        &lt;td class="num">${avgPerHour}&lt;/td>
        &lt;td class="num">${incomePerNm}&lt;/td>
        &lt;td class="num ${hijackClass}">${hijackDisplay}&lt;/td>
        &lt;td class="num ${feeClass}">${formatPercent(r.harborFeePercent)}&lt;/td>
      &lt;/tr>
    `;
  });

  tbody.innerHTML = html;
}


// Chart series visibility state
const chartSeriesState = {
  income: true,
  profit: true,
  expenses: true,
  trips: false
};

/**
 * Format price for Y-axis (US Dollar with thousand separators)
 * @param {number} price - Price value
 * @returns {string} Formatted price
 */
function formatChartPrice(price) {
  const absPrice = Math.abs(price);
  const sign = price &lt; 0 ? '-' : '';

  if (absPrice >= 1000000) {
    return sign + '$' + (absPrice / 1000000).toFixed(1) + 'M';
  } else if (absPrice >= 1000) {
    return sign + '$' + Math.round(absPrice / 1000).toLocaleString('en-US') + 'K';
  }
  return sign + '$' + Math.round(absPrice).toLocaleString('en-US');
}

/**
 * Render revenue trend chart using TradingView Lightweight Charts
 * @param {Array} dailyData - Daily breakdown data from getMergedSummary
 */
function renderTrendChart(dailyData) {
  const container = document.getElementById('analytics-chart-container');
  if (!container) return;

  // Destroy existing chart
  destroyChart();

  if (!dailyData || dailyData.length === 0) {
    container.innerHTML = '&lt;div class="no-data">No trend data available&lt;/div>';
    return;
  }

  // Check if LightweightCharts is available
  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not loaded&lt;/div>';
    return;
  }

  // If container not visible yet (width 0), retry after short delay
  if (container.offsetWidth === 0) {
    setTimeout(() => renderTrendChart(dailyData), 100);
    return;
  }

  // Clear container and create header with title left, toggle buttons right
  const headerHtml = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Your Daily Trend&lt;/span>
      &lt;div class="analytics-chart-toggles">
        &lt;button class="analytics-chart-toggle ${chartSeriesState.income ? 'active' : ''}" data-series="income">
          &lt;span class="analytics-chart-legend-dot revenue">&lt;/span>
          Income
        &lt;/button>
        &lt;button class="analytics-chart-toggle ${chartSeriesState.profit ? 'active' : ''}" data-series="profit">
          &lt;span class="analytics-chart-legend-dot profit">&lt;/span>
          Profit
        &lt;/button>
        &lt;button class="analytics-chart-toggle ${chartSeriesState.expenses ? 'active' : ''}" data-series="expenses">
          &lt;span class="analytics-chart-legend-dot expenses">&lt;/span>
          Expenses
        &lt;/button>
        &lt;button class="analytics-chart-toggle ${chartSeriesState.trips ? 'active' : ''}" data-series="trips">
          &lt;span class="analytics-chart-legend-dot trips">&lt;/span>
          Trips
        &lt;/button>
      &lt;/div>
    &lt;/div>
  `;
  container.innerHTML = headerHtml;

  // Create chart container
  const chartDiv = document.createElement('div');
  chartDiv.style.height = '280px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  // Check which scales should be visible
  const hasMoneySeriesVisible = chartSeriesState.income || chartSeriesState.profit || chartSeriesState.expenses;
  const hasTripsVisible = chartSeriesState.trips;

  // Create chart with autoSize to handle dynamic width
  const chart = LightweightCharts.createChart(chartDiv, {
    autoSize: true,
    height: 280,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal
    },
    rightPriceScale: {
      visible: hasMoneySeriesVisible,
      borderColor: 'rgba(255,255,255,0.2)'
    },
    leftPriceScale: {
      visible: hasTripsVisible,
      borderColor: 'rgba(255,255,255,0.2)'
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: false,
      minBarSpacing: 0.0001
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  });

  // Series references
  const series = {};

  // Income area (green) - with dollar formatting
  const incomeOptions = {
    lineColor: '#10b981',
    topColor: 'rgba(16, 185, 129, 0.3)',
    bottomColor: 'rgba(16, 185, 129, 0.0)',
    lineWidth: 2,
    lastValueVisible: true,
    priceLineVisible: false,
    visible: chartSeriesState.income,
    priceFormat: {
      type: 'custom',
      formatter: formatChartPrice
    }
  };
  if (typeof chart.addAreaSeries === 'function') {
    series.income = chart.addAreaSeries(incomeOptions);
  } else {
    series.income = chart.addSeries(LightweightCharts.AreaSeries, incomeOptions);
  }

  // Profit line (blue) - with dollar formatting
  const profitOptions = {
    color: '#3b82f6',
    lineWidth: 2,
    lastValueVisible: true,
    priceLineVisible: false,
    visible: chartSeriesState.profit,
    priceFormat: {
      type: 'custom',
      formatter: formatChartPrice
    }
  };
  if (typeof chart.addLineSeries === 'function') {
    series.profit = chart.addLineSeries(profitOptions);
  } else {
    series.profit = chart.addSeries(LightweightCharts.LineSeries, profitOptions);
  }

  // Expenses line (red) - with dollar formatting
  const expensesOptions = {
    color: '#ef4444',
    lineWidth: 2,
    lastValueVisible: true,
    priceLineVisible: false,
    visible: chartSeriesState.expenses,
    priceFormat: {
      type: 'custom',
      formatter: formatChartPrice
    }
  };
  if (typeof chart.addLineSeries === 'function') {
    series.expenses = chart.addLineSeries(expensesOptions);
  } else {
    series.expenses = chart.addSeries(LightweightCharts.LineSeries, expensesOptions);
  }

  // Trips line (yellow, on left scale) - plain number format
  const tripsOptions = {
    color: '#f59e0b',
    lineWidth: 2,
    lastValueVisible: true,
    priceLineVisible: false,
    priceScaleId: 'left',
    visible: chartSeriesState.trips,
    priceFormat: {
      type: 'custom',
      formatter: (value) => Math.round(value).toString()
    }
  };
  if (typeof chart.addLineSeries === 'function') {
    series.trips = chart.addLineSeries(tripsOptions);
  } else {
    series.trips = chart.addSeries(LightweightCharts.LineSeries, tripsOptions);
  }

  // Build data from dailyData (date strings like "2025-11-29")
  // LightweightCharts can use date strings directly in format YYYY-MM-DD
  const incomeData = dailyData.map(d => ({ time: d.date, value: d.income || 0 }));
  const expensesData = dailyData.map(d => ({ time: d.date, value: d.expenses || 0 }));
  const profitData = dailyData.map(d => ({ time: d.date, value: d.net || 0 }));
  const tripsData = dailyData.map(d => ({ time: d.date, value: d.trips || 0 }));

  // Set data on series
  series.income.setData(incomeData);
  series.profit.setData(profitData);
  series.expenses.setData(expensesData);
  series.trips.setData(tripsData);

  // Fit content
  chart.timeScale().fitContent();

  // Store chart reference for cleanup
  trendChart = { chart, container: chartDiv, series };

  // Add toggle button handlers
  container.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const seriesName = btn.dataset.series;
      chartSeriesState[seriesName] = !chartSeriesState[seriesName];
      btn.classList.toggle('active', chartSeriesState[seriesName]);

      if (series[seriesName]) {
        series[seriesName].applyOptions({ visible: chartSeriesState[seriesName] });
      }

      // Update scale visibility based on which series are active
      const hasMoneyVisible = chartSeriesState.income || chartSeriesState.profit || chartSeriesState.expenses;
      const hasTripsVisible = chartSeriesState.trips;

      // Use priceScale() method for dynamic updates
      chart.priceScale('right').applyOptions({ visible: hasMoneyVisible });
      chart.priceScale('left').applyOptions({ visible: hasTripsVisible });
    });
  });
}

/**
 * Destroy trend chart
 */
function destroyChart() {
  if (trendChart) {
    if (trendChart.chart) {
      trendChart.chart.remove();
    }
    trendChart = null;
  }
}

// ============================================
// Game Transaction Log Functions
// ============================================

/**
 * Load game transaction data from lookup store
 * Note: Index building is now handled at modal level by checkAndBuildIndex()
 */
async function loadGameLogData() {
  try {
    // Fetch all lookup data in a single request (much faster than 4 separate requests)
    const allData = await getLookupAll(currentDays);

    // Extract data from combined response
    const totals = allData.totals;
    const breakdown = allData.breakdown;
    const daily = allData.daily;
    const info = allData.info;

    // Store data for export
    lookupData = { info, totals, breakdown, daily };

    renderGameLogInfo(info);
    renderGameLogDailyTable(daily);
    renderGameLogTable(breakdown);
    renderGameLogChart(analyticsData?.summary?.chartEntries);

    // Also load raw transactions for lazy loading table
    loadRawTransactions(true);
    updateRawSortIndicators();
  } catch (error) {
    console.error('[Analytics] Failed to load game log data:', error);
    showNotification('Failed to load game transaction data', 'error');
  }
}

/**
 * Render game log info (metadata from lookup store)
 * @param {Object} info - Store info
 */
function renderGameLogInfo(info) {
  const totalEl = document.getElementById('game-log-total');
  const spanEl = document.getElementById('game-log-span');
  const syncEl = document.getElementById('game-log-sync');

  if (totalEl) {
    // Always show total entries regardless of filter
    totalEl.textContent = formatNumber(info.totalEntries);
  }

  if (spanEl) {
    spanEl.textContent = info.dataSpanDays ? `${info.dataSpanDays} days` : 'No data';
  }

  if (syncEl) {
    if (info.lastSync) {
      const date = new Date(info.lastSync);
      syncEl.textContent = date.toLocaleString();
    } else {
      syncEl.textContent = 'Never';
    }
  }
}

// Game Log chart instance
let gameLogChart = null;

/**
 * Render Game Log breakdown chart showing cumulative income/expenses by type
 * Uses individual transaction timestamps for zoom capability
 * @param {Array} chartEntries - Individual transactions with {time, value, context}
 */
function renderGameLogChart(chartEntries, retryCount = 0) {
  const container = document.getElementById('game-log-chart-container');
  if (!container) return;

  // Destroy existing chart
  if (gameLogChart) {
    gameLogChart.remove();
    gameLogChart = null;
  }

  if (!chartEntries || chartEntries.length === 0) {
    container.innerHTML = '&lt;div class="no-data">No transaction data available&lt;/div>';
    return;
  }

  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not loaded&lt;/div>';
    return;
  }

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderGameLogChart(chartEntries, retryCount + 1), 100);
    return;
  }

  // Get all categories and their totals from chartEntries
  const categoryTotals = new Map();
  chartEntries.forEach(entry => {
    if (entry.context) {
      const current = categoryTotals.get(entry.context) || 0;
      categoryTotals.set(entry.context, current + Math.abs(entry.value));
    }
  });

  // Sort by absolute value and take top categories
  const sortedCategories = Array.from(categoryTotals.entries())
    .sort((a, b) => b[1] - a[1])
    .map(e => e[0]);

  // Map context names to readable labels (explicit overrides)
  const contextLabels = {
    vessels_departed: 'Departure',
    harbor_fee_on_depart: 'Harbor Fee',
    fuel_purchased: 'Fuel',
    co2_emission_quota: 'CO2',
    bulk_wear_maintenance: 'Repair',
    buy_vessel: 'Vessel Buy',
    marketing_campaign_activation: 'Marketing',
    route_fee_on_creating: 'Route Fee',
    anchor_points: 'Anchor',
    Vessel_build_Purchase: 'Vessel Build',
    bulk_vessel_major_service: 'Drydock',
    salary_payment: 'Salary',
    Sold_vessel_in_port: 'Vessel Sale',
    ad_video: 'Ad Bonus',
    hijacking: 'Ransom',
    guard_payment_on_depart: 'Guard Fee'
  };

  // Auto-format category names: "purchase_stock" -> "Purchase Stock"
  const formatCategoryLabel = (key) => {
    if (contextLabels[key]) return contextLabels[key];
    return key
      .replace(/_/g, ' ')
      .replace(/\b\w/g, c => c.toUpperCase());
  };

  // Colors for series (enough for all types)
  const seriesColors = [
    '#10b981', // green - income
    '#ef4444', // red
    '#f59e0b', // yellow
    '#3b82f6', // blue
    '#8b5cf6', // purple
    '#ec4899', // pink
    '#14b8a6', // teal
    '#f97316', // orange
    '#06b6d4', // cyan
    '#a855f7', // violet
    '#84cc16', // lime
    '#e11d48', // rose
    '#0ea5e9', // sky
    '#d946ef', // fuchsia
    '#22c55e', // green
    '#eab308'  // yellow dark
  ];

  // Header only with title
  const headerHtml = `
    &lt;div class="analytics-chart-header">
      &lt;span class="analytics-chart-title">Daily Breakdown&lt;/span>
    &lt;/div>
  `;
  container.innerHTML = headerHtml;

  // Create chart container
  const chartDiv = document.createElement('div');
  chartDiv.style.height = '350px';
  chartDiv.style.width = '100%';
  container.appendChild(chartDiv);

  // Create chart with timestamp support and zoom enabled
  gameLogChart = LightweightCharts.createChart(chartDiv, {
    autoSize: true,
    height: 350,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255,255,255,0.1)' },
      horzLines: { color: 'rgba(255,255,255,0.1)' }
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal
    },
    rightPriceScale: {
      borderColor: 'rgba(255,255,255,0.2)'
    },
    timeScale: {
      borderColor: 'rgba(255,255,255,0.2)',
      timeVisible: true,
      secondsVisible: true,
      minBarSpacing: 0.0001
    },
    handleScroll: {
      mouseWheel: true,
      pressedMouseMove: true,
      horzTouchDrag: true,
      vertTouchDrag: false
    },
    handleScale: {
      axisPressedMouseMove: true,
      mouseWheel: true,
      pinch: true
    }
  });

  // Debug: Check what data we're receiving
  logger.debug('[GameLogChart] chartEntries sample:', chartEntries.slice(0, 3));
  logger.debug('[GameLogChart] sortedCategories:', sortedCategories);

  // Filter and sort entries by time for cumulative calculation
  const minTime = 1577836800; // 2020-01-01
  const maxTime = 1893456000; // 2030-01-01
  const sortedEntries = chartEntries
    .filter(e => e.time &amp;&amp; e.time >= minTime &amp;&amp; e.time &lt;= maxTime &amp;&amp; typeof e.value === 'number')
    .sort((a, b) => a.time - b.time);

  logger.debug('[GameLogChart] After filter:', sortedEntries.length, 'entries (was', chartEntries.length, ')');

  // Build daily aggregated data per context
  // Aggregate all transactions per day - show daily totals (not cumulative)
  const dailyByContext = {};
  sortedCategories.forEach(cat => {
    dailyByContext[cat] = { dataMap: new Map() };
  });

  sortedEntries.forEach(entry => {
    if (entry.context &amp;&amp; dailyByContext[entry.context]) {
      // Convert timestamp to start of day (midnight UTC)
      const dayTimestamp = Math.floor(entry.time / 86400) * 86400;
      const currentValue = dailyByContext[entry.context].dataMap.get(dayTimestamp) || 0;
      dailyByContext[entry.context].dataMap.set(dayTimestamp, currentValue + Math.abs(entry.value));
    }
  });

  // Convert Maps to sorted arrays - daily totals, NOT cumulative
  sortedCategories.forEach(cat => {
    const dataMap = dailyByContext[cat].dataMap;
    dailyByContext[cat].data = Array.from(dataMap.entries())
      .sort((a, b) => a[0] - b[0])
      .map(([time, value]) => ({ time, value }));
  });

  const cumulativeByContext = dailyByContext;

  // Create series for each category (only those with data)
  const seriesMap = {};
  const categoriesWithData = sortedCategories.filter(cat => cumulativeByContext[cat].data.length > 0);

  categoriesWithData.forEach((cat, i) => {
    const lineOptions = {
      color: seriesColors[i % seriesColors.length],
      lineWidth: 2,
      lastValueVisible: true,
      priceLineVisible: false,
      priceFormat: {
        type: 'custom',
        formatter: formatChartPrice
      }
    };

    if (typeof gameLogChart.addLineSeries === 'function') {
      seriesMap[cat] = gameLogChart.addLineSeries(lineOptions);
    } else {
      seriesMap[cat] = gameLogChart.addSeries(LightweightCharts.LineSeries, lineOptions);
    }

    seriesMap[cat].setData(cumulativeByContext[cat].data);
  });

  gameLogChart.timeScale().fitContent();

  // Add toggles UNDER the chart (only for categories with data)
  const togglesDiv = document.createElement('div');
  togglesDiv.className = 'analytics-chart-toggles';
  togglesDiv.innerHTML = categoriesWithData.map((cat, i) => `
    &lt;button class="analytics-chart-toggle active" data-series="${cat}" style="border-color: ${seriesColors[i % seriesColors.length]}40;">
      &lt;span class="analytics-chart-legend-dot" style="background: ${seriesColors[i % seriesColors.length]};">&lt;/span>
      ${formatCategoryLabel(cat)}
    &lt;/button>
  `).join('');
  container.appendChild(togglesDiv);

  // Toggle handlers
  togglesDiv.querySelectorAll('.analytics-chart-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const seriesName = btn.dataset.series;
      const isActive = btn.classList.toggle('active');
      if (seriesMap[seriesName]) {
        seriesMap[seriesName].applyOptions({ visible: isActive });
      }
    });
  });
}

/**
 * Populate type filter dropdown dynamically from breakdown data
 * @param {Object} breakdown - Breakdown object with type names
 */
function populateTypeFilter(breakdown) {
  const typeFilter = document.getElementById('game-log-type-filter');
  if (!typeFilter) return;

  // Get current selection to preserve it
  const currentValue = typeFilter.value;

  // Get unique types from breakdown
  const types = Object.values(breakdown).map(e => e.type).sort();

  // Build options HTML
  let optionsHtml = '&lt;option value="">All&lt;/option>';
  for (const type of types) {
    optionsHtml += `&lt;option value="${escapeHtml(type)}">${escapeHtml(type)}&lt;/option>`;
  }

  typeFilter.innerHTML = optionsHtml;

  // Restore selection if still valid
  if (currentValue &amp;&amp; types.includes(currentValue)) {
    typeFilter.value = currentValue;
  }
}

/**
 * Render game log table (Breakdown by Type from Lookup)
 * @param {Object} breakdown - Breakdown object from lookup
 */
function renderGameLogTable(breakdown) {
  const tbody = document.getElementById('game-log-tbody');
  if (!tbody) return;

  // Populate type filter dropdown
  populateTypeFilter(breakdown);

  const categoryValue = document.getElementById('game-log-category-filter')?.value || '';
  const typeValue = document.getElementById('game-log-type-filter')?.value || '';

  // Convert breakdown object to array
  let entries = Object.values(breakdown);

  // Filter by category (INCOME, EXPENSE)
  if (categoryValue) {
    entries = entries.filter(e => e.value === categoryValue);
  }

  // Filter by type (Departure, Repair, Fuel, etc.)
  if (typeValue) {
    entries = entries.filter(e => e.type === typeValue);
  }

  // Sort by absolute total amount
  entries.sort((a, b) => Math.abs(b.total) - Math.abs(a.total));

  if (entries.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="5" class="analytics-empty">No entries found&lt;/td>&lt;/tr>';
    return;
  }

  // Calculate totals for percentage (separate for income and expense)
  const totalIncome = entries.filter(e => e.value === 'INCOME').reduce((sum, e) => sum + e.total, 0);
  const totalExpense = entries.filter(e => e.value === 'EXPENSE').reduce((sum, e) => sum + Math.abs(e.total), 0);

  tbody.innerHTML = entries.map(entry => {
    const amountClass = entry.value === 'INCOME' ? 'positive' : entry.value === 'EXPENSE' ? 'negative' : '';
    const categoryClass = entry.value === 'INFO' ? 'warning' : '';
    const amountStr = entry.total >= 0 ? '+' + formatCurrency(entry.total) : '-' + formatCurrency(Math.abs(entry.total));

    // Calculate percentage based on category
    let percent = 0;
    if (entry.value === 'INCOME' &amp;&amp; totalIncome > 0) {
      percent = (entry.total / totalIncome) * 100;
    } else if (entry.value === 'EXPENSE' &amp;&amp; totalExpense > 0) {
      percent = (Math.abs(entry.total) / totalExpense) * 100;
    }
    const percentStr = percent > 0 ? percent.toFixed(1) + '%' : '-';

    return `
      &lt;tr>
        &lt;td>${escapeHtml(entry.type)}&lt;/td>
        &lt;td class="num">${formatNumber(entry.count)}&lt;/td>
        &lt;td class="num ${amountClass}">${amountStr}&lt;/td>
        &lt;td class="num">${percentStr}&lt;/td>
        &lt;td class="${categoryClass}">${entry.value}&lt;/td>
      &lt;/tr>
    `;
  }).join('');
}

/**
 * Render daily breakdown table
 * @param {Array} daily - Daily breakdown array from lookup
 */
function renderGameLogDailyTable(daily) {
  const tbody = document.getElementById('game-log-daily-tbody');
  if (!tbody) return;

  if (!daily || daily.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="5" class="analytics-empty">No daily data available&lt;/td>&lt;/tr>';
    return;
  }

  tbody.innerHTML = daily.map(day => {
    const netClass = day.net >= 0 ? 'positive' : 'negative';
    const netStr = day.net >= 0 ? '+' + formatCurrency(day.net) : '-' + formatCurrency(Math.abs(day.net));

    // Format date nicely (e.g., "Dec 2, 2025")
    const dateObj = new Date(day.date + 'T00:00:00');
    const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    return `
      &lt;tr>
        &lt;td>${dateStr}&lt;/td>
        &lt;td class="num positive">+${formatCurrency(day.income)}&lt;/td>
        &lt;td class="num negative">-${formatCurrency(day.expenses)}&lt;/td>
        &lt;td class="num ${netClass}">${netStr}&lt;/td>
        &lt;td class="num">${formatNumber(day.count)}&lt;/td>
      &lt;/tr>
    `;
  }).join('');
}

/**
 * Export analytics data in specified format - includes ALL available data
 * @param {string} format - Export format: 'json', 'csv', or 'txt'
 */
async function exportAnalyticsData(format = 'json') {
  if (!analyticsData) {
    showNotification('No analytics data to export', 'warning');
    return;
  }

  showNotification('Preparing export...', 'info');

  const date = new Date().toISOString().split('T')[0];
  let blob;
  let filename;

  // Fetch ALL lookup entries (raw POD4 data) for complete export
  let allLookupEntries = [];
  try {
    const entriesResult = await getLookupEntries({
      days: currentDays,
      limit: 100000,
      offset: 0
    });
    allLookupEntries = entriesResult?.entries || [];
  } catch (err) {
    console.warn('[Analytics Export] Could not fetch lookup entries:', err);
  }

  // Ensure we have vessels and routes data (lazy load if not loaded)
  let vessels = analyticsData.vessels;
  let routes = analyticsData.routes;

  if (!vessels) {
    try {
      const result = await getAnalyticsVessels(currentDays);
      vessels = result?.vessels || [];
    } catch (err) {
      console.warn('[Analytics Export] Could not fetch vessels:', err);
      vessels = [];
    }
  }

  if (!routes) {
    try {
      const result = await getAnalyticsRoutes(currentDays);
      routes = result?.routes || [];
    } catch (err) {
      console.warn('[Analytics Export] Could not fetch routes:', err);
      routes = [];
    }
  }

  if (format === 'json') {
    // JSON: Export EVERYTHING
    const exportData = {
      exportDate: new Date().toISOString(),
      period: `${currentDays} days`,
      periodDays: currentDays,

      // Summary data
      summary: analyticsData.summary,
      detailedExpenses: analyticsData.detailedExpenses,
      dailyBreakdown: analyticsData.summary?.dailyBreakdown,

      // All vessel performance data
      vessels: vessels,

      // All route performance data
      routes: routes,

      // Game log aggregates
      gameLog: lookupData ? {
        info: lookupData.info,
        totals: lookupData.totals,
        breakdown: lookupData.breakdown
      } : null,

      // Raw lookup entries (POD4 - combined transaction data)
      rawEntries: allLookupEntries,

      // Metadata
      meta: {
        totalVessels: vessels?.length || 0,
        totalRoutes: routes?.length || 0,
        totalRawEntries: allLookupEntries.length,
        exportVersion: '2.0'
      }
    };

    blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    filename = `analytics-export-${date}.json`;

  } else if (format === 'csv') {
    const lines = [];

    // Summary section
    lines.push('=== SUMMARY ===');
    lines.push('Metric,Value');
    if (analyticsData.summary) {
      const s = analyticsData.summary;
      lines.push(`Total Income,${s.income?.total || 0}`);
      lines.push(`Total Expenses,${s.expenses?.total || 0}`);
      lines.push(`Net Profit,${s.profit?.net || 0}`);
      lines.push(`Profit Margin %,${s.profit?.margin?.toFixed(1) || 0}`);
    }
    lines.push('');

    // Vessels section - ALL vessels
    lines.push('=== VESSELS ===');
    lines.push('Name,VesselID,Trips,Revenue,Expenses,Contribution,Avg/Trip,Avg/h,Avg/nm,Utilization %,Primary Route');
    if (vessels &amp;&amp; vessels.length > 0) {
      vessels.forEach(v => {
        const name = (v.name || '').replace(/"/g, '""');
        const route = (v.primaryRoute || '').replace(/"/g, '""');
        lines.push(`"${name}",${v.vesselId || ''},${v.trips || 0},${v.totalRevenue || 0},${v.totalExpenses || 0},${v.totalContribution || 0},${Math.round(v.avgRevenuePerTrip || 0)},${Math.round(v.avgRevenuePerHour || 0)},${Math.round(v.avgRevenuePerNm || 0)},${(v.avgUtilization || 0).toFixed(1)},"${route}"`);
      });
    }
    lines.push('');

    // Routes section - ALL routes
    lines.push('=== ROUTES ===');
    lines.push('Route,Origin,Destination,Vessels,Trips,Revenue,Expenses,Contribution,Avg/Trip,$/nm,Distance,Hijack Risk %,Incidents,Total Ransom,Harbor Fee %');
    if (routes &amp;&amp; routes.length > 0) {
      routes.forEach(r => {
        const displayRoute = (r.displayRoute || r.route || '').replace(/"/g, '""');
        const hijackRisk = r.hijackingRisk !== null &amp;&amp; r.hijackingRisk !== undefined ? r.hijackingRisk : '';
        const incidents = r.ransomIncidents !== null &amp;&amp; r.ransomIncidents !== undefined ? r.ransomIncidents : '';
        const totalRansom = r.totalRansomPaid !== null &amp;&amp; r.totalRansomPaid !== undefined ? r.totalRansomPaid : '';
        lines.push(`"${displayRoute}",${r.origin || ''},${r.destination || ''},${r.vesselCount || 0},${r.trips || 0},${r.totalRevenue || 0},${r.totalExpenses || 0},${r.totalContribution || 0},${Math.round(r.avgRevenuePerTrip || 0)},${Math.round(r.avgIncomePerNm || 0)},${r.distance || ''},${hijackRisk},${incidents},${totalRansom},${(r.harborFeePercent || 0).toFixed(1)}`);
      });
    }
    lines.push('');

    // Game Log Breakdown
    if (lookupData?.breakdown &amp;&amp; lookupData.breakdown.length > 0) {
      lines.push('=== GAME LOG BREAKDOWN ===');
      lines.push('Type,Category,Count,Total');
      lookupData.breakdown.forEach(b => {
        const type = (b.type || '').replace(/"/g, '""');
        lines.push(`"${type}",${b.value || ''},${b.count || 0},${b.total || 0}`);
      });
      lines.push('');
    }

    // Raw Entries - ALL lookup entries
    if (allLookupEntries.length > 0) {
      lines.push('=== RAW ENTRIES ===');
      lines.push('ID,Timestamp,Date,Type,Category,Cash,Description,VesselName,VesselID,Origin,Destination,Context');
      allLookupEntries.forEach(e => {
        const desc = (e.description || '').replace(/"/g, '""');
        const vesselName = (e.vessel_name || '').replace(/"/g, '""');
        const context = (e.context || '').replace(/"/g, '""');
        const dateStr = e.timestamp ? new Date(e.timestamp * 1000).toISOString() : '';
        lines.push(`"${e.id || ''}",${e.timestamp || ''},"${dateStr}","${e.type || ''}",${e.value || ''},${e.cash || 0},"${desc}","${vesselName}",${e.vessel_id || ''},${e.origin || ''},${e.destination || ''},"${context}"`);
      });
    }

    blob = new Blob([lines.join('\n')], { type: 'text/csv' });
    filename = `analytics-export-${date}.csv`;

  } else if (format === 'txt') {
    const lines = [];
    lines.push(`Analytics Export - ${date}`);
    lines.push(`Period: ${currentDays === 0 ? 'All Time' : currentDays + ' days'}`);
    lines.push('');

    // Summary
    lines.push('================================================================================');
    lines.push('SUMMARY');
    lines.push('================================================================================');
    if (analyticsData.summary) {
      const s = analyticsData.summary;
      lines.push(`Total Income:    $${formatNumber(s.income?.total || 0)}`);
      lines.push(`Total Expenses:  $${formatNumber(s.expenses?.total || 0)}`);
      lines.push(`Net Profit:      $${formatNumber(s.profit?.net || 0)}`);
      lines.push(`Profit Margin:   ${(s.profit?.margin || 0).toFixed(1)}%`);
    }
    lines.push('');

    // Detailed Expenses
    if (analyticsData.detailedExpenses &amp;&amp; Object.keys(analyticsData.detailedExpenses).length > 0) {
      lines.push('--------------------------------------------------------------------------------');
      lines.push('EXPENSE BREAKDOWN');
      lines.push('--------------------------------------------------------------------------------');
      for (const [category, data] of Object.entries(analyticsData.detailedExpenses)) {
        // Skip grandTotal and netVesselCost as they're shown separately
        if (category === 'grandTotal' || category === 'netVesselCost') continue;
        // Handle both object format { total: X, count: Y } and plain numbers
        const amount = typeof data === 'object' ? (data.total || 0) : data;
        if (amount !== 0) {
          lines.push(`  ${category}: $${formatNumber(Math.abs(amount))} (${typeof data === 'object' &amp;&amp; data.count ? data.count + ' entries' : ''})`);
        }
      }
      // Show grand total if available
      if (analyticsData.detailedExpenses.grandTotal) {
        lines.push(`  --- Grand Total: $${formatNumber(analyticsData.detailedExpenses.grandTotal)}`);
      }
      lines.push('');
    }

    // Game Log Breakdown
    if (lookupData?.breakdown &amp;&amp; lookupData.breakdown.length > 0) {
      lines.push('--------------------------------------------------------------------------------');
      lines.push('GAME LOG BY TYPE');
      lines.push('--------------------------------------------------------------------------------');
      lookupData.breakdown.forEach(b => {
        const sign = b.total >= 0 ? '+' : '';
        lines.push(`  ${b.type} (${b.value}): ${b.count} entries, ${sign}$${formatNumber(b.total)}`);
      });
      lines.push('');
    }

    // ALL Vessels
    lines.push('================================================================================');
    lines.push(`VESSELS (${vessels?.length || 0} total)`);
    lines.push('================================================================================');
    if (vessels &amp;&amp; vessels.length > 0) {
      vessels.forEach((v, i) => {
        const contribution = v.totalContribution >= 0 ? `+$${formatNumber(v.totalContribution)}` : `-$${formatNumber(Math.abs(v.totalContribution))}`;
        lines.push(`${String(i + 1).padStart(3)}. ${v.name}`);
        lines.push(`     Trips: ${v.trips}, Revenue: $${formatNumber(v.totalRevenue)}, Contribution: ${contribution}`);
        lines.push(`     Avg/Trip: $${formatNumber(Math.round(v.avgRevenuePerTrip || 0))}, Avg/h: $${formatNumber(Math.round(v.avgRevenuePerHour || 0))}, Avg/nm: $${formatNumber(Math.round(v.avgRevenuePerNm || 0))}`);
        lines.push(`     Utilization: ${(v.avgUtilization || 0).toFixed(1)}%`);
        if (v.primaryRoute) {
          lines.push(`     Primary Route: ${v.primaryRoute}`);
        }
      });
    } else {
      lines.push('  No vessel data available');
    }
    lines.push('');

    // ALL Routes
    lines.push('================================================================================');
    lines.push(`ROUTES (${routes?.length || 0} total)`);
    lines.push('================================================================================');
    if (routes &amp;&amp; routes.length > 0) {
      routes.forEach((r, i) => {
        const contribution = r.totalContribution >= 0 ? `+$${formatNumber(r.totalContribution)}` : `-$${formatNumber(Math.abs(r.totalContribution))}`;
        lines.push(`${String(i + 1).padStart(3)}. ${r.displayRoute || r.route}`);
        lines.push(`     Vessels: ${r.vesselCount}, Trips: ${r.trips}, Revenue: $${formatNumber(r.totalRevenue)}`);
        lines.push(`     Contribution: ${contribution}, $/nm: $${Math.round(r.avgIncomePerNm || 0)}`);
        if (r.hijackingRisk !== null &amp;&amp; r.hijackingRisk !== undefined) {
          let hijackInfo = `     Hijack Risk: ${r.hijackingRisk}%`;
          if (r.ransomIncidents) {
            hijackInfo += `, Incidents: ${r.ransomIncidents}, Total Ransom: $${formatNumber(r.totalRansomPaid || 0)}`;
          }
          lines.push(hijackInfo);
        }
      });
    } else {
      lines.push('  No route data available');
    }
    lines.push('');

    // Raw entries summary
    lines.push('================================================================================');
    lines.push(`RAW ENTRIES (${allLookupEntries.length} total)`);
    lines.push('================================================================================');
    if (allLookupEntries.length > 0) {
      // Group by type for summary
      const byType = {};
      allLookupEntries.forEach(e => {
        const key = e.type || 'Unknown';
        if (!byType[key]) {
          byType[key] = { count: 0, total: 0 };
        }
        byType[key].count++;
        byType[key].total += e.cash || 0;
      });
      for (const [type, data] of Object.entries(byType).sort((a, b) => b[1].count - a[1].count)) {
        const sign = data.total >= 0 ? '+' : '';
        lines.push(`  ${type}: ${data.count} entries, ${sign}$${formatNumber(data.total)}`);
      }
      lines.push('');
      lines.push('(Full raw entries included in JSON/CSV export)');
    } else {
      lines.push('  No raw entry data available');
    }

    blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    filename = `analytics-export-${date}.txt`;
  }

  // Download file
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  const counts = `${vessels?.length || 0} vessels, ${routes?.length || 0} routes, ${allLookupEntries.length} entries`;
  showNotification(`Exported ${format.toUpperCase()}: ${counts}`, 'success');
}

// ============================================
// Raw Transaction Lazy Loading Functions
// ============================================

/**
 * Load raw transactions (lookup entries) with pagination
 * @param {boolean} reset - If true, reset offset and clear existing data
 */
async function loadRawTransactions(reset = true) {
  if (rawTransactionState.loading) return;

  rawTransactionState.loading = true;

  if (reset) {
    rawTransactionState.offset = 0;
    rawTransactionState.transactions = [];
    rawTransactionState.allFilteredTransactions = [];
  }

  const categoryValue = document.getElementById('game-log-category-filter')?.value || '';
  const typeValue = document.getElementById('game-log-type-filter')?.value || '';
  const hasFilter = categoryValue || typeValue;

  try {
    // When filter is active, load ALL entries to filter properly
    // Otherwise use pagination for performance
    const result = await getLookupEntries({
      days: currentDays,
      limit: hasFilter ? 50000 : rawTransactionState.limit,
      offset: hasFilter ? 0 : rawTransactionState.offset
    });

    // Handle missing or malformed response
    let entries = result?.entries || [];
    let total = result?.total || 0;

    // Filter by category (INCOME/EXPENSE) if selected
    if (categoryValue) {
      entries = entries.filter(e => e.value === categoryValue);
    }

    // Filter by type (Departure, Repair, Fuel, etc.) if selected
    if (typeValue) {
      entries = entries.filter(e => e.type === typeValue);
    }

    // Sort entries
    entries.sort((a, b) => {
      let cmp = 0;
      if (rawTransactionState.sortBy === 'time') {
        cmp = a.timestamp - b.timestamp;
      } else if (rawTransactionState.sortBy === 'type') {
        cmp = (a.type || '').localeCompare(b.type || '');
      } else if (rawTransactionState.sortBy === 'cash') {
        cmp = a.cash - b.cash;
      }
      return rawTransactionState.sortDir === 'desc' ? -cmp : cmp;
    });

    if (hasFilter) {
      // When filtering, store all filtered entries and paginate client-side
      rawTransactionState.allFilteredTransactions = entries;
      rawTransactionState.total = entries.length;
      // Show first batch
      rawTransactionState.transactions = entries.slice(0, rawTransactionState.limit);
      rawTransactionState.offset = rawTransactionState.transactions.length;
    } else {
      if (reset) {
        rawTransactionState.transactions = entries;
      } else {
        rawTransactionState.transactions = [...rawTransactionState.transactions, ...entries];
      }
      rawTransactionState.total = total;
      rawTransactionState.offset += entries.length;
    }

    const hasMore = rawTransactionState.offset &lt; rawTransactionState.total;

    renderRawTransactionsTable();
    updateRawTransactionCounts();
    updateLoadMoreButton(hasMore);

  } catch (error) {
    console.error('[Analytics] Failed to load raw transactions:', error);
    showNotification('Failed to load transactions', 'error');
  } finally {
    rawTransactionState.loading = false;
  }
}

/**
 * Load more raw transactions (append to existing)
 */
async function loadMoreRawTransactions() {
  const categoryValue = document.getElementById('game-log-category-filter')?.value || '';
  const typeValue = document.getElementById('game-log-type-filter')?.value || '';
  const hasFilter = categoryValue || typeValue;

  if (hasFilter &amp;&amp; rawTransactionState.allFilteredTransactions.length > 0) {
    // Client-side pagination for filtered data
    const nextBatch = rawTransactionState.allFilteredTransactions.slice(
      rawTransactionState.offset,
      rawTransactionState.offset + rawTransactionState.limit
    );
    rawTransactionState.transactions = [...rawTransactionState.transactions, ...nextBatch];
    rawTransactionState.offset += nextBatch.length;

    const hasMore = rawTransactionState.offset &lt; rawTransactionState.total;
    renderRawTransactionsTable();
    updateRawTransactionCounts();
    updateLoadMoreButton(hasMore);
  } else {
    // Server-side pagination for unfiltered data
    await loadRawTransactions(false);
  }
}

/**
 * Handle sort click on raw transactions table header
 * @param {string} column - Column to sort by
 */
function handleRawTransactionSort(column) {
  // Toggle direction if same column
  if (rawTransactionState.sortBy === column) {
    rawTransactionState.sortDir = rawTransactionState.sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    rawTransactionState.sortBy = column;
    rawTransactionState.sortDir = 'desc';
  }

  // Update sort indicator classes
  updateRawSortIndicators();

  // Reload from beginning with new sort
  loadRawTransactions(true);
}

/**
 * Update sort indicator CSS classes on raw table headers
 */
function updateRawSortIndicators() {
  const table = document.getElementById('game-log-raw-table');
  if (!table) return;

  table.querySelectorAll('th[data-sort]').forEach(th => {
    th.classList.remove('sort-active', 'sort-asc', 'sort-desc');

    if (th.dataset.sort === rawTransactionState.sortBy) {
      th.classList.add('sort-active');
      th.classList.add(rawTransactionState.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });
}

/**
 * Render the raw transactions table body (from lookup entries)
 */
function renderRawTransactionsTable() {
  const tbody = document.getElementById('game-log-raw-tbody');
  if (!tbody) return;

  if (rawTransactionState.transactions.length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="4" class="analytics-empty">No entries found&lt;/td>&lt;/tr>';
    return;
  }

  tbody.innerHTML = rawTransactionState.transactions.map(entry => {
    const date = new Date(entry.timestamp);
    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const amountClass = entry.value === 'INCOME' ? 'positive' : entry.value === 'EXPENSE' ? 'negative' : '';
    const amountStr = entry.cash >= 0 ? '+' + formatCurrency(entry.cash) : '-' + formatCurrency(Math.abs(entry.cash));
    const categoryClass = entry.value === 'INFO' ? 'warning' : '';

    return `
      &lt;tr class="clickable-row" data-lookup-id="${escapeHtml(entry.id)}">
        &lt;td>${escapeHtml(dateStr)}&lt;/td>
        &lt;td>${escapeHtml(entry.type)}&lt;/td>
        &lt;td class="num ${amountClass}">${amountStr}&lt;/td>
        &lt;td class="${categoryClass}">${entry.value}&lt;/td>
      &lt;/tr>
    `;
  }).join('');
}

/**
 * Update the count displays for raw transactions
 */
function updateRawTransactionCounts() {
  const countEl = document.getElementById('game-log-raw-count');
  const totalEl = document.getElementById('game-log-raw-total');

  if (countEl) {
    countEl.textContent = formatNumber(rawTransactionState.transactions.length);
  }
  if (totalEl) {
    totalEl.textContent = formatNumber(rawTransactionState.total);
  }
}

/**
 * Update hasMore state for lazy loading
 * @param {boolean} hasMore - Whether there are more transactions to load
 */
function updateLoadMoreButton(hasMore) {
  rawTransactionState.hasMore = hasMore;
  // Hide the load more button as we use IntersectionObserver now
  const btn = document.getElementById('game-log-load-more-btn');
  if (btn) {
    btn.style.display = 'none';
  }
}

/**
 * Setup IntersectionObserver for lazy loading raw transactions
 */
function setupRawTransactionsLazyLoading() {
  // Clean up existing observer
  if (rawTransactionState.observer) {
    rawTransactionState.observer.disconnect();
  }

  const analyticsContent = document.querySelector('.analytics-content');
  if (!analyticsContent) return;

  rawTransactionState.observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting &amp;&amp; rawTransactionState.hasMore &amp;&amp; !rawTransactionState.loading) {
        loadMoreRawTransactions();
      }
    });
  }, {
    root: analyticsContent,
    rootMargin: '200px',
    threshold: 0
  });

  // Observe the load more button area as the sentinel
  const loadMoreArea = document.querySelector('.game-log-load-more');
  if (loadMoreArea) {
    rawTransactionState.observer.observe(loadMoreArea);
  }
}

/**
 * Build POD2 HTML based on entry type - shows ALL relevant details
 * @param {Object} pod2 - POD2 audit log entry
 * @param {Object} lookup - Lookup entry with pod2_vessel
 * @param {Function} formatTs - Timestamp formatter
 * @param {Function} formatName - Name formatter (underscore to title case)
 * @param {Function} formatCash - Cash formatter with proper sign
 * @returns {string} HTML string
 */
function buildPod2Html(pod2, lookup, formatTs, formatName, formatCash) {
  const details = pod2.details || {};
  const autopilot = pod2.autopilot || '';
  let html = `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Time:&lt;/span> ${formatTs(pod2.timestamp)}&lt;/div>`;
  html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Action:&lt;/span> ${escapeHtml(autopilot)}&lt;/div>`;

  // Departure entries - use pod2_vessel for matched vessel details
  if (autopilot === 'Auto-Depart' || autopilot === 'Manual Depart') {
    const vessel = lookup.pod2_vessel;
    if (vessel) {
      const gross = vessel.income + Math.abs(vessel.harborFee);
      // Detect vessel type by rates (cargo can be 0 for both types)
      const isTanker = vessel.fuelRate !== undefined || vessel.crudeRate !== undefined;

      html += `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel ID:&lt;/span> ${vessel.vesselId}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Name:&lt;/span> ${escapeHtml(vessel.name)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Route:&lt;/span> ${formatName(vessel.origin)} - ${formatName(vessel.destination)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Route Name:&lt;/span> ${escapeHtml(vessel.routeName || '-')}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Utilization:&lt;/span> ${(vessel.utilization * 100).toFixed(1)}%&lt;/div>
      `;

      if (isTanker) {
        // Tanker vessel - show fuel/crude cargo in bbl
        const cargoTotal = vessel.fuelCargo + vessel.crudeCargo;
        html += `
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Capacity:&lt;/span> ${formatNumber(vessel.capacity)} bbl&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Total:&lt;/span> ${formatNumber(cargoTotal)} bbl&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Fuel:&lt;/span> ${formatNumber(vessel.fuelCargo)} bbl&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Crude:&lt;/span> ${formatNumber(vessel.crudeCargo)} bbl&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Fuel Rate:&lt;/span> $${formatNumber(vessel.fuelRate)}&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Crude Rate:&lt;/span> $${formatNumber(vessel.crudeRate)}&lt;/div>
        `;
      } else {
        // Container vessel - show dry/refrigerated cargo in TEU
        const cargoTotal = vessel.teuDry + vessel.teuRefrigerated;
        html += `
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Capacity:&lt;/span> ${formatNumber(vessel.capacity)} TEU&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Total:&lt;/span> ${formatNumber(cargoTotal)} TEU&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Dry:&lt;/span> ${formatNumber(vessel.teuDry)} TEU&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cargo Ref:&lt;/span> ${formatNumber(vessel.teuRefrigerated)} TEU&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Dry Rate:&lt;/span> $${formatNumber(vessel.dryRate)}&lt;/div>
          &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Ref Rate:&lt;/span> $${formatNumber(vessel.refRate)}&lt;/div>
        `;
      }

      html += `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Speed:&lt;/span> ${vessel.speed} kn&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Guards:&lt;/span> ${vessel.guards}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Fuel Used:&lt;/span> ${formatNumber(vessel.fuelUsed)} t&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">CO2 Used:&lt;/span> ${formatNumber(vessel.co2Used)} t&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Contribution:&lt;/span> +${vessel.contributionGained}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Income:&lt;/span> ${formatCurrency(vessel.income, true)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Harbor Fee:&lt;/span> -${formatCurrency(Math.abs(vessel.harborFee), true).replace('+', '')}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Gross:&lt;/span> ${formatCurrency(gross, true)}&lt;/div>
      `;
    }
    return html;
  }

  // Repair entries - show repairedVessels
  if (autopilot === 'Auto-Repair' || autopilot === 'Manual Bulk Repair') {
    const vessels = details.repairedVessels || [];
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    for (const v of vessels) {
      html += `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel ID:&lt;/span> ${v.id}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Name:&lt;/span> ${escapeHtml(v.name)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Wear:&lt;/span> ${v.wear}%&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cost:&lt;/span> ${formatCash(-v.cost)}&lt;/div>
      `;
    }
    return html;
  }

  // Drydock entries - show servicedVessels
  if (autopilot === 'Auto-Drydock' || autopilot === 'Manual Bulk Drydock') {
    const vessels = details.servicedVessels || [];
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    for (const v of vessels) {
      html += `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel ID:&lt;/span> ${v.id}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Name:&lt;/span> ${escapeHtml(v.name)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Service:&lt;/span> ${escapeHtml(v.serviceType || 'Major')}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cost:&lt;/span> ${formatCash(-v.cost)}&lt;/div>
      `;
    }
    return html;
  }

  // Fuel purchase
  if (autopilot === 'Auto-Fuel' || autopilot === 'Manual Fuel Purchase') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.amount) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Amount:&lt;/span> ${formatNumber(details.amount)} t&lt;/div>`;
    if (details.price) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Price:&lt;/span> $${formatNumber(details.price)}/t&lt;/div>`;
    if (details.totalCost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Total Cost:&lt;/span> ${formatCash(-details.totalCost)}&lt;/div>`;
    if (details.port) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Port:&lt;/span> ${formatName(details.port)}&lt;/div>`;
    return html;
  }

  // CO2 purchase
  if (autopilot === 'Auto-CO2' || autopilot === 'Manual CO2 Purchase') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.amount) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Amount:&lt;/span> ${formatNumber(details.amount)} t&lt;/div>`;
    if (details.price) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Price:&lt;/span> $${formatNumber(details.price)}/t&lt;/div>`;
    if (details.totalCost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Total Cost:&lt;/span> ${formatCash(-details.totalCost)}&lt;/div>`;
    return html;
  }

  // Campaign/Marketing
  if (autopilot === 'Auto-Campaign' || autopilot === 'Campaign Activation') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.campaignName) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Campaign:&lt;/span> ${escapeHtml(details.campaignName)}&lt;/div>`;
    if (details.cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cost:&lt;/span> ${formatCash(-details.cost)}&lt;/div>`;
    return html;
  }

  // Anchor purchase
  if (autopilot === 'Auto-Anchor' || autopilot === 'Manual Anchor Purchase') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.amount) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Amount:&lt;/span> ${formatNumber(details.amount)}&lt;/div>`;
    if (details.cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Cost:&lt;/span> ${formatCash(-details.cost)}&lt;/div>`;
    return html;
  }

  // Vessel purchase/sale
  if (autopilot === 'Manual Vessel Purchase' || autopilot === 'Manual Vessel Sale') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.vessel_count) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessels:&lt;/span> ${details.vessel_count}&lt;/div>`;
    if (details.total_cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Total Cost:&lt;/span> ${formatCash(-details.total_cost)}&lt;/div>`;
    if (details.total_price) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Total Price:&lt;/span> ${formatCash(details.total_price)}&lt;/div>`;
    if (details.vessels &amp;&amp; Array.isArray(details.vessels)) {
      details.vessels.forEach(v => {
        html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">${v.quantity}x ${escapeHtml(v.name)}:&lt;/span> ${formatCash(autopilot === 'Manual Vessel Sale' ? v.total_price : -v.total_price)}&lt;/div>`;
      });
    }
    return html;
  }

  // Vessel build
  if (autopilot === 'Manual Vessel Build') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.name) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Name:&lt;/span> ${escapeHtml(details.name)}&lt;/div>`;
    if (details.vessel_model) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Model:&lt;/span> ${formatName(details.vessel_model)}&lt;/div>`;
    if (details.capacity) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Capacity:&lt;/span> ${formatNumber(details.capacity)} ${details.vessel_model === 'container' ? 'TEU' : 'BBL'}&lt;/div>`;
    if (details.engine_type) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Engine:&lt;/span> ${formatName(details.engine_type)}&lt;/div>`;
    if (details.engine_kw) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Engine Power:&lt;/span> ${formatNumber(details.engine_kw)} kW&lt;/div>`;
    if (details.ship_yard) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Shipyard:&lt;/span> ${formatName(details.ship_yard)}&lt;/div>`;
    if (details.antifouling_model) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Antifouling:&lt;/span> ${formatName(details.antifouling_model)}&lt;/div>`;
    if (details.antifouling_model === null) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Antifouling:&lt;/span> None&lt;/div>`;
    if (details.bulbous !== undefined) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Bulbous Bow:&lt;/span> ${details.bulbous ? 'Yes' : 'No'}&lt;/div>`;
    if (details.enhanced_thrusters !== undefined) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Enhanced Thrusters:&lt;/span> ${details.enhanced_thrusters ? 'Yes' : 'No'}&lt;/div>`;
    if (details.propeller_types) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Propeller:&lt;/span> ${formatName(details.propeller_types)}&lt;/div>`;
    if (details.range) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Range:&lt;/span> ${formatNumber(details.range)} nm&lt;/div>`;
    if (details.build_cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Build Cost:&lt;/span> ${formatCash(-details.build_cost)}&lt;/div>`;
    return html;
  }

  // Stock purchase/sale (includes The Purser autopilot)
  if (autopilot === 'Manual Stock Purchase' || autopilot === 'Manual Stock Sale' || autopilot === 'The Purser') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.stockName) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Stock:&lt;/span> ${escapeHtml(details.stockName)}&lt;/div>`;
    if (details.company_name) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Company:&lt;/span> ${escapeHtml(details.company_name)}&lt;/div>`;
    if (details.shares) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Shares:&lt;/span> ${formatNumber(details.shares)}&lt;/div>`;
    if (details.amount) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Amount:&lt;/span> ${formatNumber(details.amount)}&lt;/div>`;
    if (details.price_per_share) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Price/Share:&lt;/span> $${details.price_per_share.toFixed(2)}&lt;/div>`;
    if (details.price) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Price:&lt;/span> ${formatCash(details.price)}&lt;/div>`;
    if (details.total_cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Stock Value:&lt;/span> ${formatCash(-details.total_cost)}&lt;/div>`;
    // Always show broker fee for stock transactions
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Broker Fee:&lt;/span> 5% (included in transaction)&lt;/div>`;
    return html;
  }

  // Hijacking/Ransom
  if (autopilot === 'Auto-Blackbeard' || autopilot === 'Manual Ransom' || autopilot === 'Manual Pay Ransom') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.vesselName) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel:&lt;/span> ${escapeHtml(details.vesselName)}&lt;/div>`;
    if (details.case_id) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Case ID:&lt;/span> ${details.case_id}&lt;/div>`;
    if (details.caseId) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Case ID:&lt;/span> ${details.caseId}&lt;/div>`;
    if (details.initialDemand) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Initial Demand:&lt;/span> ${formatCash(-details.initialDemand)}&lt;/div>`;
    if (details.expected_amount) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Expected:&lt;/span> ${formatCash(-details.expected_amount)}&lt;/div>`;
    if (details.finalPayment) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Final Payment:&lt;/span> ${formatCash(-details.finalPayment)}&lt;/div>`;
    if (details.amount_paid) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Amount Paid:&lt;/span> ${formatCash(-details.amount_paid)}&lt;/div>`;
    if (details.negotiationRounds) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Rounds:&lt;/span> ${details.negotiationRounds}&lt;/div>`;
    if (details.payment_verified !== undefined) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Verified:&lt;/span> ${details.payment_verified ? 'Yes' : 'No'}&lt;/div>`;
    return html;
  }

  // Route Planner
  if (autopilot === 'Manual Route Planner') {
    html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
    if (details.vessel_name) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel:&lt;/span> ${escapeHtml(details.vessel_name)}&lt;/div>`;
    if (details.vessel_id) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel ID:&lt;/span> ${details.vessel_id}&lt;/div>`;
    if (details.route_origin) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Origin:&lt;/span> ${formatName(details.route_origin)}&lt;/div>`;
    if (details.route_destination) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Destination:&lt;/span> ${formatName(details.route_destination)}&lt;/div>`;
    if (details.route_distance) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Distance:&lt;/span> ${formatNumber(details.route_distance)} nm&lt;/div>`;
    if (details.route_speed) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Speed:&lt;/span> ${details.route_speed} kn&lt;/div>`;
    if (details.route_guards) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Guards:&lt;/span> ${details.route_guards}&lt;/div>`;
    if (details.route_fee) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Route Fee:&lt;/span> ${formatCash(-details.route_fee)}&lt;/div>`;
    if (details.channel_cost) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Channel Cost:&lt;/span> ${formatCash(-details.channel_cost)}&lt;/div>`;
    if (details.total_fee) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Total Fee:&lt;/span> ${formatCash(-details.total_fee)}&lt;/div>`;
    if (details.staff_discount_percent) html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Staff Discount:&lt;/span> ${details.staff_discount_percent}% (CFO Training)&lt;/div>`;
    return html;
  }

  // Fallback: show summary and all details as key-value pairs
  html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Summary:&lt;/span> ${escapeHtml(pod2.summary || '')}&lt;/div>`;
  for (const [key, value] of Object.entries(details)) {
    if (value !== null &amp;&amp; value !== undefined &amp;&amp; !Array.isArray(value) &amp;&amp; typeof value !== 'object') {
      html += `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">${formatName(key)}:&lt;/span> ${escapeHtml(String(value))}&lt;/div>`;
    }
  }
  return html;
}

/**
 * Show details for a lookup entry from all PODs
 * @param {string} lookupId - Lookup entry ID
 */
async function showLookupEntryDetails(lookupId) {
  try {
    const details = await getLookupDetails(lookupId);
    if (!details) {
      showNotification('Entry not found', 'error');
      return;
    }

    const { lookup, pod1, pod2, pod3 } = details;

    // Format timestamp helper
    const formatTs = (ts) => {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    };

    // Helper to format underscore names (harbor_fee_on_depart -> Harbor Fee On Depart)
    const formatName = (name) => {
      if (!name) return '-';
      return name.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    };

    // Helper to format cash with proper sign placement (-$69.5K not $-69.5K)
    const formatCash = (amount) => {
      if (amount >= 0) {
        return formatCurrency(amount, true);
      }
      return `-${formatCurrency(Math.abs(amount), true).replace('+', '')}`;
    };

    // Build POD sections
    let pod1Html = '&lt;div class="lookup-pod-empty">No game transaction data&lt;/div>';
    if (pod1) {
      let extraInfo = '';
      // Guard Fee: calculate number of guards ($1000 per guard)
      if (pod1.context === 'guard_payment_on_depart') {
        const guards = Math.abs(pod1.cash) / 1000;
        extraInfo = `&lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Guards:&lt;/span> ${guards}&lt;/div>`;
      }
      pod1Html = `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Time:&lt;/span> ${formatTs(pod1.time * 1000)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Context:&lt;/span> ${formatName(pod1.context)}&lt;/div>
        ${extraInfo}
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Gross:&lt;/span> ${formatCash(pod1.cash)}&lt;/div>
      `;
    }

    let pod2Html = '&lt;div class="lookup-pod-empty">No audit log match&lt;/div>';
    if (pod2) {
      pod2Html = buildPod2Html(pod2, lookup, formatTs, formatName, formatCash);
    } else if (details.messengerFallback &amp;&amp; lookup.context === 'hijacking') {
      // Fallback for hijacking: show vessel info from messenger
      const mf = details.messengerFallback;
      pod2Html = `
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Source:&lt;/span> Messenger (no audit log)&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel:&lt;/span> ${escapeHtml(mf.vessel_name)}&lt;/div>
        &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Case ID:&lt;/span> ${mf.case_id}&lt;/div>
      `;
    }

    // POD3 (Vessel History) only relevant for departure-related contexts
    const hasPod3 = ['vessels_departed', 'harbor_fee_on_depart', 'guard_payment_on_depart'].includes(lookup.context);

    // POD2 (Audit Log) not relevant for game-only transactions
    const hasPod2 = !['ad_video', 'daily_bonus', 'salary_payment'].includes(lookup.context);
    let pod3Html = '';
    if (hasPod3) {
      if (pod3) {
        const vessel = lookup.pod3_vessel;
        if (vessel) {
          // Show matched vessel details from history (game API only has income, no harborFee)
          pod3Html = `
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Time:&lt;/span> ${formatTs(pod3.timestamp)}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel:&lt;/span> ${escapeHtml(vessel.name)}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Route:&lt;/span> ${formatName(vessel.origin)} - ${formatName(vessel.destination)}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Income:&lt;/span> ${formatCurrency(vessel.income, true)}&lt;/div>
          `;
        } else {
          // Fallback to entry-level data
          pod3Html = `
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Time:&lt;/span> ${formatTs(pod3.timestamp)}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Vessel:&lt;/span> ${escapeHtml(pod3.vesselName || '-')}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Route:&lt;/span> ${formatName(pod3.origin)} - ${formatName(pod3.destination)}&lt;/div>
            &lt;div class="lookup-pod-row">&lt;span class="lookup-pod-label">Income:&lt;/span> ${formatCurrency(pod3.revenue, true)}&lt;/div>
          `;
        }
      } else {
        pod3Html = '&lt;div class="lookup-pod-empty">No vessel history match&lt;/div>';
      }
    }

    // Build layout based on which PODs are relevant
    let podsHtml = '';
    if (hasPod3) {
      // Departure: POD1 + POD3 side by side, POD2 below
      podsHtml = `
        &lt;div class="lookup-details-pods-row">
          &lt;div class="lookup-pod-section">
            &lt;h4>POD1: Game Transaction&lt;/h4>
            ${pod1Html}
          &lt;/div>
          &lt;div class="lookup-pod-section">
            &lt;h4>POD3: Vessel History&lt;/h4>
            ${pod3Html}
          &lt;/div>
        &lt;/div>
        &lt;div class="lookup-details-pods-full">
          &lt;div class="lookup-pod-section lookup-pod-section-wide">
            &lt;h4>POD2: Audit Log&lt;/h4>
            &lt;div class="lookup-pod-two-columns">
              ${pod2Html}
            &lt;/div>
          &lt;/div>
        &lt;/div>
      `;
    } else if (hasPod2) {
      // Has POD2 but no POD3: POD1 + POD2 side by side
      podsHtml = `
        &lt;div class="lookup-details-pods-row">
          &lt;div class="lookup-pod-section">
            &lt;h4>POD1: Game Transaction&lt;/h4>
            ${pod1Html}
          &lt;/div>
          &lt;div class="lookup-pod-section">
            &lt;h4>POD2: Audit Log&lt;/h4>
            ${pod2Html}
          &lt;/div>
        &lt;/div>
      `;
    } else {
      // POD1 only (Ad Bonus, Daily Bonus)
      podsHtml = `
        &lt;div class="lookup-details-pods-full">
          &lt;div class="lookup-pod-section">
            &lt;h4>POD1: Game Transaction&lt;/h4>
            ${pod1Html}
          &lt;/div>
        &lt;/div>
      `;
    }

    // Create modal content
    const modalHtml = `
      &lt;div class="lookup-details-modal">
        &lt;div class="messenger-header">
          &lt;h2>Entry Details&lt;/h2>
          &lt;button class="lookup-details-close close-btn">&lt;span>&amp;times;&lt;/span>&lt;/button>
        &lt;/div>
        &lt;div class="lookup-details-summary">
          &lt;div class="lookup-summary-row">&lt;span class="lookup-pod-label">Type:&lt;/span> ${escapeHtml(lookup.type)}&lt;/div>
          &lt;div class="lookup-summary-row">&lt;span class="lookup-pod-label">Category:&lt;/span> ${lookup.value}&lt;/div>
          &lt;div class="lookup-summary-row">&lt;span class="lookup-pod-label">Amount:&lt;/span> ${formatCash(lookup.cash)}&lt;/div>
          &lt;div class="lookup-summary-row">&lt;span class="lookup-pod-label">Time:&lt;/span> ${formatTs(lookup.timestamp)}&lt;/div>
        &lt;/div>
        ${podsHtml}
      &lt;/div>
    `;

    // Show modal
    let overlay = document.getElementById('lookup-details-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'lookup-details-overlay';
      overlay.className = 'lookup-details-overlay';
      document.body.appendChild(overlay);
    }
    overlay.innerHTML = modalHtml;
    overlay.classList.remove('hidden');

    // Close handlers
    overlay.querySelector('.lookup-details-close').addEventListener('click', () => {
      overlay.classList.add('hidden');
    });
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.classList.add('hidden');
      }
    });

  } catch (error) {
    console.error('[Analytics] Failed to load entry details:', error);
    showNotification('Failed to load entry details', 'error');
  }
}

/**
 * Show info tooltip for route vessels column
 * @param {HTMLElement} iconElement - The info icon element
 */
function showRouteVesselsInfoTooltip(iconElement) {
  // Remove existing tooltip if any
  const existingTooltip = document.querySelector('.route-info-tooltip');
  if (existingTooltip) {
    existingTooltip.remove();
    return; // Toggle off
  }

  // Create tooltip
  const tooltip = document.createElement('div');
  tooltip.className = 'route-info-tooltip';
  tooltip.innerHTML = `
    &lt;div class="route-info-content">
      &lt;div class="route-info-title">Route Table Legend&lt;/div>
      &lt;div class="route-info-section">
        &lt;div class="route-info-row">&lt;span class="route-status active">&amp;#x1F7E2;&lt;/span> &lt;strong>Active Route&lt;/strong> - Vessels currently sailing this route&lt;/div>
        &lt;div class="route-info-row">&lt;span class="route-status inactive">&amp;#x1F578;&amp;#xFE0F;&lt;/span> &lt;strong>Inactive Route&lt;/strong> - Historical route, no vessels currently assigned&lt;/div>
      &lt;/div>
      &lt;div class="route-info-section">
        &lt;div class="route-info-row">&lt;strong>Vessels:&lt;/strong> Total unique vessels that have sailed this route&lt;/div>
        &lt;div class="route-info-row">&lt;strong>(n):&lt;/strong> Number of vessels currently active on this route&lt;/div>
      &lt;/div>
      &lt;div class="route-info-hint">Click anywhere to close&lt;/div>
    &lt;/div>
  `;

  // Position tooltip below icon
  const rect = iconElement.getBoundingClientRect();
  const analyticsContent = document.querySelector('.analytics-content');
  const contentRect = analyticsContent ? analyticsContent.getBoundingClientRect() : { left: 0, top: 0 };

  tooltip.style.position = 'absolute';
  tooltip.style.left = (rect.left - contentRect.left - 100) + 'px';
  tooltip.style.top = (rect.bottom - contentRect.top + 8) + 'px';
  tooltip.style.zIndex = '1000';

  // Append to analytics content for proper positioning
  if (analyticsContent) {
    analyticsContent.appendChild(tooltip);
  } else {
    document.body.appendChild(tooltip);
  }

  // Close on click anywhere
  const closeHandler = (e) => {
    if (!tooltip.contains(e.target) || e.target.closest('.route-info-hint')) {
      tooltip.remove();
      document.removeEventListener('click', closeHandler);
    }
  };
  // Delay adding listener to prevent immediate close
  setTimeout(() => document.addEventListener('click', closeHandler), 10);
}

// ============================================
// API STATS TAB (develMode only)
// ============================================

/**
 * Add API Stats tab button dynamically when develMode is enabled
 */
function addApiStatsTab() {
  const tabsContainer = document.querySelector('.analytics-tabs');
  if (!tabsContainer) return;

  // Check if tab already exists
  if (document.querySelector('[data-tab="api-stats"]')) return;

  // Find the controls div and insert button before it
  const controlsDiv = tabsContainer.querySelector('.analytics-controls');

  const tabBtn = document.createElement('button');
  tabBtn.className = 'analytics-tab-btn';
  tabBtn.dataset.tab = 'api-stats';
  tabBtn.textContent = 'API Stats';

  if (controlsDiv) {
    tabsContainer.insertBefore(tabBtn, controlsDiv);
  } else {
    tabsContainer.appendChild(tabBtn);
  }

  // Add click handler
  tabBtn.addEventListener('click', () => {
    switchTab('api-stats');
  });

  // Setup API Stats controls
  setupApiStatsControls();
}

/**
 * Setup API Stats tab controls
 */
function setupApiStatsControls() {
  const hoursSelect = document.getElementById('apiStatsHoursSelect');
  const refreshBtn = document.getElementById('apiStatsRefreshBtn');

  if (hoursSelect) {
    hoursSelect.addEventListener('change', () => {
      loadApiStats();
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      loadApiStats();
    });
  }
}

/**
 * Load API stats data
 */
async function loadApiStats() {
  const loadingEl = document.getElementById('apiStatsLoading');
  const contentEl = document.getElementById('apiStatsContent');
  const hoursSelect = document.getElementById('apiStatsHoursSelect');

  if (!loadingEl || !contentEl) return;

  const hours = hoursSelect ? parseFloat(hoursSelect.value) : 24;

  loadingEl.classList.remove('hidden');
  contentEl.classList.add('hidden');

  try {
    const [stats, datesInfo] = await Promise.all([
      getApiStats(hours),
      getApiStatsDates()
    ]);

    renderApiStatsSummary(stats, hours, datesInfo.dates);
    renderApiStatsChart(stats);
    renderApiStatsTable(stats);

    loadingEl.classList.add('hidden');
    contentEl.classList.remove('hidden');
  } catch (error) {
    console.error('[Analytics] Error loading API stats:', error);
    loadingEl.innerHTML = '&lt;div class="error">Failed to load API stats&lt;/div>';
  }
}

/**
 * Render API stats summary metrics
 */
function renderApiStatsSummary(stats, hours, dates) {
  const totalCallsEl = document.getElementById('apiStatsTotalCalls');
  const totalErrorsEl = document.getElementById('apiStatsTotalErrors');
  const callsPerHourEl = document.getElementById('apiStatsCallsPerHour');
  const availableDaysEl = document.getElementById('apiStatsAvailableDays');

  if (totalCallsEl) {
    totalCallsEl.textContent = formatNumber(stats.totalCalls);
  }
  if (totalErrorsEl) {
    totalErrorsEl.textContent = formatNumber(stats.totalErrors);
    totalErrorsEl.classList.toggle('negative', stats.totalErrors > 0);
  }
  if (callsPerHourEl) {
    const callsPerHour = hours > 0 ? Math.round(stats.totalCalls / hours) : 0;
    callsPerHourEl.textContent = formatNumber(callsPerHour);
  }
  if (availableDaysEl) {
    availableDaysEl.textContent = dates ? dates.length : 0;
  }
}

/**
 * Render API stats chart using LightweightCharts (minute-level data)
 */
function renderApiStatsChart(stats, retryCount = 0) {
  const container = document.getElementById('apiStatsChartContainer');
  if (!container) return;

  // Destroy previous chart if exists
  if (apiStatsChart) {
    apiStatsChart.remove();
    apiStatsChart = null;
  }

  // Clear container
  container.innerHTML = '';

  if (!stats || !stats.timeSeries || stats.timeSeries.length === 0) {
    container.innerHTML = '&lt;div class="no-data">No data available&lt;/div>';
    return;
  }

  // Check if LightweightCharts is available
  if (typeof LightweightCharts === 'undefined') {
    container.innerHTML = '&lt;div class="no-data">Chart library not available&lt;/div>';
    return;
  }

  // Check if container is visible and has valid dimensions (max 10 retries)
  const rect = container.getBoundingClientRect();
  if ((rect.width &lt; 100 || !container.offsetParent) &amp;&amp; retryCount &lt; 10) {
    setTimeout(() => renderApiStatsChart(stats, retryCount + 1), 100);
    return;
  }

  // Prepare data for chart - convert to Unix timestamps
  // minute format is "2025-12-05 01:30" (YYYY-MM-DD HH:mm)
  const data = stats.timeSeries.map(m => {
    // Parse "2025-12-05 01:30" -> "2025-12-05T01:30:00"
    const isoString = m.minute.replace(' ', 'T') + ':00';
    const date = new Date(isoString);
    return {
      time: Math.floor(date.getTime() / 1000),
      value: m.total
    };
  }).filter(d => !isNaN(d.time)).sort((a, b) => a.time - b.time);

  // Create chart
  apiStatsChart = LightweightCharts.createChart(container, {
    height: 180,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#9ca3af',
      attributionLogo: false
    },
    grid: {
      vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
      horzLines: { color: 'rgba(255, 255, 255, 0.05)' }
    },
    timeScale: {
      timeVisible: true,
      secondsVisible: false
    },
    rightPriceScale: {
      borderVisible: false
    },
    handleScroll: true,
    handleScale: true
  });

  // Add line series (version-compatible)
  const lineOptions = {
    color: 'rgba(59, 130, 246, 1)',
    lineWidth: 2,
    priceFormat: {
      type: 'volume'
    }
  };

  let series;
  if (typeof apiStatsChart.addLineSeries === 'function') {
    series = apiStatsChart.addLineSeries(lineOptions);
  } else {
    series = apiStatsChart.addSeries(LightweightCharts.LineSeries, lineOptions);
  }

  series.setData(data);
  apiStatsChart.timeScale().fitContent();
}

/**
 * Render API stats endpoint table
 */
function renderApiStatsTable(stats) {
  const tbody = document.getElementById('apiStatsEndpointsTbody');
  if (!tbody) return;

  if (!stats.byEndpoint || Object.keys(stats.byEndpoint).length === 0) {
    tbody.innerHTML = '&lt;tr>&lt;td colspan="5" class="no-data">No endpoint data&lt;/td>&lt;/tr>';
    return;
  }

  // Sort endpoints by call count descending
  const endpoints = Object.entries(stats.byEndpoint)
    .sort((a, b) => b[1].count - a[1].count);

  const totalCalls = stats.totalCalls;

  tbody.innerHTML = endpoints.map(([endpoint, data]) => {
    const percent = totalCalls > 0 ? ((data.count / totalCalls) * 100).toFixed(1) : 0;
    const errorClass = data.errors > 0 ? 'negative' : '';

    return `
      &lt;tr>
        &lt;td class="endpoint-name">${escapeHtml(endpoint)}&lt;/td>
        &lt;td class="num">${formatNumber(data.count)}&lt;/td>
        &lt;td class="num ${errorClass}">${data.errors}&lt;/td>
        &lt;td class="num">${data.avgDuration}ms&lt;/td>
        &lt;td class="num">${percent}%&lt;/td>
      &lt;/tr>
    `;
  }).join('');
}

// Expose functions to window for onclick handlers
window.analytics = window.analytics || {};
window.analytics.closeSoldVesselPanel = closeSoldVesselPanel;

// Export for global access
export { loadAnalyticsData };
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

</body>
</html>
