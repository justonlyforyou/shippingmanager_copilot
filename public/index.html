<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öì Shipping Manager - CoPilot</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <!-- CSS Files - Load in correct order -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/chat.css">
    <link rel="stylesheet" href="/css/overlays.css">
    <link rel="stylesheet" href="/css/company-profile.css">
    <link rel="stylesheet" href="/css/stock-manager.css">
    <link rel="stylesheet" href="/css/analytics.css">
    <link rel="stylesheet" href="/css/notifications.css">
    <link rel="stylesheet" href="/css/vessels.css">
    <link rel="stylesheet" href="/css/depart-manager.css">
    <link rel="stylesheet" href="/css/route-planner.css">
    <link rel="stylesheet" href="/css/price-display.css">
    <link rel="stylesheet" href="/css/autopilot.css">
    <link rel="stylesheet" href="/css/campaigns.css">
    <link rel="stylesheet" href="/css/alliance-coop.css">
    <link rel="stylesheet" href="/css/alliance-info.css">
    <link rel="stylesheet" href="/css/alliance-league.css">
    <link rel="stylesheet" href="/css/alliance-search.css">
    <link rel="stylesheet" href="/css/alliance-management.css">
    <link rel="stylesheet" href="/css/logbook.css">
    <link rel="stylesheet" href="/css/harbor-map.css">
    <link rel="stylesheet" href="/css/settings.css">
    <link rel="stylesheet" href="/css/appearance.css">
    <link rel="stylesheet" href="/css/mobile.css">
</head>
<body>
    <!-- Hidden Badge Elements (for badge-manager.js sync) -->
    <div id="hiddenBadges" style="display: none;">
        <span id="vesselCount"></span>
        <span id="anchorCount"></span>
        <span id="repairCount"></span>
        <span id="drydockCount"></span>
        <span id="pendingVesselsBadge"></span>
        <span id="unreadBadge"></span>
        <span id="hijackingBadge"></span>
        <span id="campaignsCount"></span>
        <span id="coopBadge"></span>
        <span id="allianceChatBadge"></span>
    </div>

    <!-- Price Alerts (center, with spin animation) -->
    <div id="globalFeedback"></div>

    <!-- Side Notifications (right-top, stacking) -->
    <div id="sideNotifications"></div>

    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>
                    <span class="header-text">
                        <div class="ceo-level-container">
                            <span id="ceoLevelBadge" class="ceo-level-badge">
                                <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" class="ceo-level-badge__svg">
                                    <defs>
                                        <clippath id="starClip">
                                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                        </clippath>
                                    </defs>
                                    <!-- Background star (empty/outline) -->
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="rgba(251, 191, 36, 0.2)" stroke="#f59e0b" stroke-width="0.5"/>
                                    <!-- XP Progress fill (grows from left to right using clip-path) -->
                                    <rect id="ceoLevelFill" x="0" y="0" width="0" height="24" fill="#fbbf24" clip-path="url(#starClip)" class="ceo-level-badge__fill"/>
                                    <!-- Star outline on top -->
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="none" stroke="#f59e0b" stroke-width="0.5"/>
                                </svg>
                                <span id="ceoLevelNumber" class="ceo-level-badge__number"></span>
                            </span>
                            <div id="pageHeaderTitle">Shipping Manager - CoPilot</div>
                        </div>
                        <div class="header-bunker-displays">
                            <div class="bunker-group">
                                <button id="fuelBtn" class="action-btn bunker-btn header-bunker-btn">
                                    <div id="fuelFill" class="bunker-fill"></div>
                                    <span class="bunker-content">‚õΩ <span id="fuelDisplay"></span></span>
                                </button>
                                <span id="fuelPriceDisplay"></span>
                            </div>
                            <div class="bunker-group">
                                <button id="co2Btn" class="action-btn bunker-btn header-bunker-btn">
                                    <div id="co2Fill" class="bunker-fill"></div>
                                    <span class="bunker-content">üí® <span id="co2Display"></span></span>
                                </button>
                                <span id="co2PriceDisplay"></span>
                            </div>
                        </div>
                    </span>
                    <button id="notificationBtn" class="megaphone-btn">
                        <span class="megaphone-icon"></span>
                        <span class="sound-waves"></span>
                    </button>
                    <script>
                        // Set correct state immediately to avoid flicker
                        (function() {
                            const btn = document.getElementById('notificationBtn');
                            if (Notification.permission !== "granted") {
                                // Show red disabled megaphone
                                btn.classList.add('disabled');
                                btn.style.display = '';
                            } else {
                                // Hide button completely
                                btn.style.display = 'none';
                            }
                        })();
                    </script>
                </h1>
                <div class="header-right">
                </div>
            </div>
            <div class="header-info-displays">
                <div class="header-info-item header-info-points">
                    <span class="header-info-icon">üíé</span>
                    <span class="header-info-value" id="pointsDisplay"></span>
                </div>
                <div class="header-info-item header-info-cash">
                    <span class="header-info-icon">üí∞</span>
                    <span class="header-info-value" id="cashDisplay"></span>
                </div>
                <div class="header-info-item header-info-stock" id="stockContainer">
                    <span class="header-info-icon">üìà</span>
                    <span class="header-info-value" id="stockDisplay"></span>
                    <span class="header-info-trend" id="stockTrend"></span>
                </div>
                <div class="header-info-item header-info-anchor">
                    <span class="header-info-icon">‚öì</span>
                    <span class="header-info-value" id="anchorSlotsDisplay"></span>
                </div>
                <div class="header-info-item header-info-hijacked" id="hijackedVesselsDisplay">
                    <span class="header-info-icon" id="hijackedIcon">‚ò†Ô∏è</span>
                    <span class="header-info-value" id="hijackedCount"></span>
                </div>
            </div>
            <div id="eventBannerContainer"></div>
        </div>

        <!-- Main Harbor Map Area -->
        <div class="chat-area-wrapper">
            <!-- Leaflet Map Container (now main content) -->
            <div id="harborMapCanvas" class="harbor-map-canvas">
                <!-- Custom Controls (will be positioned by Leaflet) -->
                <div id="mapCustomControls"></div>

                <!-- Floating Icon Bar (Desktop: horizontal top-right, Mobile: vertical right) -->
                <div id="mapIconBar" class="map-icon-bar">
                    <div class="map-icon-item" data-action="departAll" title="Depart all vessels from harbor">
                        üö¢
                        <span class="map-icon-badge hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="anchor" title="Purchase anchor points">
                        ‚öì
                        <span class="map-icon-badge hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="repairAll" title="Repair all vessels with high wear">
                        üîß
                        <span class="map-icon-badge hidden"></span>
                        <span class="map-icon-badge-bottom-left hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="buyVessels" title="Buy vessels">
                        ‚õ¥Ô∏è
                        <span class="map-icon-plus">+</span>
                        <span class="map-icon-badge map-badge-orange hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="sellVessels" title="Sell vessels">
                        ‚õ¥Ô∏è
                        <span class="map-icon-minus">-</span>
                    </div>
                    <div class="map-icon-item" data-action="messenger" title="View all private messages">
                        üì¨
                        <span class="map-icon-badge map-badge-red hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="hijacking" title="Blackbeard's Phone Booth">
                        ‚ò†Ô∏è
                        <span class="map-icon-badge map-badge-red hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="campaigns" title="Marketing campaigns status">
                        üìä
                        <span class="map-icon-badge hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="coop" title="Cargo Comedy">
                        ü§ù
                        <span class="map-icon-badge hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="allianceChat" title="Alliance Chat" style="display: none;">
                        üí¨
                        <span class="map-icon-badge map-badge-red hidden"></span>
                    </div>
                    <div class="map-icon-item" data-action="contactList" title="View contact list">
                        üë§
                    </div>
                    <div class="map-icon-item hidden" data-action="stockManager" title="Stock Manager">
                        üìà
                    </div>
                    <div class="map-icon-item" data-action="analytics" title="Business Analytics">
                        üìâ
                    </div>
                </div>
            </div>

            <!-- Vessel Detail Panel (slides in from right) -->
            <div id="vessel-detail-panel" class="detail-panel vessel-panel">
                <!-- Vessel info populated by vessel-panel.js -->
            </div>

            <!-- Port Detail Panel (slides in from right) -->
            <div id="port-detail-panel" class="detail-panel port-panel">
                <!-- Port info populated by port-panel.js -->
            </div>

            <!-- Route Vessels Panel (slides in from right) -->
            <div id="route-vessels-panel" class="detail-panel route-panel">
                <!-- Route vessels list populated by route-vessels-panel.js -->
            </div>

            <!-- Harbor Map Filter Modal (draggable, transparent) -->
            <div id="harborFilterModal" class="harbor-filter-modal hidden">
                <div class="harbor-filter-header">
                    <h3>Filter</h3>
                    <button class="close-btn harbor-filter-close" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
                </div>
                <div class="harbor-filter-content">
                    <!-- Route Filter -->
                    <div class="harbor-filter-section">
                        <span class="harbor-filter-section-label">Route</span>
                        <select id="harborFilterRoute">
                            <option value="">All Routes</option>
                        </select>
                    </div>

                    <!-- Vessel Filter -->
                    <div class="harbor-filter-section">
                        <span class="harbor-filter-section-label">Vessel</span>
                        <select id="harborFilterVessel">
                            <option value="">All Vessels</option>
                            <option value="container">Container Ships</option>
                            <option value="tanker">Tankers</option>
                            <option value="enroute">En Route</option>
                            <option value="port">At Port</option>
                            <option value="anchor">At Anchor</option>
                            <option value="maintenance">In Drydock</option>
                            <option value="pending">Pending Delivery</option>
                            <option value="moored">Moored</option>
                        </select>
                    </div>

                    <div class="harbor-filter-divider"></div>

                    <!-- Port Filters (4 types in 2x2 grid) -->
                    <div class="harbor-filter-section">
                        <span class="harbor-filter-section-label">Port Filters</span>
                        <div class="harbor-filter-demand-group">
                            <!-- Row 1: My Ports -->
                            <div class="harbor-filter-demand-row">
                                <div class="harbor-filter-demand-item">
                                    <label>Max (My Ports)</label>
                                    <select id="harborFilterDemandMaxMy">
                                        <option value="">No Filter</option>
                                    </select>
                                </div>
                                <div class="harbor-filter-demand-item">
                                    <label>Current (My Ports)</label>
                                    <select id="harborFilterDemandCurrentMy">
                                        <option value="">No Filter</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Row 2: All Ports -->
                            <div class="harbor-filter-demand-row">
                                <div class="harbor-filter-demand-item">
                                    <label>Max (All Ports)</label>
                                    <select id="harborFilterDemandMaxAll">
                                        <option value="">No Filter</option>
                                    </select>
                                </div>
                                <div class="harbor-filter-demand-item">
                                    <label>Current (All Ports)</label>
                                    <select id="harborFilterDemandCurrentAll">
                                        <option value="">No Filter</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="harbor-filter-footer">
                    <button class="harbor-filter-clear-btn">Clear All</button>
                </div>
            </div>

            <!-- Depart Manager Panel (draggable, transparent) -->
            <div id="departManagerPanel" class="depart-manager-panel hidden">
                <div class="depart-manager-header">
                    <h3>üö¢ Depart Manager</h3>
                    <button class="close-btn depart-manager-close"><span>√ó</span></button>
                </div>
                <div class="depart-manager-search">
                    <input type="text" id="departManagerSearchInput" placeholder="Search vessel..." autocomplete="off">
                    <button id="departManagerSearchClear" class="close-btn" title="Clear search"><span>√ó</span></button>
                </div>
                <div class="depart-manager-tabs">
                    <button class="depart-tab-btn active" data-status="port" title="Vessels at port ready to depart">At Port</button>
                    <button class="depart-tab-btn" data-status="enroute" title="Vessels currently sailing">At Sea</button>
                    <button class="depart-tab-btn" data-status="pending" title="Vessels pending delivery">Pending</button>
                    <button class="depart-tab-btn" data-status="maintenance" title="Vessels in drydock">DryDock</button>
                    <button class="depart-tab-btn" data-status="anchor" title="Vessels at anchor">Anchored</button>
                    <button class="depart-tab-btn" data-status="mass-moor" title="Moor/resume vessels">Moor</button>
                </div>
                <div class="depart-manager-actions">
                    <div class="depart-manager-actions-row">
                        <button id="departAllFromPanel" class="vessel-filter-btn depart-primary-btn" title="Depart selected vessels">üö¢ Depart (0)</button>
                        <button id="moorAllBtn" class="vessel-filter-btn" title="Moor selected vessels">‚õìÔ∏è Moor (0)</button>
                        <button id="resumeAllBtn" class="vessel-filter-btn" title="Resume selected vessels">üü¢ Resume (0)</button>
                    </div>
                    <div class="depart-manager-actions-row">
                        <button id="selectAllVesselsBtn" class="vessel-filter-btn" title="Select all vessels">‚úì All</button>
                        <button id="unselectAllVesselsBtn" class="vessel-filter-btn" title="Unselect all vessels">‚úó None</button>
                        <button id="refreshDepartListBtn" class="vessel-filter-btn" title="Refresh vessel list">üîÑ</button>
                    </div>
                </div>
                <div class="depart-manager-content">
                    <!-- Future: Vessel list, filters, etc. -->
                </div>
            </div>

            <!-- Route Planner Panel (draggable) -->
            <div id="routePlannerPanel" class="route-planner-panel hidden">
                <div class="route-planner-header">
                    <h3>Routes for <span class="route-planner-vessel-name">Vessel</span></h3>
                    <button class="close-btn route-planner-close"><span>√ó</span></button>
                </div>
                <div class="route-planner-tabs">
                    <button class="route-planner-tab-btn vessel-filter-btn active" data-tab="ports">Ports</button>
                    <button class="route-planner-tab-btn vessel-filter-btn" data-tab="route">Route</button>
                </div>
                <div class="route-planner-content">
                    <!-- Ports Tab -->
                    <div class="route-planner-tab-content active" data-tab="ports">
                        <div class="route-planner-port-filters">
                            <button class="route-planner-filter-btn vessel-filter-btn" data-filter="local">Local Ports</button>
                            <button class="route-planner-filter-btn vessel-filter-btn" data-filter="suggested">Suggested Route</button>
                            <button class="route-planner-filter-btn vessel-filter-btn" data-filter="metropol">Metropol Routes</button>
                            <button class="route-planner-filter-btn vessel-filter-btn" data-filter="all">All Reachable</button>
                        </div>
                        <div class="route-planner-selected-info hidden">
                            <button id="routePlannerClearRoute" class="close-btn route-planner-clear-btn" title="Clear route selection"><span>√ó</span></button>
                            <div class="route-planner-port-name">Select a port</div>
                            <div class="route-planner-section-header">Vessel Capacity</div>
                            <div class="route-planner-info-row">
                                <span class="route-planner-info-label">Capacity:</span>
                                <span class="route-planner-info-value" data-info="vessel-capacity">-</span>
                            </div>
                            <div class="route-planner-section-header">Remaining Demand</div>
                            <table class="route-planner-demand-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th data-demand-header="origin">Origin</th>
                                        <th data-demand-header="destination">Destination</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="demand-label">Dry</td>
                                        <td class="demand-value" data-demand="origin-dry">-</td>
                                        <td class="demand-value" data-demand="dry">-</td>
                                    </tr>
                                    <tr>
                                        <td class="demand-label">Ref</td>
                                        <td class="demand-value" data-demand="origin-ref">-</td>
                                        <td class="demand-value" data-demand="refrigerated">-</td>
                                    </tr>
                                    <tr>
                                        <td class="demand-label">Fuel</td>
                                        <td class="demand-value" data-demand="origin-fuel">-</td>
                                        <td class="demand-value" data-demand="fuel">-</td>
                                    </tr>
                                    <tr>
                                        <td class="demand-label">Crude</td>
                                        <td class="demand-value" data-demand="origin-crude">-</td>
                                        <td class="demand-value" data-demand="crude_oil">-</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="route-planner-current-route-grid ports-tab-grid">
                                <div class="route-grid-item">
                                    <span class="route-grid-label">Distance</span>
                                    <span class="route-grid-value" data-info="distance">-</span>
                                </div>
                                <div class="route-grid-item">
                                    <span class="route-grid-label">Time</span>
                                    <span class="route-grid-value" data-info="travel-time">-</span>
                                </div>
                                <div class="route-grid-item">
                                    <span class="route-grid-label">Fuel</span>
                                    <span class="route-grid-value" data-info="fuel-consumption">-</span>
                                </div>
                                <div class="route-grid-item">
                                    <span class="route-grid-label">Channel</span>
                                    <span class="route-grid-value" data-info="channel-fee">$0</span>
                                </div>
                            </div>
                            <hr class="route-planner-divider">
                            <div class="route-planner-info-row">
                                <span class="route-planner-info-label">Harbor Fee/TEU:</span>
                                <span class="route-planner-info-value" data-info="harbor-fee">-</span>
                            </div>
                            <div class="route-planner-speed-selector">
                                <span class="route-planner-info-label">Speed:</span>
                                <input type="range" id="routePlannerPortsSpeedSlider" class="route-planner-mini-slider" min="1" max="30" value="6">
                                <span id="routePlannerPortsSpeedValue" class="route-planner-speed-value">6 kn</span>
                            </div>
                            <div class="route-planner-guards-selector hidden">
                                <span class="route-planner-info-label">Guards:</span>
                                <input type="range" id="routePlannerPortsGuardsSlider" class="route-planner-mini-slider" min="0" max="10" value="0">
                                <span id="routePlannerPortsGuardsValue" class="route-planner-speed-value">0</span>
                            </div>
                            <div class="route-planner-guards-cost-row hidden">
                                <span class="route-planner-info-label">Guards Cost:</span>
                                <span id="routePlannerPortsGuardsCost" class="route-planner-info-value creation-fee">$0</span>
                            </div>
                            <div class="route-planner-piracy-warning hidden">
                                <div class="route-planner-piracy-header">PIRACY WARNING</div>
                                <div class="route-planner-piracy-zone">Zone: Unknown</div>
                                <div class="route-planner-piracy-risk">Risk: 0%</div>
                            </div>
                            <div class="route-planner-info-row">
                                <span class="route-planner-info-label">Creation Fee:</span>
                                <span class="route-planner-info-value creation-fee" data-info="creation-fee">$0</span>
                            </div>
                        </div>
                        <button id="routePlannerCreateBtn" class="route-planner-save-btn" disabled>Create Route</button>
                    </div>
                    <!-- Route Tab -->
                    <div class="route-planner-tab-content" data-tab="route">
                        <div class="route-planner-no-route">
                            <div class="route-planner-no-route-icon">-</div>
                            <div class="route-planner-no-route-text">No active route assigned to this vessel</div>
                        </div>
                        <div class="route-planner-route-settings hidden">
                            <div class="route-planner-slider-group">
                                <div class="route-planner-slider-label">
                                    <span class="route-planner-slider-name">Speed</span>
                                    <span id="routePlannerSpeedValue" class="route-planner-slider-value">6 kn</span>
                                </div>
                                <input type="range" id="routePlannerSpeedSlider" class="route-planner-slider" min="1" max="20" value="6">
                            </div>
                            <div class="route-planner-slider-group">
                                <div class="route-planner-slider-label">
                                    <span class="route-planner-slider-name">Guards</span>
                                    <span id="routePlannerGuardsValue" class="route-planner-slider-value">0</span>
                                </div>
                                <input type="range" id="routePlannerGuardsSlider" class="route-planner-slider" min="0" max="10" value="0">
                            </div>
                            <div class="route-planner-cost-info">
                                <div class="route-planner-cost-row">
                                    <span class="route-planner-cost-label">Guard Cost:</span>
                                    <span id="routePlannerGuardsCost" class="route-planner-cost-value">$0</span>
                                </div>
                            </div>
                            <div class="route-planner-actions">
                                <button id="routePlannerCancelBtn" class="route-planner-cancel-btn">Cancel</button>
                                <button id="routePlannerSaveBtn" class="route-planner-save-btn">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End chat-area-wrapper -->
    </div>

    <!-- Alliance Chat Overlay -->
    <div id="allianceChatOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2>üí¨ Alliance Chat</h2>
                <button id="closeChatBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="chat-feed" id="chatFeed">
                <div class="empty-message">Loading chat...</div>
            </div>
            <div class="input-section">
                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        placeholder="Type... or use @ for mentions or Shift+Enter for new line"
                        maxlength="1000"
                        autocomplete="off"
                    ></textarea>
                    <div class="send-btn-container">
                        <button id="sendMessageBtn">Send</button>
                        <div class="char-count" id="charCount">0 / 1000</div>
                    </div>
                </div>
                <div id="feedback"></div>
            </div>
        </div>
    </div>

    <div id="allChatsOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>üì¨ All Private Conversations</h2>
                <button id="closeAllChatsBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="allChatsList">
            </div>
        </div>
    </div>

    <div id="contactListOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>üë• Contact List</h2>
                <button id="closeContactListBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="contactListFeed">
            </div>
        </div>
    </div>

    <div id="logbookOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2>üìã Captain's Logbook</h2>
                <span id="logbookCount" class="logbook-count"></span>
                <button id="logbookCloseBtn" class="close-btn btn-auto-left" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="logbook-filters">
                <div class="logbook-filter-row">
                    <div class="logbook-filter-group">
                        <select id="logbookFilterStatus" class="logbook-filter-select">
                            <option value="ALL">All</option>
                            <option value="SUCCESS">Success</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Error</option>
                        </select>
                    </div>
                    <div class="logbook-filter-group">
                        <select id="logbookFilterTransaction" class="logbook-filter-select">
                            <option value="ALL">All Transactions</option>
                            <option value="INCOME">Income Only</option>
                            <option value="EXPENSE">Expenses Only</option>
                        </select>
                    </div>
                    <div class="logbook-filter-group">
                        <select id="logbookFilterTime" class="logbook-filter-select">
                            <option value="all">All Time</option>
                            <option value="1h">Last 1 Hour</option>
                            <option value="2h">Last 2 Hours</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="12h">Last 12 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="7days">Last 7 Days</option>
                            <option value="lastweek">Last Week</option>
                            <option value="30days">Last 30 Days</option>
                            <option value="lastmonth">Last Month</option>
                        </select>
                    </div>
                    <div class="logbook-filter-group">
                        <select id="logbookFilterAction" class="logbook-filter-select">
                            <option value="ALL">All Actions</option>
                            <option disabled>‚îÄ‚îÄ‚îÄ Categories ‚îÄ‚îÄ‚îÄ</option>
                            <option value="CATEGORY:BUNKER">üì¶ Bunker</option>
                            <option value="CATEGORY:VESSEL">üö¢ Vessel</option>
                            <option value="CATEGORY:AUTOPILOT">ü§ñ Autopilot</option>
                            <option value="CATEGORY:ANCHOR">‚öì Anchor</option>
                            <option value="CATEGORY:SETTINGS">‚öôÔ∏è Settings</option>
                            <option disabled>‚îÄ‚îÄ‚îÄ Sources ‚îÄ‚îÄ‚îÄ</option>
                            <option value="SOURCE:MANUAL">‚úã Manual</option>
                            <option value="SOURCE:AUTOPILOT">ü§ñ Autopilot</option>
                            <option disabled id="logbookActionsSeparator" style="display:none">‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ</option>
                        </select>
                    </div>
                </div>
                <div class="logbook-filter-row">
                    <input type="text" id="logbookFilterSearch" class="logbook-filter-search" placeholder="Search...">
                    <div class="logbook-filter-group logbook-export-group">
                        <div class="logbook-export-dropdown">
                            <button id="logbookExportBtn" class="logbook-icon-btn" title="Export logs">üíæ</button>
                            <div id="logbookExportMenu" class="logbook-export-menu hidden">
                                <button id="logbookExportTxt" class="logbook-export-menu-item">üìÑ TXT</button>
                                <button id="logbookExportCsv" class="logbook-export-menu-item">üìä CSV</button>
                                <button id="logbookExportJson" class="logbook-export-menu-item">üóÇÔ∏è JSON</button>
                            </div>
                        </div>
                        <button id="deleteLogbookBtn" class="logbook-icon-btn logbook-delete-btn" title="Delete all logs">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
            <div class="logbook-table-container">
                <table class="logbook-table">
                    <thead>
                        <tr>
                            <th class="logbook-th-status">Status</th>
                            <th class="logbook-th-timestamp">Time</th>
                            <th class="logbook-th-autopilot">Autopilot</th>
                            <th class="logbook-th-summary">Summary</th>
                        </tr>
                    </thead>
                    <tbody id="logbookTableBody">
                        <tr>
                            <td colspan="4" class="logbook-empty">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="chatSelectionOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2 id="chatSelectionTitle">Select Conversation</h2>
                <button id="backToAllChatsBtn" class="close-btn btn-auto-left" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>üîô</span></button>
                <button id="closeChatSelectionBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="chatSelectionList">
            </div>
        </div>
    </div>

    <div id="messengerOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2 id="messengerTitle">Private Chat with ...</h2>
                <button id="deleteChatBtn" class="close-btn btn-auto-left btn-delete" onmouseover="this.querySelector('span').style.animation='shake-trash-simple 0.5s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>üóëÔ∏è</span></button>
                <button id="backToSelectionBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>üîô</span></button>
                <button id="closeMessengerBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="messengerFeed">
            </div>
            <div class="messenger-input">
                <div id="subjectInputWrapper" class="hidden">
                    <input
                        type="text"
                        id="subjectInput"
                        placeholder="Subject..."
                        maxlength="100"
                    />
                </div>
                <div class="messenger-input-row">
                    <textarea
                        id="messengerInput"
                        placeholder="Type message..."
                        maxlength="1000"
                        autocomplete="off"
                    ></textarea>
                    <div class="send-btn-container">
                        <button id="sendPrivateMessageBtn" class="send-btn">Send</button>
                        <div class="char-count" id="messengerCharCount">0 / 1000</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="companyProfileOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2 id="companyProfileTitle">My Company</h2>
                <button id="companyProfileCloseBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="company-profile-search">
                <input type="text" id="companyProfileSearchInput" placeholder="Search player..." maxlength="50" />
                <button id="companyProfileSearchBtn">Search</button>
            </div>
            <div id="companyProfileContent" class="company-profile-content">
            </div>
        </div>
    </div>

    <div id="stockManagerOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-wide">
            <div class="messenger-header">
                <h2>üìà Stock Manager</h2>
                <button id="closeStockManagerBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="stock-manager-tabs">
                <button class="stock-tab-btn active" data-tab="portfolio">My Portfolio</button>
                <button class="stock-tab-btn" data-tab="market">Market</button>
                <button class="stock-tab-btn" data-tab="investments">Investments</button>
                <button class="stock-tab-btn" data-tab="investors">Investors</button>
                <button class="stock-tab-btn" data-tab="ipo-alerts">IPO Alert</button>
            </div>
            <div id="stockManagerContent" class="stock-manager-content">
                <!-- Content will be populated by stock-manager.js -->
            </div>
        </div>
    </div>

    <div id="stockCompanyDetailOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-medium">
            <div class="messenger-header">
                <span id="stockCompanyBackBtn" class="stock-back-emoji" onmouseover="this.style.animation='wobble 0.5s ease-in-out'" onmouseout="this.style.animation='none'">üîô</span>
                <h2 id="stockCompanyTitle">Company Details</h2>
                <button id="closeStockCompanyBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div id="stockCompanyContent" class="stock-company-content">
                <!-- Content will be populated by stock-manager.js -->
            </div>
        </div>
    </div>

    <div id="analyticsOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-wide">
            <div class="messenger-header">
                <h2>Business Analytics</h2>
                <button id="analyticsCloseBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <!-- Full modal overlay for building index - covers everything below header -->
            <div id="analyticsIndexBuilding" class="analytics-index-building hidden">
                <div class="analytics-index-building-content">
                    <div class="analytics-index-building-spinner"></div>
                    <h3>Building Transaction Index</h3>
                    <p>Please wait while the transaction data is being indexed...</p>
                    <p class="analytics-index-building-status" id="analyticsIndexStatus">This may take a few minutes on first run.</p>
                </div>
            </div>
            <div class="analytics-tabs">
                <button class="analytics-tab-btn active" data-tab="overview">Overview</button>
                <button class="analytics-tab-btn" data-tab="game-log">Game Log</button>
                <button class="analytics-tab-btn" data-tab="vessels">Vessels</button>
                <button class="analytics-tab-btn" data-tab="routes">Routes</button>
                <div class="analytics-controls">
                    <select id="analyticsPeriodSelect" class="logbook-filter-select">
                        <option value="1">24h</option>
                        <option value="7" selected>7 Days</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">6 Months</option>
                        <option value="365">1 Year</option>
                        <option value="0">All Time</option>
                    </select>
                    <button id="analyticsRefreshBtn" class="analytics-emoji-btn" title="Refresh">&#x21BB;</button>
                    <div class="logbook-export-dropdown">
                        <button id="analyticsExportBtn" class="analytics-emoji-btn" title="Export">&#x1F4BE;</button>
                        <div id="analyticsExportMenu" class="logbook-export-menu hidden">
                            <button id="analyticsExportTxt" class="logbook-export-menu-item">TXT</button>
                            <button id="analyticsExportCsv" class="logbook-export-menu-item">CSV</button>
                            <button id="analyticsExportJson" class="logbook-export-menu-item">JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="analyticsLoading" class="analytics-loading hidden">
                Loading analytics data...
            </div>
            <div id="analyticsContent" class="analytics-content hidden">
                <!-- Game Log Tab (Unified Lookup from all PODs) -->
                <div id="analytics-game-log" class="analytics-tab-content hidden">
                    <div class="analytics-section">
                        <div class="log-storage-box">
                            <h2 class="log-storage-title">Log Storage Data</h2>
                            <div class="log-storage-stats">
                                <span class="log-storage-item">
                                    <span class="log-storage-label">Entries:</span>
                                    <span class="log-storage-value" id="game-log-total">-</span>
                                </span>
                                <span class="log-storage-item">
                                    <span class="log-storage-label">Span:</span>
                                    <span class="log-storage-value" id="game-log-span">-</span>
                                </span>
                                <span class="log-storage-item">
                                    <span class="log-storage-label">Last Build:</span>
                                    <span class="log-storage-value" id="game-log-sync">-</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-section">
                        <div class="analytics-chart-container" id="game-log-chart-container"></div>
                    </div>
                    <div class="analytics-section">
                        <h2 class="analytics-section-title">Daily Breakdown</h2>
                        <div class="analytics-table-container">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="num">Income</th>
                                        <th class="num">Expenses</th>
                                        <th class="num">Net</th>
                                        <th class="num">Count</th>
                                    </tr>
                                </thead>
                                <tbody id="game-log-daily-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="analytics-section">
                        <h2 class="analytics-section-title">Breakdown by Type</h2>
                        <div class="game-log-filter">
                            <label>Category: </label>
                            <select id="game-log-category-filter">
                                <option value="">All</option>
                                <option value="INCOME">Income</option>
                                <option value="EXPENSE">Expense</option>
                            </select>
                            <label>Type: </label>
                            <select id="game-log-type-filter">
                                <option value="">All</option>
                            </select>
                        </div>
                        <div class="analytics-table-container">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th class="num">Count</th>
                                        <th class="num">Total</th>
                                        <th class="num">%</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody id="game-log-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="analytics-section">
                        <h2 class="analytics-section-title">Transactions</h2>
                        <div class="game-log-raw-header">
                            <span class="game-log-info-item">
                                <span id="game-log-raw-count">0</span> / <span id="game-log-raw-total">0</span> loaded
                            </span>
                        </div>
                        <div class="analytics-table-container game-log-raw-container">
                            <table class="analytics-table" id="game-log-raw-table">
                                <thead>
                                    <tr>
                                        <th data-sort="time">Date</th>
                                        <th data-sort="type">Type</th>
                                        <th class="num" data-sort="cash">Amount</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody id="game-log-raw-tbody"></tbody>
                            </table>
                        </div>
                        <div class="game-log-load-more">
                            <button id="game-log-load-more-btn" class="vessel-filter-btn hidden">Load More</button>
                        </div>
                    </div>
                </div>
                <!-- Overview Tab -->
                <div id="analytics-overview" class="analytics-tab-content">
                    <!-- Trend Chart at top -->
                    <div class="analytics-chart-container" id="analytics-chart-container">
                        <div class="analytics-chart-legend">
                            <span class="analytics-chart-legend-item">
                                <span class="analytics-chart-legend-dot revenue"></span>
                                Revenue
                            </span>
                            <span class="analytics-chart-legend-item">
                                <span class="analytics-chart-legend-dot profit"></span>
                                Profit
                            </span>
                        </div>
                    </div>
                    <!-- Key Metrics Section -->
                    <div class="analytics-metrics-header">
                        <span>Summary filtered by </span><span id="analytics-filter-name">Last 7 Days</span>
                    </div>
                    <div class="analytics-key-metrics">
                        <div class="analytics-metric">
                            <div class="analytics-metric-label">Revenue</div>
                            <div class="analytics-metric-value positive" id="analytics-revenue">-</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-metric-label">Expenses</div>
                            <div class="analytics-metric-value negative" id="analytics-expenses">-</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-metric-label">Profit</div>
                            <div class="analytics-metric-value" id="analytics-profit">-</div>
                        </div>
                        <div class="analytics-metric">
                            <div class="analytics-metric-label">Margin</div>
                            <div class="analytics-metric-value" id="analytics-margin">-</div>
                        </div>
                    </div>
                    <!-- Top/Bottom Vessels Charts -->
                    <div class="analytics-section">
                        <div class="analytics-chart-container" id="vessels-revenue-chart-container"></div>
                    </div>
                    <div class="analytics-section">
                        <div class="analytics-chart-container" id="vessels-bottom-revenue-chart-container"></div>
                    </div>
                </div>
                <!-- Vessels Tab -->
                <div id="analytics-vessels" class="analytics-tab-content hidden">
                    <div id="analytics-vessels-loading" class="analytics-loading">Loading vessel data...</div>
                    <div id="analytics-vessels-content" class="hidden">
                    <div class="analytics-section">
                        <div class="analytics-chart-container" id="vessels-composition-chart-container"></div>
                    </div>
                    <div class="analytics-section">
                        <div class="analytics-chart-container" id="vessels-utilization-chart-container"></div>
                    </div>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Vessel <span class="vessel-filter-icons"><span class="vessel-filter-icon" id="vessel-filter-owned" data-filter="owned" title="Show owned vessels">&#x1F7E2;</span><span class="vessel-filter-icon" id="vessel-filter-sold" data-filter="sold" title="Show sold vessels">&#x1F578;&#xFE0F;</span></span></th>
                                    <th class="num">Trips</th>
                                    <th class="num">Revenue</th>
                                    <th class="num">Avg/Trip</th>
                                    <th class="num">Contrib</th>
                                    <th class="num">Avg/h</th>
                                    <th class="num">Avg/nm</th>
                                    <th class="num">Utilization</th>
                                    <th>Primary Route</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-vessels-tbody"></tbody>
                        </table>
                    </div>
                    </div>
                </div>
                <!-- Routes Tab -->
                <div id="analytics-routes" class="analytics-tab-content hidden">
                    <div id="analytics-routes-loading" class="analytics-loading">Loading route data...</div>
                    <div id="analytics-routes-content" class="hidden">
                    <!-- Top 10 Routes Highlight -->
                    <div class="analytics-top-routes">
                        <div class="top-routes-section">
                            <h4>Top 10 by $/Hour</h4>
                            <div id="top-routes-by-hour" class="top-routes-list"></div>
                        </div>
                        <div class="top-routes-section">
                            <h4>Top 10 by $/NM</h4>
                            <div id="top-routes-by-nm" class="top-routes-list"></div>
                        </div>
                    </div>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Route <span class="route-filter-icons"><span class="route-filter-icon" id="route-filter-active" data-filter="active" title="Show active routes">&#x1F7E2;</span><span class="route-filter-icon" id="route-filter-inactive" data-filter="inactive" title="Show inactive routes">&#x1F578;&#xFE0F;</span></span></th>
                                    <th class="num">Vessels <span class="info-icon" id="route-vessels-info">&#x1F4A1;</span></th>
                                    <th class="num">Trips</th>
                                    <th class="num">Revenue</th>
                                    <th class="num">Avg/Trip</th>
                                    <th class="num">Avg/h</th>
                                    <th class="num">$/nm</th>
                                    <th class="num">Hijack %</th>
                                    <th class="num">Harbor Fee %</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-routes-tbody"></tbody>
                        </table>
                    </div>
                    </div>
                </div>
                <!-- API Stats Tab (develMode only) -->
                <div id="analytics-api-stats" class="analytics-tab-content hidden">
                    <div class="analytics-section">
                        <div class="api-stats-header">
                            <h3>API Call Statistics</h3>
                            <div class="api-stats-controls">
                                <select id="apiStatsHoursSelect" class="logbook-filter-select">
                                    <option value="0.016">1m</option>
                                    <option value="0.083">5m</option>
                                    <option value="0.25">15m</option>
                                    <option value="0.5">30m</option>
                                    <option value="1">1h</option>
                                    <option value="6">6h</option>
                                    <option value="24" selected>24h</option>
                                    <option value="72">3 Days</option>
                                    <option value="168">7 Days</option>
                                </select>
                                <button id="apiStatsRefreshBtn" class="analytics-emoji-btn" title="Refresh">&#x21BB;</button>
                            </div>
                        </div>
                        <div id="apiStatsLoading" class="analytics-loading">Loading API stats...</div>
                        <div id="apiStatsContent" class="hidden">
                            <div class="api-stats-summary">
                                <div class="analytics-metric">
                                    <div class="analytics-metric-label">Total Calls</div>
                                    <div class="analytics-metric-value" id="apiStatsTotalCalls">-</div>
                                </div>
                                <div class="analytics-metric">
                                    <div class="analytics-metric-label">Errors</div>
                                    <div class="analytics-metric-value negative" id="apiStatsTotalErrors">-</div>
                                </div>
                                <div class="analytics-metric">
                                    <div class="analytics-metric-label">Calls/Hour</div>
                                    <div class="analytics-metric-value" id="apiStatsCallsPerHour">-</div>
                                </div>
                                <div class="analytics-metric">
                                    <div class="analytics-metric-label">Available Days</div>
                                    <div class="analytics-metric-value" id="apiStatsAvailableDays">-</div>
                                </div>
                            </div>
                            <div class="api-stats-chart-container" id="apiStatsChartContainer"></div>
                            <div class="analytics-table-wrapper">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>Endpoint</th>
                                            <th class="num">Calls</th>
                                            <th class="num">Errors</th>
                                            <th class="num">Avg Duration</th>
                                            <th class="num">% of Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="apiStatsEndpointsTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hijackingOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>&#x2620;&#xFE0F; Blackbeard's Phone Booth</h2>
                <button id="closeHijackingBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="hijackingFeed">
            </div>
        </div>
    </div>

    <div id="forecastOverlay" class="overlay hidden">
        <div class="forecast-window">
            <div class="messenger-header">
                <h2>üìÖ Forecast Calendar</h2>
                <div id="forecastEventBadge" class="hidden">
                    <span id="forecastEventText"></span>
                </div>
                <button id="closeForecastBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div id="calendarBook">
                <!-- Calendar content will be generated by forecast-calendar.js -->
            </div>
        </div>
    </div>

    <div id="eventOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>üéâ Event Information</h2>
                <button id="closeEventBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="eventInfoContent" style="padding: 20px;">
                <!-- Event info will be populated by event-info.js -->
            </div>
        </div>
    </div>

    <div id="anchorPurchaseOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>‚öì Purchase Anchor Points</h2>
                <button id="closeAnchorPurchaseBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div id="anchorPurchaseFeed" style="padding: 20px; position: relative;">
                <!-- Content will be generated by anchor-purchase.js -->
            </div>
        </div>
    </div>

    <div id="sellVesselsOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-sell-vessels">
            <div class="messenger-header">
                <h2>‚õ¥Ô∏è Sell Vessels</h2>
                <button id="closeSellVesselsBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="vessel-header-controls">
                <button id="sellFilterContainerBtn" class="vessel-filter-btn active" data-type="container">
                    üì¶ Container
                </button>
                <button id="sellFilterTankerBtn" class="vessel-filter-btn hidden" data-type="tanker">
                    üõ¢Ô∏è Tanker
                </button>
                <button id="sellCartBtn" class="vessel-filter-btn hidden">
                    üõí Cart (<span id="sellCartCount"></span>)
                </button>
            </div>
            <div class="messenger-feed" id="sellVesselCatalogFeed">
                <!-- Vessel list will be generated by vessel-selling.js -->
            </div>
        </div>
    </div>

    <div id="campaignsOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-narrow">
            <div class="messenger-header">
                <h2>üìä Marketing Campaigns</h2>
                <button id="closeCampaignsBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed messenger-feed-compact">
                <div id="campaignsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div id="coopOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2>ü§ù Cargo Comedy</h2>
                <button id="closeCoopBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed alliance-coop-feed">
                <div class="alliance-coop-container">
                    <!-- Tab Navigation -->
                    <div class="tab-buttons alliance-coop-tabs">
                        <button class="tab-button tab-active" data-tab="allianz">Allianz</button>
                        <button class="tab-button" data-tab="coop">Coop<span id="coopTabBadge" class="tab-badge" style="display: none;"></span></button>
                        <button class="tab-button" data-tab="liga">Liga</button>
                        <button class="tab-button" data-tab="highscore">HighScore</button>
                        <button class="tab-button" data-tab="search">Search<span id="searchTabBadge" class="tab-badge" style="display: none;"></span></button>
                        <button class="tab-button" data-tab="management">Management</button>
                        <button class="tab-button" data-tab="settings">Settings</button>
                        <div class="alliance-pool-buttons">
                            <button id="anyAlliancePoolBtn" class="vessel-filter-btn pool-join-btn" style="display: none;">Apply for Any Alliance</button>
                        </div>
                    </div>

                    <!-- Tab Contents -->
                    <div id="allianzTabContent" class="tab-content tab-active">
                        <div id="allianzContent" class="alliance-tab-content">
                            <!-- Alliance info will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="coopTabContent" class="tab-content">
                        <div id="coopContent" class="alliance-tab-content">
                            <!-- Coop content will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="ligaTabContent" class="tab-content">
                        <div id="ligaContent" class="alliance-tab-content">
                            <!-- Liga content will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="highscoreTabContent" class="tab-content">
                        <div id="highscoreContent" class="alliance-tab-content">
                            <!-- High Score content will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="searchTabContent" class="tab-content">
                        <div id="searchContent" class="alliance-tab-content">
                            <!-- Search content will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="managementTabContent" class="tab-content">
                        <div id="managementContent" class="alliance-tab-content">
                            <!-- Management content will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="settingsTabContent" class="tab-content">
                        <div id="allianceSettingsContent" class="alliance-tab-content">
                            <!-- Alliance Settings content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button id="closeSettingsBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" style="padding: 10px; overflow-y: auto;">
                <div style="width: 100%; margin: 0 auto;">
                    <!-- Information Section -->
                    <div class="settings-section">
                        <h3 onclick="toggleSection('informationContent')" class="settings-section-header">
                            <span>üíù Designed with love and AI</span>
                            <span id="informationToggle" class="settings-section-toggle">‚ûñ</span>
                        </h3>
                        <div class="settings-section-divider"></div>
                        <div id="informationContent" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <div class="info-section">
                                <p class="info-text">
                                    üì¶ Current Version <span id="currentVersion" class="info-version">Loading...</span>
                                </p>
                                <p class="info-text">
                                    ShippingManager <a href="https://github.com/sitzmoebelchronograph/shippingmanager_copilot" target="_blank" class="info-link">CoPilot on Github</a> / <a href="https://shippingmanager-forecast.pages.dev/" target="_blank" class="info-link">Public Forecast</a>
                                </p>
                                <p class="info-text">
                                    <a href="https://discord.gg/rw4yKxp7Mv" target="_blank" class="info-link">üí¨ Join the developer Discord</a>
                                </p>
                            </div>

                            <div id="updateStatusContainer" class="update-available hidden">
                                <div class="update-title">
                                    üéâ New Version Available!
                                </div>
                                <div class="update-version-text">
                                    Version <span id="latestVersion" class="info-version"></span> is available
                                </div>
                                <a id="downloadLink" href="#" target="_blank" class="update-download-btn">
                                    ‚¨áÔ∏è Download Update
                                </a>
                            </div>

                            <div id="upToDateContainer" class="up-to-date hidden">
                                <div class="up-to-date-text">
                                    ‚úÖ You're running the latest version
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Alerts Section -->
                    <div style="margin-bottom: 10px; padding: 20px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h3 onclick="toggleSection('priceAlertsContent')" style="margin: 0 0 10px 0; font-size: 16px; color: #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                            <span>üì¢ Price Alerts</span>
                            <span id="priceAlertsToggle" style="font-size: 14px; color: #9ca3af; font-weight: normal;">‚ûï</span>
                        </h3>
                        <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 10px 0 15px 0;"></div>
                        <div id="priceAlertsContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <p style="margin: 0 0 5px 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                Get browser notifications when prices drop below these thresholds
                            </p>

                            <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label for="fuelThreshold" style="margin: 0; color: #e0e0e0; font-size: 14px;">
                                    ‚õΩ Fuel Alert Threshold ($/ton)
                                </label>
                                <input
                                    type="number"
                                    id="fuelThreshold"
                                    value="400"
                                    min="1"
                                   
                                    style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px;"
                                />
                            </div>

                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label for="co2Threshold" style="margin: 0; color: #e0e0e0; font-size: 14px;">
                                    üí® CO2 Alert Threshold ($/ton)
                                </label>
                                <input
                                    type="number"
                                    id="co2Threshold"
                                    value="7"
                                    min="1"
                                   
                                    style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px;"
                                />
                            </div>
                        </div>

                        <button id="testAlertBtn" style="
                            margin-top: 5px;
                            width: 100%;
                            padding: 10px;
                            background: rgba(59, 130, 246, 0.2);
                            border: 1px solid rgba(59, 130, 246, 0.4);
                            border-radius: 6px;
                            color: #60a5fa;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 14px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'">
                            Test notification
                        </button>
                        </div>
                    </div>

                    <!-- IPO Alerts Section (only visible if user has IPO=1) -->
                    <div id="ipoAlertsSection" class="settings-section hidden">
                        <h3 onclick="toggleSection('ipoAlertsContent')" class="settings-section-header">
                            <span>&#x1F4C8; IPO Alerts</span>
                            <span id="ipoAlertsToggle" class="settings-section-toggle">+</span>
                        </h3>
                        <div class="settings-section-divider"></div>
                        <div id="ipoAlertsContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <p class="settings-section-description">
                                Get notified when new players complete their IPO. Fresh accounts have higher potential returns.
                            </p>
                            <div class="settings-section-options">
                                <div class="settings-option-box">
                                    <label class="settings-checkbox-label">
                                        <input type="checkbox" id="enableIpoAlerts" class="settings-checkbox">
                                        <span class="settings-checkbox-text">Enable IPO Alerts</span>
                                    </label>
                                    <div id="ipoAlertOptions" class="settings-suboptions hidden">
                                        <label class="settings-select-label">
                                            <span>Max account age:</span>
                                            <select id="ipoAlertMaxAge" class="settings-select">
                                                <option value="1">One Day</option>
                                                <option value="7" selected>One Week</option>
                                                <option value="30">One Month</option>
                                                <option value="180">6 Months</option>
                                            </select>
                                        </label>
                                    </div>
                                </div>
                                <div id="ipoAlertAllianceChatOption" class="settings-option-box hidden">
                                    <label class="settings-checkbox-label">
                                        <input type="checkbox" id="ipoAlertSendToAllianceChat" class="settings-checkbox">
                                        <span class="settings-checkbox-text">Send IPO Alerts to Alliance Chat</span>
                                    </label>
                                    <p class="settings-checkbox-hint">Post new IPO alerts to your alliance chat so other members can see them too</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Settings Section -->
                    <div style="margin-bottom: 10px; padding: 20px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h3 onclick="toggleSection('generalSettingsContent')" style="margin: 0 0 10px 0; font-size: 16px; color: #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                            <span>‚öôÔ∏è General Settings</span>
                            <span id="generalSettingsToggle" style="font-size: 14px; color: #9ca3af; font-weight: normal;">‚ûï</span>
                        </h3>
                        <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 10px 0 15px 0;"></div>
                        <div id="generalSettingsContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <div style="padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableDesktopNotifications" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;" checked>
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üîî Enable Desktop Notifications</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px;">Show browser notifications for alerts and AutoPilot actions (requires browser permission)</p>
                            </div>
                            <div style="padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableInboxNotifications" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üì¨ Enable Inbox Notifications</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px;">Show notifications for new private messages</p>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label for="maintenanceThreshold" style="margin: 0; color: #e0e0e0; font-size: 14px;">üîß Wear Threshold</label>
                                <select id="maintenanceThreshold" style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                    <option value="2">2%</option>
                                    <option value="3">3%</option>
                                    <option value="4">4%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label for="autoDrydockThreshold" style="margin: 0; color: #e0e0e0; font-size: 14px;">üõ†Ô∏è Drydock Threshold</label>
                                <select id="autoDrydockThreshold" style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                    <option value="25">25h</option>
                                    <option value="50">50h</option>
                                    <option value="75">75h</option>
                                    <option value="100">100h</option>
                                    <option value="150">150h</option>
                                    <option value="999">&gt;150h</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <label for="minCargoUtilization" style="margin: 0; color: #e0e0e0; font-size: 14px;">üì¶ Min Port Demand</label>
                                    <select id="minCargoUtilization" style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                        <option value="">Not set</option>
                                        <option value="10">10%</option>
                                        <option value="20">20%</option>
                                        <option value="30">30%</option>
                                        <option value="40">40%</option>
                                        <option value="50">50%</option>
                                        <option value="60">60%</option>
                                        <option value="70">70%</option>
                                        <option value="75">75%</option>
                                        <option value="80">80%</option>
                                        <option value="85">85%</option>
                                        <option value="90">90%</option>
                                        <option value="95">95%</option>
                                    </select>
                                </div>
                                <div style="margin: 4px 0 0 28px; color: #9ca3af; font-size: 11px; line-height: 1.4;">
                                    Only depart if destination has enough demand to theoretically fill vessel to this %
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <label for="harborFeeWarningThreshold" style="margin: 0; color: #e0e0e0; font-size: 14px;">‚öì Harbor Fee Warning</label>
                                    <select id="harborFeeWarningThreshold" style="width: 100px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                        <option value="">Not set</option>
                                        <option value="10">10%</option>
                                        <option value="20">20%</option>
                                        <option value="30">30%</option>
                                        <option value="40">40%</option>
                                        <option value="50">50%</option>
                                        <option value="60">60%</option>
                                        <option value="70">70%</option>
                                        <option value="80">80%</option>
                                        <option value="90">90%</option>
                                        <option value="99">&gt;99%</option>
                                    </select>
                                </div>
                                <div style="margin: 4px 0 0 28px; color: #9ca3af; font-size: 11px; line-height: 1.4;">
                                    Warns when harbor fee exceeds this % of gross income. Highlights in vessel history, sends notification, logs in logbook.
                                </div>
                            </div>

                            <!-- Weather Data Toggle -->
                            <div style="padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableWeatherData" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üå§Ô∏è Enable Weather Data</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px;">Enable weather information on map (double-click). When disabled, no external weather API calls are made. Weather data is fetched from Open-Meteo and location names from OpenStreetMap.</p>
                                <p style="margin: 4px 0 0 28px; color: #fbbf24; font-size: 12px; font-weight: 500;">‚ö†Ô∏è Page reload required for changes to take effect</p>
                            </div>
                        </div>
                    </div>

                    <!-- Auto-Pilot Settings Section -->
                    <div style="margin-bottom: 10px; padding: 20px; background: rgba(16, 185, 129, 0.05); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px;">
                        <h3 onclick="toggleSection('autopilotContent')" style="margin: 0 0 10px 0; font-size: 18px; color: #10b981; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                            <span>ü§ñ Auto-Pilot - Settings</span>
                            <span id="autopilotToggle" style="font-size: 16px; color: #9ca3af; font-weight: normal;">‚ûï</span>
                        </h3>
                        <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 10px 0 15px 0;"></div>
                        <div id="autopilotContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <p style="margin: 0 0 5px 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                Enable automated game management. When ANY function is active, page title changes to <strong>"AutoPilot"</strong> mode.
                            </p>

                            <!-- General Autopilot Settings -->
                        <div style="margin-bottom: 16px; padding: 16px; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #60a5fa; font-weight: 600;">‚öôÔ∏è General Settings</h4>

                            <!-- AutoPilot Notifications Toggle -->
                            <div style="padding: 12px; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoPilotNotifications" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;" checked>
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üîî AutoPilot Notifications</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px;">Master toggle for ALL autopilot notifications (in-app alerts + desktop notifications). When disabled, all autopilot notifications are suppressed regardless of individual agent settings.</p>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <!-- Auto-rebuy Fuel -->
                            <div style="padding: 16px; background: rgba(251, 191, 36, 0.05); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoRebuyFuel" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">‚õΩ Autopilot - Barrel Boss</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically purchase fuel when price drops at/below threshold.
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #fbbf24; font-size: 11px; line-height: 1.4;">
                                    üí° Checks every minute. Purchases when price is at/below threshold.
                                </p>

                                <!-- Min Cash Reserve (always visible when feature enabled) -->
                                <div id="autoRebuyFuelMinCashSection" class="autopilot-options autopilot-options-fuel hidden">
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoRebuyFuelMinCash" class="autopilot-mincash-input" min="0" step="10000">
                                        <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 11px;">Don't buy if cash would drop below this amount</p>
                                    </div>
                                </div>

                                <!-- Nested: Use Alert Value -->
                                <div id="autoRebuyFuelOptions" class="autopilot-options autopilot-options-fuel hidden">
                                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                        <input type="checkbox" id="autoRebuyFuelUseAlert" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                                        <span style="color: #d1d5db; font-size: 13px;">Use alert threshold</span>
                                    </label>
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Max price ($/ton):</label>
                                        <input type="text" id="autoRebuyFuelThreshold" min="1" value="400" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyBarrelBossInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyBarrelBossDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>

                                    <!-- Emergency Buy Override -->
                                    <div class="emergency-override-section">
                                        <label class="emergency-override-label emergency-override-label-fuel">
                                            <input type="checkbox" id="autoRebuyFuelEmergency">
                                            <span>üö® Emergency Buy Override</span>
                                        </label>
                                        <p class="emergency-override-hint">Buy fuel regardless of price when bunker is low and ships are waiting</p>
                                        <div id="autoRebuyFuelEmergencyOptions" class="hidden">
                                            <div class="emergency-override-table">
                                                <div class="emergency-table-header">
                                                    <span>Bunker below (t)</span>
                                                    <span>Min ships at port</span>
                                                    <span>Max price ($)</span>
                                                </div>
                                                <div class="emergency-table-row">
                                                    <input type="number" id="autoRebuyFuelEmergencyBelow" min="1" value="500">
                                                    <input type="number" id="autoRebuyFuelEmergencyShips" min="1" value="5">
                                                    <input type="number" id="autoRebuyFuelEmergencyMaxPrice" min="1" value="600">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-rebuy CO2 -->
                            <div style="padding: 16px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoRebuyCO2" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üí® Autopilot - Atmosphere Broker</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically purchase CO2 when price drops at/below threshold.
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #22c55e; font-size: 11px; line-height: 1.4;">
                                    üí° Checks every minute. Purchases when price is at/below threshold.
                                </p>

                                <!-- Min Cash Reserve (always visible when feature enabled) -->
                                <div id="autoRebuyCO2MinCashSection" class="autopilot-options autopilot-options-co2 hidden">
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoRebuyCO2MinCash" class="autopilot-mincash-input" min="0" step="10000">
                                        <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 11px;">Don't buy if cash would drop below this amount</p>
                                    </div>
                                </div>

                                <!-- Nested: Use Alert Value -->
                                <div id="autoRebuyCO2Options" class="autopilot-options autopilot-options-co2 hidden">
                                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                        <input type="checkbox" id="autoRebuyCO2UseAlert" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                                        <span style="color: #d1d5db; font-size: 13px;">Use alert threshold</span>
                                    </label>
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Max price ($/ton):</label>
                                        <input type="text" id="autoRebuyCO2Threshold" min="1" value="7" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyAtmosphereBrokerInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyAtmosphereBrokerDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>

                                    <!-- Emergency Buy Override -->
                                    <div class="emergency-override-section">
                                        <label class="emergency-override-label emergency-override-label-co2">
                                            <input type="checkbox" id="autoRebuyCO2Emergency">
                                            <span>üö® Emergency Buy Override</span>
                                        </label>
                                        <p class="emergency-override-hint">Buy CO2 regardless of price when bunker is low and ships are waiting</p>
                                        <div id="autoRebuyCO2EmergencyOptions" class="hidden">
                                            <div class="emergency-override-table">
                                                <div class="emergency-table-header">
                                                    <span>Bunker below (t)</span>
                                                    <span>Min ships at port</span>
                                                    <span>Max price ($)</span>
                                                </div>
                                                <div class="emergency-table-row">
                                                    <input type="number" id="autoRebuyCO2EmergencyBelow" min="1" value="500">
                                                    <input type="number" id="autoRebuyCO2EmergencyShips" min="1" value="5">
                                                    <input type="number" id="autoRebuyCO2EmergencyMaxPrice" min="1" value="12">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-Depart All -->
                            <div style="padding: 16px; background: rgba(96, 165, 250, 0.05); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoDepartAll" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üö¢ Autopilot - Cargo Marshal</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Intelligently departs vessels based on port demand and fuel prices.
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #60a5fa; font-size: 11px; line-height: 1.4;">
                                    üí° Checks every minute. Departs vessels when ready and profitable.
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #fbbf24; font-size: 11px; line-height: 1.4;">
                                    ‚ö†Ô∏è Requires minimum 10t fuel in bunker - no vessels will be sent if fuel is below this threshold.
                                </p>

                                <!-- Nested: Intelligent Auto-Depart Settings -->
                                <div id="autoDepartOptions" class="autopilot-options autopilot-options-blue hidden">
                                    <!-- Min Fuel Threshold -->
                                    <div style="margin-bottom: 10px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">‚õΩ Min Fuel for Auto-Depart (t):</label>
                                        <input type="text" id="minFuelThreshold" min="0" value="100" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                                    </div>

                                    <!-- Min Utilization Reference - Points to General Settings -->
                                    <div style="margin-bottom: 8px; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">üì¶ Min Cargo Utilization:</div>
                                        <div style="color: #60a5fa; font-size: 13px; font-weight: 500;">
                                            ‚Üí Configured in <span style="text-decoration: underline;">General Settings</span>
                                        </div>
                                        <div style="color: #9ca3af; font-size: 11px; margin-top: 4px; font-style: italic;">
                                            (Applies to both manual and autopilot departures)
                                        </div>
                                    </div>

                                    <!-- Use Route Default Checkbox -->
                                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                        <input type="checkbox" id="autoDepartUseRouteDefaults" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                        <span style="color: #d1d5db; font-size: 13px;">Use route defaults for vessel speed</span>
                                    </label>

                                    <!-- Vessel Speed (hidden when using route defaults) -->
                                    <div id="autoDepartCustomSettings" class="hidden">
                                        <div>
                                            <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">‚ö° Vessel Speed (10-100%):</label>
                                            <input
                                                type="number"
                                                id="autoVesselSpeed"
                                                min="10"

                                                value="50"
                                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;"
                                            >
                                        </div>
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyCargoMarshalInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyCargoMarshalDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto Anchor Points -->
                            <div style="padding: 16px; background: rgba(125, 211, 252, 0.05); border: 1px solid rgba(125, 211, 252, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoAnchorPointEnabled" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">‚öì Autopilot - Harbormaster</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically purchase anchor points when available capacity drops below threshold. Checks every 5 minutes.
                                </p>

                                <div id="autoAnchorPointOptions" class="autopilot-options autopilot-options-light-blue hidden">
                                    <div class="radio-group-inline">
                                        <label class="radio-group-label">‚öì Purchase Amount:</label>
                                        <label class="radio-option">
                                            <input type="radio" name="autoAnchorAmount" value="1" id="autoAnchorAmount1" checked>
                                            <span>Buy 1</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="autoAnchorAmount" value="10" id="autoAnchorAmount10">
                                            <span>Buy 10</span>
                                        </label>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoAnchorPointMinCash" class="autopilot-mincash-input" min="0" step="10000">
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyHarbormasterInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyHarbormasterDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto Bulk Repair -->
                            <div style="padding: 16px; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoBulkRepair" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üîß Autopilot - Yard Foreman</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically repair all vessels when wear threshold is reached. Event-driven (checks every 60 seconds).
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #6b7280; font-size: 11px; font-style: italic;">
                                    Uses the wear threshold configured in the Maintenance section below
                                </p>

                                <!-- Nested: Repair Options -->
                                <div id="autoBulkRepairOptions" class="autopilot-options autopilot-options-blue">
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoBulkRepairMinCash" class="autopilot-mincash-input" min="0" step="10000">
                                        <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 11px;">Don't repair if cash would drop below this amount</p>
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyYardForemanInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyYardForemanDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto Drydock -->
                            <div style="padding: 16px; background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoDrydock" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üõ†Ô∏è Autopilot - Drydock Master</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically send vessels to drydock when hours_until_check reaches threshold. Event-driven (checks every 60 seconds).
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #6b7280; font-size: 11px; font-style: italic;">
                                    Uses the drydock threshold configured in General Settings
                                </p>

                                <!-- Nested: Drydock Options -->
                                <div id="autoDrydockOptions" class="autopilot-options autopilot-options-orange">
                                    <div style="margin-bottom: 12px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üö¢ Maintenance Type:</label>
                                        <select id="autoDrydockType" style="width: 100%; padding: 8px 12px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                            <option value="major">Major (100% Antifouling)</option>
                                            <option value="minor">Minor (60% Antifouling)</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">‚ö° Route Speed:</label>
                                        <select id="autoDrydockSpeed" style="width: 100%; padding: 8px 12px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer;">
                                            <option value="minimum">Minimum (Slow, Less Fuel)</option>
                                            <option value="maximum">Maximum (Fast, More Fuel)</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoDrydockMinCash" class="autopilot-mincash-input" min="0" step="10000">
                                        <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 11px;">Don't send to drydock if cash would drop below this amount</p>
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyDrydockMasterInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyDrydockMasterDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto Campaign Renewal -->
                            <div style="padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoCampaignRenewal" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üìä Autopilot - Reputation Chief</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    When active campaigns drop below 3, immediately purchase the most expensive one that current funds allow. Event-driven (checks every 60 seconds).
                                </p>

                                <div id="autoCampaignRenewalOptions" class="autopilot-options autopilot-options-blue">
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üí∞ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoCampaignRenewalMinCash" class="autopilot-mincash-input" min="0" step="10000">
                                        <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 11px;">Don't buy if cash would drop below this amount</p>
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyReputationChiefInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyReputationChiefDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto COOP -->
                            <div style="padding: 16px; background: rgba(236, 72, 153, 0.05); border: 1px solid rgba(236, 72, 153, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoCoopEnabled" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">ü§ù Autopilot - Fair Hand</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically contribute to alliance COOP when targets are available. Event-driven (checks every 60 seconds).
                                </p>

                                <div id="autoCoopOptions" class="autopilot-options autopilot-options-blue hidden">
                                    <p style="margin: 0 0 8px 0; color: #9ca3af; font-size: 12px;">COOP notifications settings</p>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyFairHandInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyFairHandDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto Negotiate Hijacking -->
                            <div style="padding: 16px; background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoNegotiateHijacking" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">‚ò†Ô∏è Autopilot - Cap'n Blackbeard</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically negotiate and accept hijacking ransoms with payment verification. Event-driven (checks every 60 seconds).
                                </p>

                                <div id="autoNegotiateOptions" class="autopilot-options autopilot-options-blue hidden">
                                    <p style="margin: 0 0 8px 0; color: #9ca3af; font-size: 12px;">Cap'n Blackbeard notifications settings</p>
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyCaptainBlackbeardInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyCaptainBlackbeardDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- The Purser (Auto Stock Trading) - only visible if user has IPO -->
                            <div id="autoPurserSection" class="hidden" style="padding: 16px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="autoPurserEnabled" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üí∞ Autopilot - The Purser</span>
                                </label>
                                <p style="margin: 8px 0 0 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                    Automatically buy stocks from fresh IPOs matching your alert threshold.
                                </p>
                                <p style="margin: 4px 0 0 28px; color: #22c55e; font-size: 11px;">
                                    üí° Uses your "Enable IPO Alerts" threshold setting from Stock tab
                                </p>

                                <div id="autoPurserOptions" class="autopilot-options autopilot-options-green hidden">
                                    <!-- Min Cash Reserve -->
                                    <div style="margin-bottom: 8px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üíµ Min Cash Reserve ($):</label>
                                        <input type="text" id="autoPurserMinCash" class="autopilot-mincash-input" style="width: 120px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                                    </div>

                                    <!-- Max Stock Price -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">üìà Max Stock Price ($/share):</label>
                                        <input type="text" id="autoPurserMaxPrice" class="autopilot-mincash-input" style="width: 120px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                                    </div>

                                    <!-- Auto-Sell Section -->
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                                            <input type="checkbox" id="autoPurserAutoSellEnabled" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                                            <span style="color: #d1d5db; font-size: 13px;">üìâ Enable Auto-Sell (sell purchased stocks when falling)</span>
                                        </label>

                                        <div id="autoPurserAutoSellOptions" class="hidden" style="margin-left: 24px;">
                                            <!-- Falling Days -->
                                            <div style="margin-bottom: 8px;">
                                                <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Sell after falling for:</label>
                                                <select id="autoPurserFallingDays" style="width: 120px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                                                    <option value="1">1 day</option>
                                                    <option value="3">3 days</option>
                                                    <option value="7">7 days</option>
                                                    <option value="14">14 days</option>
                                                    <option value="30">1 month</option>
                                                </select>
                                            </div>

                                            <!-- Drop Percent -->
                                            <div style="margin-bottom: 8px;">
                                                <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Or if price drops by:</label>
                                                <select id="autoPurserDropPercent" style="width: 120px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                                                    <option value="10">10%</option>
                                                    <option value="20">20%</option>
                                                    <option value="30">30%</option>
                                                    <option value="40">40%</option>
                                                    <option value="50">50%</option>
                                                    <option value="60">60%</option>
                                                    <option value="70">70%</option>
                                                    <option value="80">80%</option>
                                                    <option value="90">90%</option>
                                                    <option value="100">100%</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Notifications -->
                                    <div style="padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05); margin-top: 12px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 6px;">
                                            <input type="checkbox" id="notifyThePurserInApp" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üì± Enable in-app alerts</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="notifyThePurserDesktop" class="autopilot-agent-checkbox" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;" checked>
                                            <span style="color: #d1d5db; font-size: 13px;">üîî Enable desktop notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Chat Bot Settings Section -->
                    <div style="margin-bottom: 10px; padding: 20px; background: rgba(139, 92, 246, 0.05); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                        <h3 onclick="toggleSection('chatbotContent')" style="margin: 0 0 10px 0; font-size: 18px; color: #a78bfa; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                            <span>üí¨ Chat Bot Settings</span>
                            <span id="chatbotToggle" style="font-size: 16px; color: #9ca3af; font-weight: normal;">‚ûï</span>
                        </h3>
                        <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 10px 0 15px 0;"></div>
                        <div id="chatbotContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <p style="margin: 0 0 5px 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                Configure automated chat responses and commands in alliance chat
                            </p>

                            <!-- Box 1: General Settings -->
                            <div style="padding: 16px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; color: #a78bfa; font-size: 14px; font-weight: 600;">General Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <!-- Enable Chat Bot -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="enableChatBot" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">‚ú® Enable Chat Bot</span>
                                        </label>
                                    </div>

                                    <!-- Command Prefix -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label for="commandPrefix" style="margin: 0; color: #e0e0e0; font-size: 14px;">üí¨ Command Prefix</label>
                                        <input type="text" id="commandPrefix" value="!" maxlength="3" style="width: 80px; padding: 6px 10px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px; text-align: center;">
                                    </div>

                                    <!-- Alliance Commands -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="enableAllianceCommands" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üè¢ Alliance Commands</span>
                                        </label>
                                        <p style="margin: 6px 0 0 28px; color: #9ca3af; font-size: 12px;">Respond to commands in alliance chat</p>
                                    </div>

                                    <!-- DM Commands -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="enableDMCommands" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üì® DM Commands</span>
                                        </label>
                                        <p style="margin: 6px 0 0 28px; color: #9ca3af; font-size: 12px;">Respond to commands in private messages</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Box 2: Help Command Settings -->
                            <div style="padding: 16px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; color: #a78bfa; font-size: 14px; font-weight: 600;">Help Command Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <!-- Help Command -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                                            <input type="checkbox" id="cmdHelp" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">‚ùì Help Command</span>
                                        </label>
                                        <div style="margin-left: 28px; display: flex; flex-direction: column; gap: 5px;">
                                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #d1d5db;">
                                                <input type="checkbox" id="cmdHelpAlliance" style="width: 16px; height: 16px; margin-right: 6px; cursor: pointer;" checked>
                                                Allow in alliance chat
                                            </label>
                                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #d1d5db;">
                                                <input type="checkbox" id="cmdHelpDM" style="width: 16px; height: 16px; margin-right: 6px; cursor: pointer;" checked>
                                                Allow in DMs
                                            </label>
                                            <div>
                                                <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Aliases (comma-separated):</label>
                                                <input type="text" id="cmdHelpAliases" placeholder="help, h, commands" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Box 3: Forecast Command Settings -->
                            <div style="padding: 16px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; color: #a78bfa; font-size: 14px; font-weight: 600;">Forecast Command Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <!-- Daily Forecast Toggle -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="enableDailyForecast" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üìÖ Daily Forecast (auto-post)</span>
                                        </label>
                                    </div>

                                    <!-- Daily Forecast Time -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label for="dailyForecastTime" style="margin: 0; color: #e0e0e0; font-size: 14px;">‚è∞ Forecast Time (HH:MM):</label>
                                        <input type="time" id="dailyForecastTime" value="18:00" style="width: 120px; padding: 6px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px;">
                                    </div>

                                    <!-- Forecast Command -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                                            <input type="checkbox" id="cmdForecast" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üìä Forecast Command</span>
                                        </label>
                                        <div style="margin-left: 28px; display: flex; flex-direction: column; gap: 5px;">
                                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #d1d5db;">
                                                <input type="checkbox" id="cmdForecastAlliance" style="width: 16px; height: 16px; margin-right: 6px; cursor: pointer;" checked>
                                                Allow in alliance chat
                                            </label>
                                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #d1d5db;">
                                                <input type="checkbox" id="cmdForecastDM" style="width: 16px; height: 16px; margin-right: 6px; cursor: pointer;" checked>
                                                Allow in DMs
                                            </label>
                                            <div>
                                                <label style="color: #9ca3af; font-size: 12px; display: block; margin-bottom: 4px;">Aliases (comma-separated):</label>
                                                <input type="text" id="cmdForecastAliases" placeholder="prices, price" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #e0e0e0; font-size: 13px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Box 4: Welcome Command Settings -->
                            <div id="welcomeCommandSettingsBox" style="padding: 16px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; display: none;">
                                <h4 style="margin: 0 0 12px 0; color: #a78bfa; font-size: 14px; font-weight: 600;">Welcome Command Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <!-- Welcome Command Toggle -->
                                    <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                                            <input type="checkbox" id="cmdWelcome" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                            <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">üëã Welcome Command</span>
                                        </label>
                                        <p style="margin: 0 0 8px 28px; color: #9ca3af; font-size: 12px; line-height: 1.4;">
                                            Usage: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; color: #fbbf24;">!welcome @Username</code><br>
                                            Sends your configured welcome message to a specific user via DM.<br>
                                            Type <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">@Username</code> in alliance chat, which converts to <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">[UserID]</code>.<br>
                                            <strong style="color: #fbbf24;">Admin Only:</strong> CEO, COO, Management, Interim CEO<br>
                                            Configure the message in Alliance &gt; Management tab.
                                        </p>
                                    </div>

                                </div>
                            </div>

                            <!-- Box 5: Custom Commands -->
                            <div style="padding: 16px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; color: #a78bfa; font-size: 14px; font-weight: 600;">Custom Commands</h4>
                                <div style="padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <span style="color: #e0e0e0; font-size: 14px; font-weight: 500;">Custom Commands</span>
                                        <button id="addCustomCommand" style="padding: 4px 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 4px; color: #a78bfa; cursor: pointer; font-size: 12px; font-weight: 600;">+ Add</button>
                                    </div>
                                    <div id="customCommandsList" style="display: flex; flex-direction: column; gap: 5px;">
                                        <!-- Custom commands will be added here dynamically -->
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Certificate Section -->
                    <div style="margin-bottom: 10px; padding: 20px; background: rgba(31, 41, 55, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h3 onclick="toggleSection('certificateContent')" style="margin: 0 0 10px 0; font-size: 16px; color: #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                            <span>üîí Certificate Installation</span>
                            <span id="certificateToggle" style="font-size: 14px; color: #9ca3af; font-weight: normal;">‚ûï</span>
                        </h3>
                        <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 10px 0 15px 0;"></div>
                        <div id="certificateContent" class="hidden" style="display: flex; flex-direction: column; gap: 5px;" data-display-mode="flex">
                            <p style="margin: 0 0 5px 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                Install the CA certificate to remove security warnings and enable notifications on mobile devices
                            </p>

                            <div style="background: rgba(31, 41, 55, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #e0e0e0; font-size: 14px;">üíª Desktop (Windows/Mac/Linux):</strong>
                                <p style="margin: 5px 0 0 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                    Install the certificate to remove "Not Secure" warnings in your browser
                                </p>
                            </div>
                            <div>
                                <strong style="color: #e0e0e0; font-size: 14px;">üì± Mobile (Android/iOS):</strong>
                                <p style="margin: 5px 0 0 0; color: #9ca3af; font-size: 13px; line-height: 1.4;">
                                    Required for browser notifications to work. Install via Settings ‚Üí Security ‚Üí Install Certificate
                                </p>
                            </div>
                        </div>

                        <a href="/ca-cert.pem" download="ShippingManager-CA.pem" style="
                            display: block;
                            width: 100%;
                            padding: 12px;
                            background: rgba(59, 130, 246, 0.2);
                            border: 1px solid rgba(59, 130, 246, 0.4);
                            border-radius: 6px;
                            color: #60a5fa;
                            text-align: center;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 14px;
                            text-decoration: none;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'">
                            Download CA Certificate
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="buyVesselsOverlay" class="overlay hidden">
        <div class="messenger-window messenger-window-sell-vessels">
            <div class="messenger-header">
                <h2 id="buyVesselsHeader">‚õ¥Ô∏è Buy Vessels</h2>
                <button id="closeBuyVesselsBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>

            <div class="vessel-header-controls">
                <div class="filter-dropdown-container">
                    <button id="filterDropdownBtn" class="vessel-filter-btn">
                        üîç Filters
                    </button>
                    <div id="filterDropdownMenu" class="filter-dropdown-menu hidden">
                        <div id="resetFiltersBtn" class="filter-section hidden" style="cursor: pointer; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px;" onclick="resetVesselFilters()">
                            <div style="color: #fca5a5; font-weight: 500; text-align: center;">üîÑ Reset All Filters</div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Vessel Type</div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <label class="filter-option">
                                    <input type="checkbox" name="vesselType" value="container" checked>
                                    <span>üì¶ Container</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="vesselType" value="tanker">
                                    <span>üõ¢Ô∏è Tanker</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Price Range ($)</div>
                            <div class="filter-range-row">
                                <select id="priceMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="priceMax" class="filter-range-select">
                                    <option value="Infinity">max</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Engine Type</div>
                            <div class="filter-range-row">
                                <select id="engineType" class="filter-range-select-full">
                                    <option value="all" selected>All Engines</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Max Speed (kn)</div>
                            <div class="filter-range-row">
                                <select id="speedMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="speedMax" class="filter-range-select">
                                    <option value="999">999</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Service Hours (h)</div>
                            <div class="filter-range-row">
                                <select id="serviceMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="serviceMax" class="filter-range-select">
                                    <option value="Infinity">max</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Fuel Factor</div>
                            <div class="filter-range-row">
                                <select id="fuelFactorMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="fuelFactorMax" class="filter-range-select">
                                    <option value="999">999</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">CO2 Factor</div>
                            <div class="filter-range-row">
                                <select id="co2FactorMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="co2FactorMax" class="filter-range-select">
                                    <option value="999">999</option>
                                </select>
                            </div>
                        </div>

                        <div id="capacityTEUSection" class="filter-section">
                            <div class="filter-section-title">Capacity (TEU)</div>
                            <div class="filter-range-row">
                                <select id="capacityMinTEU" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="capacityMaxTEU" class="filter-range-select">
                                    <option value="999999">999999</option>
                                </select>
                            </div>
                        </div>

                        <div id="capacityBBLSection" class="filter-section">
                            <div class="filter-section-title">Capacity (bbl)</div>
                            <div class="filter-range-row">
                                <select id="capacityMinBBL" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="capacityMaxBBL" class="filter-range-select">
                                    <option value="999999">999999</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Year Built</div>
                            <div class="filter-range-row">
                                <select id="yearMin" class="filter-range-select">
                                    <option value="0">0</option>
                                </select>
                                <span class="filter-range-separator">‚Äî</span>
                                <select id="yearMax" class="filter-range-select">
                                    <option value="9999">9999</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-section-title">Special</div>
                            <label class="filter-option">
                                <input type="checkbox" name="special" value="credits">
                                <span>üí≤ Credits Only</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" name="special" value="perks">
                                <span>‚ú® Has perks only</span>
                            </label>
                        </div>

                    </div>
                </div>
                <button id="buildShipBtn" class="vessel-filter-btn">
                    üî® Build Ship
                </button>
                <button id="sortPriceBtn" class="vessel-filter-btn" data-sort="asc">
                    üí∞ Price ‚Üë
                </button>
                <button id="filterPendingBtn" class="vessel-filter-btn hidden">
                    ‚è±Ô∏è Pending (<span id="pendingCount"></span>)
                </button>
                <button id="cartBtn" class="vessel-filter-btn hidden">
                    üõí Cart (<span id="cartCount"></span>)
                </button>
                <button id="bulkBuyBtn" class="bulk-buy-btn hidden">
                    üí∞ Bulk Buy (<span id="selectedCount"></span>)
                </button>
            </div>

            <div class="messenger-feed" id="vesselCatalogFeed">
                <div class="vessel-feed-loading">
                    Loading vessels...
                </div>
            </div>
        </div>
    </div>

    <div id="buildShipOverlay" class="overlay hidden">
        <div class="build-ship-window">
            <div class="messenger-header">
                <h2>üî® Build Vessel</h2>
                <button id="closeBuildShipBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>

            <div class="build-ship-body">
                <div class="build-ship-left">
                    <div class="build-steps-indicator">
                        <div class="build-step-dot active" data-step="1">
                            <span class="build-step-number">1</span>
                            <span class="build-step-label">Basics</span>
                        </div>
                        <div class="build-step-dot" data-step="2">
                            <span class="build-step-number">2</span>
                            <span class="build-step-label">Engine</span>
                        </div>
                        <div class="build-step-dot" data-step="3">
                            <span class="build-step-number">3</span>
                            <span class="build-step-label">Perks</span>
                        </div>
                        <div class="build-step-dot" data-step="4">
                            <span class="build-step-number">4</span>
                            <span class="build-step-label">Appearance</span>
                        </div>
                    </div>

                    <div id="buildStepContent" class="build-step-content">
                    </div>

                    <div class="build-ship-footer">
                        <button id="buildPrevBtn" class="build-nav-btn build-prev-btn hidden">‚Üê Previous</button>
                        <button id="buildNextBtn" class="build-nav-btn build-next-btn">Next ‚Üí</button>
                        <button id="buildSubmitBtn" class="build-nav-btn build-submit-btn hidden">üî® Build Vessel</button>
                    </div>
                </div>

                <div class="build-ship-right">
                    <div id="buildStatsPreview" class="build-stats-preview">
                        <h3 class="build-stats-title">Vessel Preview</h3>
                        <div class="build-stats-content">
                            <div class="build-stat-row">
                                <span class="build-stat-label">Type:</span>
                                <span id="previewType" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Capacity:</span>
                                <span id="previewCapacity" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Port:</span>
                                <span id="previewPort" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Engine:</span>
                                <span id="previewEngine" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Range:</span>
                                <span id="previewRange" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Speed:</span>
                                <span id="previewSpeed" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Fuel:</span>
                                <span id="previewFuel" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">CO2:</span>
                                <span id="previewCO2" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Perks:</span>
                                <span id="previewPerks" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row">
                                <span class="build-stat-label">Build Time:</span>
                                <span id="previewBuildTime" class="build-stat-value">-</span>
                            </div>
                            <div class="build-stat-row build-stat-price">
                                <span class="build-stat-label">Total Price:</span>
                                <span id="previewPrice" class="build-stat-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="engineFilterOverlay" class="overlay hidden">
        <div class="messenger-window">
            <div class="messenger-header">
                <h2>‚öôÔ∏è Filter by Engine Type</h2>
                <button id="closeEngineFilterBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="messenger-feed" id="engineFilterList" style="padding: 20px; overflow-y: auto;">
                <!-- Engine list will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div id="vesselAppearanceOverlay" class="overlay hidden">
        <div class="messenger-window vessel-appearance-window">
            <div class="messenger-header">
                <h2>Edit Vessel Appearance</h2>
                <button id="closeVesselAppearanceBtn" class="close-btn" onmouseover="this.querySelector('span').style.animation='pulse-arrow 0.6s ease-in-out infinite'" onmouseout="this.querySelector('span').style.animation='none'"><span>√ó</span></button>
            </div>
            <div class="vessel-appearance-body">
                <input type="hidden" id="appearanceVesselId">
                <input type="hidden" id="appearanceOriginalName">

                <div class="appearance-name-row" id="appearanceNameSection">
                    <label>Name</label>
                    <input type="text" id="appearanceVesselName" maxlength="30">
                </div>

                <div class="appearance-section" id="appearanceImageSection">
                    <div class="appearance-image-area">
                        <div class="appearance-image-preview" id="appearanceImagePreview">
                            <span class="appearance-upload-icon">+</span>
                            <span class="appearance-upload-text">Click to upload</span>
                        </div>
                        <input type="file" id="appearanceImageInput" accept="image/*" hidden>
                        <button type="button" id="removeCustomImageBtn" class="vessel-filter-btn hidden">Remove Image</button>
                    </div>
                    <div class="appearance-colors-area" id="appearanceColorsSection">
                        <div class="appearance-colors-grid">
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceHullColor" value="#b30000">
                                <label for="appearanceHullColor">Hull</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceDeckColor" value="#272525">
                                <label for="appearanceDeckColor">Deck</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceBridgeColor" value="#dbdbdb">
                                <label for="appearanceBridgeColor">Bridge</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceNameColor" value="#ffffff">
                                <label for="appearanceNameColor">Name</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceContainer1" value="#ff8000">
                                <label for="appearanceContainer1">C1</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceContainer2" value="#0000ff">
                                <label for="appearanceContainer2">C2</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceContainer3" value="#670000">
                                <label for="appearanceContainer3">C3</label>
                            </div>
                            <div class="appearance-color-item">
                                <input type="color" id="appearanceContainer4" value="#777777">
                                <label for="appearanceContainer4">C4</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="appearance-actions">
                    <button id="saveAppearanceBtn" class="vessel-filter-btn">Save</button>
                    <button id="cancelAppearanceBtn" class="vessel-filter-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Lost Overlay -->
    <div id="connectionLostOverlay" class="connection-overlay hidden">
        <div class="connection-message">
            <h2>Connection Lost</h2>
            <p>Cannot connect to backend server</p>
            <p>Please check if the application is running in the system tray</p>
            <div class="connection-spinner"></div>
            <p class="connection-retry">Attempting to reconnect...</p>
        </div>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="/css/leaflet.css" />
    <link rel="stylesheet" href="/css/MarkerCluster.css" />
    <link rel="stylesheet" href="/css/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="/css/leaflet-environmental.css" />

    <!-- Leaflet JS -->
    <script src="/js/vendor/leaflet.js"></script>
    <script src="/js/vendor/leaflet-environmental.js"></script>
    <script src="/js/vendor/leaflet.markercluster.js"></script>

    <!-- TradingView Lightweight Charts -->
    <script src="/js/vendor/lightweight-charts.standalone.production.js"></script>

    <script type="module" src="/js/script.js"></script>
</body>
</html>